{% extends "crm/base.html" %}
{% load static %}

{% block title %}Scraper-Steuerung - TELIS CRM{% endblock %}

{% block breadcrumbs %}
<span class="text-gray-500">/</span>
<span class="text-gray-300">Scraper</span>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-100">ü§ñ Scraper-Steuerung</h1>
            <p class="text-gray-400 mt-1">Lead-Scraper starten, stoppen und √ºberwachen</p>
        </div>
    </div>

    <!-- Status Card -->
    <div class="bg-dark-800 rounded-lg border border-dark-700 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-gray-100">Status</h2>
            <div id="status-indicator" class="flex items-center space-x-2">
                <div class="w-3 h-3 rounded-full bg-gray-500" id="status-dot"></div>
                <span class="text-gray-300" id="status-text">Gestoppt</span>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-dark-900 rounded-lg p-4">
                <div class="text-gray-400 text-sm">Prozess-ID</div>
                <div class="text-2xl font-bold text-gray-100 mt-1" id="stat-pid">-</div>
            </div>
            <div class="bg-dark-900 rounded-lg p-4">
                <div class="text-gray-400 text-sm">Laufzeit</div>
                <div class="text-2xl font-bold text-gray-100 mt-1" id="stat-uptime">-</div>
            </div>
            <div class="bg-dark-900 rounded-lg p-4">
                <div class="text-gray-400 text-sm">Leads gefunden</div>
                <div class="text-2xl font-bold text-primary mt-1" id="stat-leads">0</div>
            </div>
            <div class="bg-dark-900 rounded-lg p-4">
                <div class="text-gray-400 text-sm">CPU / RAM</div>
                <div class="text-2xl font-bold text-gray-100 mt-1" id="stat-resources">-</div>
            </div>
        </div>
        
        <!-- Circuit Breaker Status -->
        <div id="circuit-breaker-status" class="hidden bg-red-900/50 border border-red-700 rounded-lg p-4 mt-4">
            <div class="flex items-center justify-between">
                <div>
                    <span class="text-red-400 font-semibold">‚ö†Ô∏è Circuit Breaker OPEN</span>
                    <p class="text-sm text-red-300 mt-1">Wartezeit: <span id="cb-remaining">--</span>s verbleibend</p>
                </div>
                <button id="btn-reset-cb" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded transition duration-150">
                    Manuell zur√ºcksetzen
                </button>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="bg-dark-800 rounded-lg border border-dark-700 p-6">
        <h2 class="text-xl font-semibold text-gray-100 mb-4">Steuerung</h2>
        
        <form id="scraper-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Industry -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Industry</label>
                    <select name="industry" id="industry-select" class="w-full bg-dark-900 border border-dark-700 rounded-lg px-4 py-2 text-gray-300 focus:outline-none focus:ring-2 focus:ring-primary">
                        {% for value, label in config.INDUSTRY_CHOICES %}
                        <option value="{{ value }}" {% if config.industry == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- QPI -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Queries per Industry</label>
                    <input type="number" name="qpi" value="{{ config.qpi }}" min="1" max="100" class="w-full bg-dark-900 border border-dark-700 rounded-lg px-4 py-2 text-gray-300 focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                
                <!-- Mode -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Modus</label>
                    <select name="mode" id="mode-select" class="w-full bg-dark-900 border border-dark-700 rounded-lg px-4 py-2 text-gray-300 focus:outline-none focus:ring-2 focus:ring-primary">
                        {% for value, label in config.MODE_CHOICES %}
                        <option value="{{ value }}" {% if config.mode == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Date Restrict -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Date Restrict</label>
                    <input type="text" name="daterestrict" value="{{ config.daterestrict }}" placeholder="z.B. d30, w8, m3" class="w-full bg-dark-900 border border-dark-700 rounded-lg px-4 py-2 text-gray-300 focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
            </div>
            
            <!-- Checkboxes -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <label class="flex items-center">
                    <input type="checkbox" name="smart" {% if config.smart %}checked{% endif %} class="mr-2 rounded bg-dark-900 border-dark-700 text-primary focus:ring-primary">
                    <span class="text-sm text-gray-300">Smart Mode</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="once" {% if config.once %}checked{% endif %} class="mr-2 rounded bg-dark-900 border-dark-700 text-primary focus:ring-primary">
                    <span class="text-sm text-gray-300">Einmal ausf√ºhren</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="force" {% if config.force %}checked{% endif %} class="mr-2 rounded bg-dark-900 border-dark-700 text-primary focus:ring-primary">
                    <span class="text-sm text-gray-300">Force (Cache ignorieren)</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="dry_run" id="dry-run-checkbox" {% if config.dry_run %}checked{% endif %} class="mr-2 rounded bg-dark-900 border-dark-700 text-primary focus:ring-primary">
                    <span class="text-sm text-gray-300">Dry Run (Testmodus)</span>
                </label>
            </div>
            
            <!-- Dependency hints -->
            <div id="dependency-hints" class="text-sm text-yellow-500 mt-2 hidden">
                <!-- JavaScript will populate this dynamically -->
            </div>
            
            <div class="flex space-x-4">
                <button type="button" id="btn-start" class="px-6 py-3 bg-primary hover:bg-primary/80 text-white font-semibold rounded-lg transition duration-150">
                    ‚ñ∂Ô∏è Scraper starten
                </button>
                <button type="button" id="btn-stop" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition duration-150" disabled>
                    ‚èπÔ∏è Scraper stoppen
                </button>
            </div>
        </form>
    </div>

    <!-- Control Center -->
    <div class="bg-dark-800 rounded-lg border border-dark-700 p-6">
        <h2 class="text-xl font-semibold text-gray-100 mb-4">‚öôÔ∏è Control Center</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Rate Limit Control -->
            <div class="bg-dark-900 rounded-lg p-4">
                <h3 class="font-semibold text-gray-200 mb-3">Rate Limit anpassen</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Globale Rate (Sek)</label>
                        <input type="number" id="global-rate-limit" min="0.5" max="60" step="0.1" value="{{ config.sleep_between_queries }}" 
                               class="w-full bg-dark-800 border border-dark-700 rounded px-3 py-2 text-gray-300 text-sm">
                    </div>
                    <button id="btn-update-rate-limit" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded transition">
                        Rate Limit aktualisieren
                    </button>
                </div>
            </div>
            
            <!-- Portal Status -->
            <div class="bg-dark-900 rounded-lg p-4">
                <h3 class="font-semibold text-gray-200 mb-3">Portal-Status</h3>
                <div id="portal-status-list" class="space-y-2 max-h-48 overflow-y-auto">
                    <div class="text-sm text-gray-500">Lade Portal-Status...</div>
                </div>
                <button id="btn-refresh-portals" class="mt-3 w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded transition">
                    Aktualisieren
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Metrics (Current Run) -->
    <div class="bg-dark-800 rounded-lg border border-dark-700 p-6">
        <h2 class="text-xl font-semibold text-gray-100 mb-4">üìä Performance-Metriken</h2>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-dark-900 rounded-lg p-4">
                <div class="text-gray-400 text-sm">Links gepr√ºft</div>
                <div class="text-2xl font-bold text-gray-100 mt-1" id="metric-links-checked">0</div>
            </div>
            <div class="bg-dark-900 rounded-lg p-4">
                <div class="text-gray-400 text-sm">Akzeptanzrate</div>
                <div class="text-2xl font-bold text-green-400 mt-1" id="metric-acceptance-rate">0%</div>
            </div>
            <div class="bg-dark-900 rounded-lg p-4">
                <div class="text-gray-400 text-sm">Block-Rate</div>
                <div class="text-2xl font-bold text-red-400 mt-1" id="metric-block-rate">0%</div>
            </div>
            <div class="bg-dark-900 rounded-lg p-4">
                <div class="text-gray-400 text-sm">√ò Request-Zeit</div>
                <div class="text-2xl font-bold text-blue-400 mt-1" id="metric-avg-time">0ms</div>
            </div>
        </div>
    </div>

    <!-- Live Logs -->
    <div class="bg-dark-800 rounded-lg border border-dark-700 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-gray-100">Live-Logs</h2>
            <div class="flex items-center space-x-2">
                <select id="log-level-filter" class="bg-dark-900 border border-dark-700 rounded px-3 py-1 text-gray-300 text-sm">
                    <option value="">Alle Levels</option>
                    <option value="DEBUG">Debug</option>
                    <option value="INFO">Info</option>
                    <option value="WARN">Warning</option>
                    <option value="ERROR">Error</option>
                    <option value="CRITICAL">Critical</option>
                </select>
                <button id="btn-clear-logs" class="text-gray-400 hover:text-primary text-sm transition duration-150">
                    Logs l√∂schen
                </button>
            </div>
        </div>
        
        <div id="log-container" class="bg-dark-900 rounded-lg p-4 h-96 overflow-y-auto font-mono text-sm text-gray-300">
            <div class="text-gray-500">Warte auf Logs...</div>
        </div>
    </div>

    <!-- Recent Runs -->
    <div class="bg-dark-800 rounded-lg border border-dark-700 p-6">
        <h2 class="text-xl font-semibold text-gray-100 mb-4">Letzte L√§ufe</h2>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="border-b border-dark-700">
                    <tr>
                        <th class="text-left py-3 px-4 text-gray-400 font-medium text-sm">ID</th>
                        <th class="text-left py-3 px-4 text-gray-400 font-medium text-sm">Status</th>
                        <th class="text-left py-3 px-4 text-gray-400 font-medium text-sm">Gestartet</th>
                        <th class="text-left py-3 px-4 text-gray-400 font-medium text-sm">Dauer</th>
                        <th class="text-left py-3 px-4 text-gray-400 font-medium text-sm">Leads</th>
                        <th class="text-left py-3 px-4 text-gray-400 font-medium text-sm">Links</th>
                        <th class="text-left py-3 px-4 text-gray-400 font-medium text-sm">Block-Rate</th>
                        <th class="text-left py-3 px-4 text-gray-400 font-medium text-sm">Gestartet von</th>
                    </tr>
                </thead>
                <tbody id="runs-tbody">
                    {% for run in recent_runs %}
                    <tr class="border-b border-dark-700 hover:bg-dark-700/50 cursor-pointer" onclick="showRunDetails({{ run.id }})">
                        <td class="py-3 px-4 text-gray-300">#{{ run.id }}</td>
                        <td class="py-3 px-4">
                            {% if run.status == 'running' %}
                            <span class="px-2 py-1 bg-primary/20 text-primary rounded text-sm">{{ run.get_status_display }}</span>
                            {% elif run.status == 'completed' %}
                            <span class="px-2 py-1 bg-green-500/20 text-green-400 rounded text-sm">{{ run.get_status_display }}</span>
                            {% elif run.status == 'partial' %}
                            <span class="px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded text-sm">{{ run.get_status_display }}</span>
                            {% elif run.status == 'failed' or run.status == 'error' %}
                            <span class="px-2 py-1 bg-red-500/20 text-red-400 rounded text-sm">{{ run.get_status_display }}</span>
                            {% elif run.status == 'stopped' %}
                            <span class="px-2 py-1 bg-gray-500/20 text-gray-400 rounded text-sm">{{ run.get_status_display }}</span>
                            {% else %}
                            <span class="px-2 py-1 bg-gray-500/20 text-gray-400 rounded text-sm">{{ run.get_status_display }}</span>
                            {% endif %}
                            {% if run.circuit_breaker_triggered %}
                            <span class="ml-1 text-xs text-red-400" title="Circuit Breaker ausgel√∂st">‚ö†Ô∏è</span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-4 text-gray-400 text-sm">{{ run.started_at|date:"d.m.Y H:i" }}</td>
                        <td class="py-3 px-4 text-gray-400 text-sm">
                            {% if run.duration %}
                                {% with total_seconds=run.duration.total_seconds %}
                                    {% if total_seconds >= 3600 %}
                                        {{ total_seconds|floatformat:0|add:"0"|floatformat:0 }}h
                                    {% elif total_seconds >= 60 %}
                                        {{ total_seconds|floatformat:0|add:"0"|floatformat:0 }}m
                                    {% else %}
                                        {{ total_seconds|floatformat:0 }}s
                                    {% endif %}
                                {% endwith %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="py-3 px-4">
                            <div class="text-gray-300">{{ run.leads_accepted }}</div>
                            <div class="text-xs text-gray-500">{{ run.lead_acceptance_rate }}%</div>
                        </td>
                        <td class="py-3 px-4">
                            <div class="text-gray-300">{{ run.links_checked }}</div>
                            <div class="text-xs text-green-500">‚úì{{ run.links_successful }}</div>
                        </td>
                        <td class="py-3 px-4">
                            {% if run.block_rate > 20 %}
                            <span class="text-red-400">{{ run.block_rate }}%</span>
                            {% elif run.block_rate > 10 %}
                            <span class="text-yellow-400">{{ run.block_rate }}%</span>
                            {% else %}
                            <span class="text-gray-400">{{ run.block_rate }}%</span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-4 text-gray-400 text-sm">
                            {% if run.started_by %}
                                {{ run.started_by.username }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="py-8 text-center text-gray-500">Keine L√§ufe vorhanden</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="{% static 'js/scraper-control.js' %}"></script>
{% endblock %}

{% block extra_js %}
<script>
// Initialize scraper control with new endpoints
const scraperControl = new ScraperControl({
    statusEndpoint: '{% url "scraper_control:api-status" %}',
    startEndpoint: '{% url "scraper_control:api-start" %}',
    stopEndpoint: '{% url "scraper_control:api-stop" %}',
    logsEndpoint: '{% url "scraper_control:api-logs-stream" %}',
    csrfToken: '{{ csrf_token }}'
});

// Dependency hints
const industrySelect = document.getElementById('industry-select');
const modeSelect = document.getElementById('mode-select');
const dryRunCheckbox = document.getElementById('dry-run-checkbox');
const hintsDiv = document.getElementById('dependency-hints');

function updateHints() {
    const industry = industrySelect.value;
    const mode = modeSelect.value;
    const dryRun = dryRunCheckbox.checked;
    
    let hints = [];
    
    // Check for problematic combinations
    if (dryRun && mode === 'aggressive') {
        hints.push('‚ö†Ô∏è Dry Run mit Aggressive Mode wird automatisch auf Standard umgestellt.');
    }
    
    // Industry-specific hints
    if (industry === 'handelsvertreter') {
        hints.push('üéØ Handelsvertreter-Modus: Sucht nach Industrievertretungen und Handelsvertretern');
    } else if (industry === 'd2d') {
        hints.push('üö™ D2D-Modus: Sucht nach Door-to-Door Vertriebsmitarbeitern');
    } else if (industry === 'callcenter') {
        hints.push('üìû Callcenter-Modus: Sucht nach Telesales und Kundenservice');
    } else if (industry === 'candidates' && mode === 'aggressive') {
        hints.push('‚ö†Ô∏è Aggressive Mode bei Kandidaten kann zu Rate-Limits f√ºhren.');
    } else if (industry === 'social' && mode !== 'snippet_only') {
        hints.push('üí° F√ºr Social Media wird Snippet-Only empfohlen.');
    } else if (industry === 'talent_hunt' && mode === 'snippet_only') {
        hints.push('üí° Talent Hunt funktioniert besser mit Standard oder Learning Mode.');
    }
    
    if (hints.length > 0) {
        // Clear and build hints safely to prevent XSS
        hintsDiv.textContent = ''; // Clear using textContent
        hints.forEach(hint => {
            const p = document.createElement('p');
            p.className = 'text-yellow-400';
            p.textContent = hint;
            hintsDiv.appendChild(p);
        });
        hintsDiv.classList.remove('hidden');
    } else {
        hintsDiv.classList.add('hidden');
    }
}

// Add event listeners
industrySelect.addEventListener('change', updateHints);
modeSelect.addEventListener('change', updateHints);
dryRunCheckbox.addEventListener('change', updateHints);

// Initial update
updateHints();

// === CONTROL CENTER FUNCTIONS ===

// Update rate limit
document.getElementById('btn-update-rate-limit').addEventListener('click', async function() {
    const rateLimit = document.getElementById('global-rate-limit').value;
    const btn = this;
    const originalText = btn.textContent;
    
    try {
        btn.disabled = true;
        btn.textContent = 'Aktualisiere...';
        
        const response = await fetch('{% url "scraper_control:api-update-rate-limit" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                rate_limit_seconds: parseFloat(rateLimit)
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úì ' + result.message);
        } else {
            alert('‚úó Fehler: ' + result.error);
        }
    } catch (error) {
        console.error('Error updating rate limit:', error);
        alert('‚úó Fehler beim Aktualisieren: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
});

// Load portal status
async function loadPortalStatus() {
    const container = document.getElementById('portal-status-list');
    
    try {
        const response = await fetch('{% url "scraper_control:api-portals-status" %}', {
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        if (!response.ok) throw new Error('Failed to load portals');
        
        const portals = await response.json();
        
        container.innerHTML = '';
        
        if (portals.length === 0) {
            container.innerHTML = '<div class="text-sm text-gray-500">Keine Portale konfiguriert</div>';
            return;
        }
        
        portals.forEach(portal => {
            const item = document.createElement('div');
            item.className = 'flex items-center justify-between p-2 bg-dark-800 rounded';
            
            let statusColor = portal.is_active ? 'text-green-400' : 'text-gray-500';
            let statusIcon = portal.is_active ? '‚úì' : '‚úó';
            
            if (portal.circuit_breaker_tripped) {
                statusColor = 'text-red-400';
                statusIcon = '‚ö†Ô∏è';
            }
            
            // Create elements safely using DOM manipulation
            const flexDiv = document.createElement('div');
            flexDiv.className = 'flex-1';
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'text-sm text-gray-200';
            nameDiv.textContent = portal.display_name;
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'text-xs text-gray-500';
            infoDiv.textContent = `Rate: ${portal.rate_limit_seconds}s | Errors: ${portal.consecutive_errors}`;
            
            flexDiv.appendChild(nameDiv);
            flexDiv.appendChild(infoDiv);
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'flex items-center space-x-2';
            
            const statusSpan = document.createElement('span');
            statusSpan.className = statusColor;
            statusSpan.textContent = statusIcon;
            
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'text-xs px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded';
            toggleBtn.textContent = portal.is_active ? 'Deaktivieren' : 'Aktivieren';
            toggleBtn.onclick = () => togglePortal(portal.name, !portal.is_active);
            
            actionsDiv.appendChild(statusSpan);
            actionsDiv.appendChild(toggleBtn);
            
            if (portal.circuit_breaker_tripped) {
                const resetBtn = document.createElement('button');
                resetBtn.className = 'text-xs px-2 py-1 bg-orange-600 hover:bg-orange-700 rounded';
                resetBtn.textContent = 'Reset';
                resetBtn.onclick = () => resetCircuitBreaker(portal.name);
                actionsDiv.appendChild(resetBtn);
            }
            
            item.appendChild(flexDiv);
            item.appendChild(actionsDiv);
            
            container.appendChild(item);
        });
        
    } catch (error) {
        console.error('Error loading portal status:', error);
        container.innerHTML = '<div class="text-sm text-red-400">Fehler beim Laden</div>';
    }
}

// Toggle portal active state
window.togglePortal = async function(portalName, active) {
    try {
        const response = await fetch('{% url "scraper_control:api-toggle-portal" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                portal: portalName,
                active: active
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            await loadPortalStatus();
        } else {
            alert('‚úó Fehler: ' + result.error);
        }
    } catch (error) {
        console.error('Error toggling portal:', error);
        alert('‚úó Fehler: ' + error.message);
    }
};

// Reset circuit breaker
window.resetCircuitBreaker = async function(portalName) {
    try {
        const response = await fetch('{% url "scraper_control:api-reset-circuit-breaker" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                portal: portalName
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            await loadPortalStatus();
            alert('‚úì Circuit Breaker zur√ºckgesetzt');
        } else {
            alert('‚úó Fehler: ' + result.error);
        }
    } catch (error) {
        console.error('Error resetting circuit breaker:', error);
        alert('‚úó Fehler: ' + error.message);
    }
};

// Refresh portal status
document.getElementById('btn-refresh-portals').addEventListener('click', loadPortalStatus);

// Load portal status on page load
loadPortalStatus();
setInterval(loadPortalStatus, 10000); // Refresh every 10 seconds

// Performance metrics update (enhance status update)
const originalUpdateUI = scraperControl.updateUI;
scraperControl.updateUI = function(status) {
    originalUpdateUI.call(this, status);
    
    // Update performance metrics
    document.getElementById('metric-links-checked').textContent = status.links_checked || 0;
    document.getElementById('metric-acceptance-rate').textContent = (status.lead_acceptance_rate || 0) + '%';
    document.getElementById('metric-block-rate').textContent = (status.block_rate || 0) + '%';
    document.getElementById('metric-avg-time').textContent = Math.round(status.avg_request_time_ms || 0) + 'ms';
    
    // Update Circuit Breaker Status
    const cbStatus = document.getElementById('circuit-breaker-status');
    const cbRemaining = document.getElementById('cb-remaining');
    
    if (status.circuit_breaker_state === 'open' || status.circuit_breaker_state === 'half_open') {
        cbStatus.classList.remove('hidden');
        if (status.circuit_breaker_remaining_seconds !== undefined) {
            cbRemaining.textContent = Math.ceil(status.circuit_breaker_remaining_seconds);
        } else {
            cbRemaining.textContent = '--';
        }
    } else {
        cbStatus.classList.add('hidden');
    }
};

// Circuit Breaker Reset
document.getElementById('btn-reset-cb').addEventListener('click', async function() {
    if (!confirm('Circuit Breaker manuell zur√ºcksetzen?')) {
        return;
    }
    
    try {
        const response = await fetch('{% url "scraper_control:api-reset-circuit-breaker" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({})
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úì Circuit Breaker zur√ºckgesetzt');
            scraperControl.updateStatus();
        } else {
            alert('‚úó Fehler: ' + result.error);
        }
    } catch (error) {
        console.error('Error resetting circuit breaker:', error);
        alert('‚úó Fehler beim Zur√ºcksetzen: ' + error.message);
    }
});

// Placeholder for run details modal
window.showRunDetails = function(runId) {
    // TODO: Implement modal with detailed run information
    console.log('Show details for run', runId);
};
</script>
{% endblock %}
