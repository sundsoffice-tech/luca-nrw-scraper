{% extends 'crm/base.html' %}
{% load static %}
{% block title %}Dashboard - TELIS CRM{% endblock %}

{% block extra_head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<!-- Welcome Message -->
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-100 mb-2">
        Willkommen, {{ user.get_full_name|default:user.username }}! ğŸ‘‹
    </h1>
    <p class="text-gray-400">
        {% if user_role %}
            Sie sind angemeldet als <span class="text-primary font-semibold">{{ user_role }}</span>
        {% else %}
            Hier ist eine Ãœbersicht Ihrer AktivitÃ¤ten
        {% endif %}
    </p>
</div>

<!-- KPI Cards with Real-time Data -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Leads -->
    <div class="bg-dark-800 border border-dark-700 rounded-lg p-6 hover:border-primary/50 transition duration-150">
        <div class="flex items-center justify-between mb-4">
            <div class="text-3xl">ğŸ‘¥</div>
            <div class="text-xs text-gray-400">Gesamt</div>
        </div>
        <div class="text-2xl font-bold text-gray-100 mb-1" id="total-leads-value">
            {{ stats.total|default:0 }}
        </div>
        <div class="text-sm text-gray-400">
            Leads im System
        </div>
        <div class="mt-3 flex items-center text-xs">
            <span class="text-green-400" id="total-leads-sub">+{{ stats.today|default:0 }} heute</span>
        </div>
    </div>

    <!-- Calls Today -->
    <div class="bg-dark-800 border border-dark-700 rounded-lg p-6 hover:border-primary/50 transition duration-150">
        <div class="flex items-center justify-between mb-4">
            <div class="text-3xl">ğŸ“</div>
            <div class="text-xs text-gray-400">Heute</div>
        </div>
        <div class="text-2xl font-bold text-gray-100 mb-1" id="calls-today-value">
            {{ stats.calls_today|default:0 }}
        </div>
        <div class="text-sm text-gray-400">
            Anrufe getÃ¤tigt
        </div>
        <div class="mt-3 flex items-center text-xs">
            <span class="text-gray-500" id="calls-today-sub">Durchschnitt: 12/Tag</span>
        </div>
    </div>

    <!-- Conversion Rate -->
    <div class="bg-dark-800 border border-dark-700 rounded-lg p-6 hover:border-primary/50 transition duration-150">
        <div class="flex items-center justify-between mb-4">
            <div class="text-3xl">ğŸ“ˆ</div>
            <div class="text-xs text-gray-400">Performance</div>
        </div>
        <div class="text-2xl font-bold text-gray-100 mb-1" id="conversion-rate-value">
            12.5%
        </div>
        <div class="text-sm text-gray-400">
            Conversion Rate
        </div>
        <div class="mt-3 flex items-center text-xs">
            <span class="text-green-400" id="conversion-rate-sub">â†‘ 2.3%</span>
            <span class="text-gray-500 ml-1">vs. letzte Woche</span>
        </div>
    </div>

    <!-- Hot Leads -->
    <div class="bg-dark-800 border border-dark-700 rounded-lg p-6 hover:border-primary/50 transition duration-150">
        <div class="flex items-center justify-between mb-4">
            <div class="text-3xl">ğŸ”¥</div>
            <div class="text-xs text-gray-400">PrioritÃ¤t</div>
        </div>
        <div class="text-2xl font-bold text-primary mb-1" id="hot-leads-value">
            {{ stats.hot_leads|default:0 }}
        </div>
        <div class="text-sm text-gray-400">
            Hot Leads
        </div>
        <div class="mt-3 flex items-center text-xs">
            <span class="text-primary" id="hot-leads-sub">Score â‰¥ 80</span>
        </div>
    </div>
</div>

<!-- Time Period Stats -->
<div class="bg-dark-800 border border-dark-700 rounded-lg p-6 mb-8">
    <h2 class="text-xl font-bold text-gray-100 mb-4 flex items-center">
        <span class="text-2xl mr-2">ğŸ“…</span>
        Leads nach Zeitraum
    </h2>
    <div class="grid grid-cols-3 gap-6">
        <div class="text-center">
            <div class="text-3xl font-bold text-primary mb-1">{{ stats.today|default:0 }}</div>
            <div class="text-sm text-gray-400">Heute</div>
        </div>
        <div class="text-center">
            <div class="text-3xl font-bold text-primary mb-1">{{ stats.week|default:0 }}</div>
            <div class="text-sm text-gray-400">Diese Woche</div>
        </div>
        <div class="text-center">
            <div class="text-3xl font-bold text-primary mb-1">{{ stats.month|default:0 }}</div>
            <div class="text-sm text-gray-400">Dieser Monat</div>
        </div>
    </div>
</div>

<!-- Top Sources & Error Reasons -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Top Sources by Quality -->
    <div class="bg-dark-800 border border-dark-700 rounded-lg p-6">
        <h2 class="text-xl font-bold text-gray-100 mb-4 flex items-center">
            <span class="text-2xl mr-2">ğŸ¯</span>
            Top-Quellen nach QualitÃ¤t
        </h2>
        <div class="space-y-3">
            {% for source in stats.top_sources %}
            <div class="p-3 bg-dark-900 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-300 font-medium">{{ source.source }}</span>
                    <span class="text-xs px-2 py-1 bg-primary/20 text-primary rounded">{{ source.count }} Leads</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-400">Conversion: {{ source.conversion_rate }}%</span>
                    <span class="text-gray-400">Ã˜ Score: {{ source.avg_quality }}</span>
                </div>
                <div class="mt-2 w-full bg-dark-700 rounded-full h-2">
                    <div class="bg-green-500 h-2 rounded-full" style="width: {{ source.conversion_rate }}%"></div>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-4 text-gray-500">Keine Daten verfÃ¼gbar</div>
            {% endfor %}
        </div>
    </div>

    <!-- Top Error Reasons -->
    <div class="bg-dark-800 border border-dark-700 rounded-lg p-6">
        <h2 class="text-xl font-bold text-gray-100 mb-4 flex items-center">
            <span class="text-2xl mr-2">âš ï¸</span>
            Top-FehlergrÃ¼nde
        </h2>
        <div class="space-y-3">
            {% for error in stats.error_reasons %}
            <div class="p-3 bg-dark-900 rounded-lg">
                <div class="flex items-center justify-between">
                    <span class="text-gray-300">{{ error.reason }}</span>
                    <span class="text-red-400 font-bold">{{ error.count }}</span>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-4 text-gray-500">Keine Fehler gefunden ğŸ‰</div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Charts & Activity Feed -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Left Column: Charts (2/3 width) -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Lead Trend Chart -->
        <div class="bg-dark-800 border border-dark-700 rounded-lg p-6">
            <h2 class="text-xl font-bold text-gray-100 mb-4 flex items-center">
                <span class="text-2xl mr-2">ğŸ“Š</span>
                Lead-Trend (7 Tage)
            </h2>
            <div style="height: 250px;">
                <canvas id="leadTrendChart"></canvas>
            </div>
        </div>

        <!-- Data Quality Trend Chart -->
        <div class="bg-dark-800 border border-dark-700 rounded-lg p-6">
            <h2 class="text-xl font-bold text-gray-100 mb-4 flex items-center">
                <span class="text-2xl mr-2">ğŸ“ˆ</span>
                DatenqualitÃ¤t-Trend (7 Tage)
            </h2>
            <div style="height: 200px;">
                <canvas id="qualityTrendChart"></canvas>
            </div>
        </div>

        <!-- Status & Source Distribution -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Status Distribution -->
            <div class="bg-dark-800 border border-dark-700 rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-100 mb-4">Status-Verteilung</h2>
                <div style="height: 200px;">
                    <canvas id="statusDistChart"></canvas>
                </div>
            </div>

            <!-- Source Distribution -->
            <div class="bg-dark-800 border border-dark-700 rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-100 mb-4">Quellen-Verteilung</h2>
                <div style="height: 200px;">
                    <canvas id="sourceDistChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Top Performers (Manager/Admin only) -->
        {% if user_role == 'Admin' or user_role == 'Manager' %}
        <div class="bg-dark-800 border border-dark-700 rounded-lg p-6">
            <h2 class="text-xl font-bold text-gray-100 mb-4 flex items-center">
                <span class="text-2xl mr-2">ğŸ†</span>
                Top Performers
            </h2>
            <div id="team-performance">
                <div class="text-center py-8 text-gray-500">
                    <div class="animate-pulse">LÃ¤dt...</div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Right Column: Activity Feed (1/3 width) -->
    <div class="lg:col-span-1">
        <div class="bg-dark-800 border border-dark-700 rounded-lg p-6 sticky top-6">
            <h2 class="text-xl font-bold text-gray-100 mb-4 flex items-center">
                <span class="text-2xl mr-2">ğŸ“‹</span>
                Letzte AktivitÃ¤ten
            </h2>
            <div id="activity-feed" class="space-y-3 max-h-[600px] overflow-y-auto">
                <div class="text-center py-8 text-gray-500">
                    <div class="animate-pulse">LÃ¤dt...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
    <a href="{% url 'crm-leads' %}" class="block bg-dark-800 border border-dark-700 rounded-lg p-6 hover:border-primary/50 transition duration-150">
        <div class="flex items-center">
            <span class="text-3xl mr-4">ğŸ‘¥</span>
            <div>
                <h3 class="text-lg font-bold text-gray-100 mb-1">Lead-Verwaltung</h3>
                <p class="text-sm text-gray-400">Alle Leads anzeigen und verwalten</p>
            </div>
        </div>
    </a>

    <button class="w-full bg-dark-800 border border-dark-700 rounded-lg p-6 hover:border-primary/50 transition duration-150 text-left">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <span class="text-3xl mr-4">ğŸ“</span>
                <div>
                    <h3 class="text-lg font-bold text-gray-100 mb-1">NÃ¤chsten Lead anrufen</h3>
                    <p class="text-sm text-gray-400">Telefon-Modul Ã¶ffnen</p>
                </div>
            </div>
            <span class="text-xs bg-primary/20 text-primary px-2 py-1 rounded">Bald</span>
        </div>
    </button>

    <button class="w-full bg-dark-800 border border-dark-700 rounded-lg p-6 hover:border-primary/50 transition duration-150 text-left">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <span class="text-3xl mr-4">ğŸ“Š</span>
                <div>
                    <h3 class="text-lg font-bold text-gray-100 mb-1">Tagesbericht</h3>
                    <p class="text-sm text-gray-400">Report erstellen</p>
                </div>
            </div>
            <span class="text-xs bg-primary/20 text-primary px-2 py-1 rounded">Bald</span>
        </div>
    </button>
</div>

<!-- Info Banner -->
<div class="bg-primary/10 border border-primary/30 rounded-lg p-6">
    <div class="flex items-start">
        <div class="text-3xl mr-4">ğŸš€</div>
        <div>
            <h3 class="text-lg font-bold text-primary mb-2">CRM Phase 2 - Live Dashboard</h3>
            <p class="text-gray-300 text-sm">
                Das Dashboard zeigt nun Echtzeit-KPIs, interaktive Charts und eine AktivitÃ¤tsfeed.
                Weitere Features wie Lead-Verwaltung, Telefonie und Reports werden kontinuierlich hinzugefÃ¼gt.
            </p>
            <div class="mt-4 flex flex-wrap gap-2">
                <span class="text-xs px-3 py-1 bg-green-900/30 text-green-400 rounded-full">âœ“ Echtzeit-KPIs</span>
                <span class="text-xs px-3 py-1 bg-green-900/30 text-green-400 rounded-full">âœ“ Interactive Charts</span>
                <span class="text-xs px-3 py-1 bg-green-900/30 text-green-400 rounded-full">âœ“ AktivitÃ¤tsfeed</span>
                <span class="text-xs px-3 py-1 bg-green-900/30 text-green-400 rounded-full">âœ“ Lead-Verwaltung</span>
                <span class="text-xs px-3 py-1 bg-yellow-900/30 text-yellow-400 rounded-full">â—‹ Telefonie</span>
                <span class="text-xs px-3 py-1 bg-yellow-900/30 text-yellow-400 rounded-full">â—‹ Reports</span>
            </div>
        </div>
    </div>
</div>

<!-- Load Dashboard JavaScript -->
<script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}
