{% extends 'crm/base.html' %}

{% block title %}Form Builder - {{ form.name }} - TELIS CRM{% endblock %}

{% block content %}
<div class="p-6">
    <!-- Header -->
    <div class="mb-6 flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-white mb-2">
                üé® Form Builder: {{ form.name }}
            </h1>
            <p class="text-gray-400">Drag and drop to build your custom form</p>
        </div>
        <div class="flex gap-2">
            <a href="{% url 'forms:preview' form.slug %}" 
               class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">
                üëÅÔ∏è Preview
            </a>
            <a href="{% url 'forms:detail' form.slug %}" 
               class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition">
                ‚Üê Back
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Field Palette -->
        <div class="lg:col-span-1">
            <div class="bg-dark-800 rounded-lg p-4 border border-dark-700">
                <h3 class="text-lg font-semibold text-white mb-4">üì¶ Field Types</h3>
                <div class="space-y-2" id="field-palette">
                    <div class="field-type-item p-3 bg-dark-700 hover:bg-dark-600 rounded cursor-pointer transition" 
                         data-type="text">
                        <div class="font-medium text-white">üìù Text Input</div>
                        <div class="text-xs text-gray-400">Single line text</div>
                    </div>
                    <div class="field-type-item p-3 bg-dark-700 hover:bg-dark-600 rounded cursor-pointer transition" 
                         data-type="email">
                        <div class="font-medium text-white">üìß Email Input</div>
                        <div class="text-xs text-gray-400">Email validation</div>
                    </div>
                    <div class="field-type-item p-3 bg-dark-700 hover:bg-dark-600 rounded cursor-pointer transition" 
                         data-type="phone">
                        <div class="font-medium text-white">üìû Phone Input</div>
                        <div class="text-xs text-gray-400">Phone number</div>
                    </div>
                    <div class="field-type-item p-3 bg-dark-700 hover:bg-dark-600 rounded cursor-pointer transition" 
                         data-type="textarea">
                        <div class="font-medium text-white">üìÑ Text Area</div>
                        <div class="text-xs text-gray-400">Multi-line text</div>
                    </div>
                    <div class="field-type-item p-3 bg-dark-700 hover:bg-dark-600 rounded cursor-pointer transition" 
                         data-type="dropdown">
                        <div class="font-medium text-white">‚ñº Dropdown</div>
                        <div class="text-xs text-gray-400">Select from options</div>
                    </div>
                    <div class="field-type-item p-3 bg-dark-700 hover:bg-dark-600 rounded cursor-pointer transition" 
                         data-type="checkbox">
                        <div class="font-medium text-white">‚òëÔ∏è Checkbox</div>
                        <div class="text-xs text-gray-400">Yes/No option</div>
                    </div>
                    <div class="field-type-item p-3 bg-dark-700 hover:bg-dark-600 rounded cursor-pointer transition" 
                         data-type="radio">
                        <div class="font-medium text-white">üîò Radio Buttons</div>
                        <div class="text-xs text-gray-400">Choose one option</div>
                    </div>
                    <div class="field-type-item p-3 bg-dark-700 hover:bg-dark-600 rounded cursor-pointer transition" 
                         data-type="file">
                        <div class="font-medium text-white">üìé File Upload</div>
                        <div class="text-xs text-gray-400">Upload files</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Canvas -->
        <div class="lg:col-span-2">
            <div class="bg-dark-800 rounded-lg p-6 border border-dark-700 min-h-[600px]">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-white">üìã Form Fields</h3>
                    <button onclick="saveForm()" 
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded transition">
                        üíæ Save Form
                    </button>
                </div>
                <div id="form-canvas" class="space-y-4 min-h-[500px]">
                    <!-- Fields will be added here -->
                    <div id="canvas-empty" class="text-center py-20 text-gray-500">
                        <div class="text-6xl mb-4">üìù</div>
                        <p>Click on a field type to add it to your form</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Field Properties -->
        <div class="lg:col-span-1">
            <div class="bg-dark-800 rounded-lg p-4 border border-dark-700">
                <h3 class="text-lg font-semibold text-white mb-4">‚öôÔ∏è Properties</h3>
                <div id="field-properties">
                    <p class="text-gray-500 text-sm text-center py-10">
                        Select a field to edit its properties
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let formFields = [];
let selectedFieldId = null;
let fieldIdCounter = 0;

// Load existing fields
document.addEventListener('DOMContentLoaded', function() {
    loadFields();
});

// Load fields from server
async function loadFields() {
    try {
        const response = await fetch('{% url "forms:api-get-fields" form.slug %}');
        const data = await response.json();
        
        if (data.success && data.fields.length > 0) {
            formFields = data.fields.map(f => ({...f, tempId: ++fieldIdCounter}));
            renderCanvas();
        }
    } catch (error) {
        console.error('Error loading fields:', error);
    }
}

// Add field from palette
document.querySelectorAll('.field-type-item').forEach(item => {
    item.addEventListener('click', function() {
        const fieldType = this.getAttribute('data-type');
        addField(fieldType);
    });
});

function addField(fieldType) {
    const field = {
        tempId: ++fieldIdCounter,
        field_type: fieldType,
        label: getDefaultLabel(fieldType),
        field_name: 'field_' + fieldIdCounter,
        placeholder: '',
        help_text: '',
        required: false,
        options: [],
        order: formFields.length,
        width: 'full'
    };
    
    formFields.push(field);
    renderCanvas();
    selectField(field.tempId);
}

function getDefaultLabel(fieldType) {
    const labels = {
        'text': 'Text Field',
        'email': 'Email Address',
        'phone': 'Phone Number',
        'textarea': 'Message',
        'dropdown': 'Select Option',
        'checkbox': 'Checkbox',
        'radio': 'Radio Buttons',
        'file': 'Upload File'
    };
    return labels[fieldType] || 'Field';
}

// Render form canvas
function renderCanvas() {
    const canvas = document.getElementById('form-canvas');
    const empty = document.getElementById('canvas-empty');
    
    if (formFields.length === 0) {
        empty.style.display = 'block';
        return;
    }
    
    empty.style.display = 'none';
    
    canvas.innerHTML = formFields.map(field => `
        <div class="field-item p-4 bg-dark-700 rounded border border-dark-600 hover:border-primary cursor-pointer ${selectedFieldId === field.tempId ? 'border-primary' : ''}" 
             data-field-id="${field.tempId}"
             onclick="selectField(${field.tempId})">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="font-medium text-white mb-1">
                        ${field.label}
                        ${field.required ? '<span class="text-red-500">*</span>' : ''}
                    </div>
                    <div class="text-xs text-gray-400 mb-2">${field.field_type}</div>
                    ${renderFieldPreview(field)}
                </div>
                <div class="flex gap-2">
                    <button onclick="event.stopPropagation(); moveFieldUp(${field.tempId})" 
                            class="text-gray-400 hover:text-white p-1">‚ñ≤</button>
                    <button onclick="event.stopPropagation(); moveFieldDown(${field.tempId})" 
                            class="text-gray-400 hover:text-white p-1">‚ñº</button>
                    <button onclick="event.stopPropagation(); deleteField(${field.tempId})" 
                            class="text-red-400 hover:text-red-300 p-1">üóëÔ∏è</button>
                </div>
            </div>
        </div>
    `).join('');
}

function renderFieldPreview(field) {
    switch(field.field_type) {
        case 'text':
        case 'email':
        case 'phone':
            return `<input type="text" placeholder="${field.placeholder || field.label}" class="w-full px-3 py-2 bg-dark-800 border border-dark-600 rounded text-white text-sm" disabled>`;
        case 'textarea':
            return `<textarea placeholder="${field.placeholder || field.label}" class="w-full px-3 py-2 bg-dark-800 border border-dark-600 rounded text-white text-sm" rows="3" disabled></textarea>`;
        case 'dropdown':
            return `<select class="w-full px-3 py-2 bg-dark-800 border border-dark-600 rounded text-white text-sm" disabled>
                <option>Select...</option>
                ${(field.options || []).map(opt => `<option>${opt}</option>`).join('')}
            </select>`;
        case 'checkbox':
            return `<label class="flex items-center text-gray-300"><input type="checkbox" class="mr-2" disabled> ${field.label}</label>`;
        case 'file':
            return `<input type="file" class="w-full text-sm text-gray-400" disabled>`;
        default:
            return '';
    }
}

// Select field
function selectField(tempId) {
    selectedFieldId = tempId;
    const field = formFields.find(f => f.tempId === tempId);
    if (!field) return;
    
    renderCanvas();
    renderProperties(field);
}

// Render properties panel
function renderProperties(field) {
    const panel = document.getElementById('field-properties');
    
    let optionsHtml = '';
    if (['dropdown', 'radio', 'checkbox'].includes(field.field_type)) {
        const options = field.options || [];
        optionsHtml = `
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">Options</label>
                <div id="options-list" class="space-y-2 mb-2">
                    ${options.map((opt, idx) => `
                        <div class="flex gap-2">
                            <input type="text" value="${opt}" 
                                   onchange="updateOption(${idx}, this.value)"
                                   class="flex-1 px-3 py-2 bg-dark-700 border border-dark-600 rounded text-white text-sm">
                            <button onclick="removeOption(${idx})" 
                                    class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded text-sm">√ó</button>
                        </div>
                    `).join('')}
                </div>
                <button onclick="addOption()" 
                        class="w-full px-3 py-2 bg-dark-700 hover:bg-dark-600 border border-dark-600 text-white rounded text-sm">
                    + Add Option
                </button>
            </div>
        `;
    }
    
    panel.innerHTML = `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Label</label>
                <input type="text" value="${field.label}" 
                       onchange="updateField('label', this.value)"
                       class="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded text-white">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Field Name</label>
                <input type="text" value="${field.field_name}" 
                       onchange="updateField('field_name', this.value)"
                       class="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded text-white text-sm">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Placeholder</label>
                <input type="text" value="${field.placeholder || ''}" 
                       onchange="updateField('placeholder', this.value)"
                       class="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded text-white">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Help Text</label>
                <input type="text" value="${field.help_text || ''}" 
                       onchange="updateField('help_text', this.value)"
                       class="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded text-white text-sm">
            </div>
            
            ${optionsHtml}
            
            <div>
                <label class="flex items-center text-gray-300">
                    <input type="checkbox" ${field.required ? 'checked' : ''} 
                           onchange="updateField('required', this.checked)"
                           class="mr-2">
                    Required field
                </label>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Width</label>
                <select onchange="updateField('width', this.value)" 
                        class="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded text-white">
                    <option value="full" ${field.width === 'full' ? 'selected' : ''}>Full Width</option>
                    <option value="half" ${field.width === 'half' ? 'selected' : ''}>Half Width</option>
                    <option value="third" ${field.width === 'third' ? 'selected' : ''}>Third Width</option>
                </select>
            </div>
        </div>
    `;
}

// Update field property
function updateField(property, value) {
    const field = formFields.find(f => f.tempId === selectedFieldId);
    if (field) {
        field[property] = value;
        renderCanvas();
    }
}

// Options management
function addOption() {
    const field = formFields.find(f => f.tempId === selectedFieldId);
    if (field) {
        if (!field.options) field.options = [];
        field.options.push('New Option');
        renderProperties(field);
    }
}

function updateOption(index, value) {
    const field = formFields.find(f => f.tempId === selectedFieldId);
    if (field && field.options) {
        field.options[index] = value;
    }
}

function removeOption(index) {
    const field = formFields.find(f => f.tempId === selectedFieldId);
    if (field && field.options) {
        field.options.splice(index, 1);
        renderProperties(field);
    }
}

// Field operations
function moveFieldUp(tempId) {
    const index = formFields.findIndex(f => f.tempId === tempId);
    if (index > 0) {
        [formFields[index], formFields[index - 1]] = [formFields[index - 1], formFields[index]];
        formFields.forEach((f, i) => f.order = i);
        renderCanvas();
    }
}

function moveFieldDown(tempId) {
    const index = formFields.findIndex(f => f.tempId === tempId);
    if (index < formFields.length - 1) {
        [formFields[index], formFields[index + 1]] = [formFields[index + 1], formFields[index]];
        formFields.forEach((f, i) => f.order = i);
        renderCanvas();
    }
}

function deleteField(tempId) {
    if (confirm('Delete this field?')) {
        formFields = formFields.filter(f => f.tempId !== tempId);
        formFields.forEach((f, i) => f.order = i);
        selectedFieldId = null;
        document.getElementById('field-properties').innerHTML = '<p class="text-gray-500 text-sm text-center py-10">Select a field to edit its properties</p>';
        renderCanvas();
    }
}

// Save form
async function saveForm() {
    try {
        const response = await fetch('{% url "forms:api-save-fields" form.slug %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                fields: formFields
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ Form saved successfully!');
        } else {
            alert('‚ùå Error saving form: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error saving form:', error);
        alert('‚ùå Error saving form');
    }
}
</script>
{% endblock %}
