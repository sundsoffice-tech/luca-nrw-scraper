{% extends "crm/base.html" %}
{% load static %}

{% block title %}Signaturen - Mailbox{% endblock %}

{% block breadcrumbs %}
<span class="text-gray-400">Mail</span>
<span class="text-gray-600">/</span>
<span class="text-white">Signaturen</span>
{% endblock %}

{% block extra_head %}
<style>
    .signature-table th,
    .signature-table td {
        border-color: #1f2937;
    }
    .signature-table tbody tr[data-signature-default="true"] {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(15, 23, 42, 0.8));
    }
    .signature-card {
        border-color: #1f2937;
    }
    .signature-preview {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid #1f2937;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <section class="bg-dark-900/60 border border-dark-700 rounded-2xl p-6 shadow-lg shadow-black/30">
        <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
            <div>
                <p class="text-xs uppercase tracking-wide text-gray-500">Mailbox</p>
                <h1 class="text-3xl font-semibold text-white">Signaturen verwalten</h1>
                <p class="text-sm text-gray-400 max-w-3xl">
                    Erstelle, bearbeite und lege fest, welche Signatur standardmäßig bei neuen Mails verwendet wird.
                    Verwende den Rich-Text-Editor, um deine Signatur detailgetreu zu gestalten.
                </p>
            </div>
            <div class="text-right text-xs text-gray-400">
                <p>Aktuelle Signaturen: <span class="text-white font-semibold">{{ signatures|length }}</span></p>
            </div>
        </div>
    </section>

    <div class="grid gap-6 lg:grid-cols-[1.2fr_0.8fr]">
        <section class="bg-dark-900/60 border border-dark-700 rounded-2xl p-5 signature-card shadow-lg shadow-black/20">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-xl font-semibold text-white">Alle Signaturen</h2>
                    <p class="text-sm text-gray-400">Übersicht deiner gespeicherten Signaturen mit Standard-Indikator.</p>
                </div>
                <span class="text-xs text-gray-400">Live Sync</span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-left text-sm text-gray-300 signature-table">
                    <thead class="text-xs uppercase text-gray-500 bg-dark-800/40">
                        <tr>
                            <th class="px-3 py-2">Name</th>
                            <th class="px-3 py-2">Aktualisiert</th>
                            <th class="px-3 py-2">Standard</th>
                            <th class="px-3 py-2 text-right">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for signature in signatures %}
                        <tr class="align-top transition hover:bg-dark-800/60" data-signature-id="{{ signature.id }}"
                            data-signature-name="{{ signature.name|default_if_none:''|escape }}"
                            data-signature-html="{{ signature.content_html|default_if_none:''|escape }}"
                            data-signature-text="{{ signature.content_text|default_if_none:''|escape }}"
                            data-signature-default="{{ signature.is_default|yesno:'true,false' }}">
                            <td class="px-3 py-3 border-t border-dark-700">
                                <div class="font-semibold text-white">{{ signature.name }}</div>
                                <div class="text-xs text-gray-400 truncate max-w-sm">
                                    {{ signature.content_text|default_if_none:"" |truncatechars:80 }}
                                </div>
                            </td>
                            <td class="px-3 py-3 border-t border-dark-700 text-gray-400" style="min-width: 160px;">
                                {{ signature.updated_at|date:"d.m.Y H:i" }}
                            </td>
                            <td class="px-3 py-3 border-t border-dark-700">
                                {% if signature.is_default %}
                                <span class="inline-flex items-center gap-2 px-3 py-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-full text-xs font-semibold">
                                    <span>Standard</span>
                                    <span class="text-white text-sm">★</span>
                                </span>
                                {% else %}
                                <span class="text-xs uppercase text-gray-400 tracking-wider">Nein</span>
                                {% endif %}
                            </td>
                            <td class="px-3 py-3 border-t border-dark-700 text-right space-x-2">
                                <button type="button"
                                        class="edit-signature-btn px-3 py-1 text-xs font-semibold text-white bg-primary/20 hover:bg-primary/30 rounded-lg transition"
                                        data-action="edit">
                                    Bearbeiten
                                </button>
                                {% if not signature.is_default %}
                                <button type="button"
                                        class="set-default-btn px-3 py-1 text-xs font-semibold text-white bg-emerald-600/80 hover:bg-emerald-500 rounded-lg transition"
                                        data-action="set-default" data-signature-id="{{ signature.id }}">
                                    Als Standard setzen
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="px-3 py-6 text-center text-sm text-gray-500">
                                Noch keine Signaturen vorhanden.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <section class="bg-dark-900/60 border border-dark-700 rounded-2xl p-5 signature-card shadow-lg shadow-black/20 space-y-5">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-semibold text-white">Signatur bearbeiten</h2>
                    <p class="text-sm text-gray-400">Wähle eine bestehende Signatur oder lege eine neue an.</p>
                </div>
                <span class="text-xs uppercase text-gray-500 tracking-widest">TinyMCE</span>
            </div>

            <div id="signature-alert" class="hidden rounded-lg border border-emerald-500/50 bg-emerald-500/10 px-4 py-2 text-sm text-emerald-300"></div>

            <form id="signature-form" class="space-y-4">
                <div class="space-y-1">
                    <label for="signature-name" class="text-xs font-semibold uppercase tracking-wide text-gray-400">Signatur Name</label>
                    <input type="text" id="signature-name" name="name" required
                           class="w-full rounded-lg border border-dark-700 bg-dark-900 px-3 py-2 text-sm text-white focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/40">
                </div>
                <div class="flex items-center gap-3 text-sm text-gray-400">
                    <input type="checkbox" id="signature-default" class="h-4 w-4 rounded border-dark-600 bg-dark-900 text-primary focus:ring-primary">
                    <label for="signature-default">Als Standard markieren</label>
                </div>
                <div>
                    <label class="text-xs font-semibold uppercase tracking-wide text-gray-400 mb-2 block">HTML-Signatur</label>
                    <textarea id="signature-editor" class="hidden"></textarea>
                </div>
                <div class="flex items-center gap-3">
                    <button type="submit"
                            class="flex-1 rounded-lg bg-gradient-to-r from-indigo-600 to-sky-500 px-4 py-3 text-sm font-semibold text-white shadow-lg shadow-indigo-900/50">
                        Signatur speichern
                    </button>
                    <button type="button" id="reset-form"
                            class="text-xs font-semibold text-gray-400 hover:text-white">
                        Bearbeitung zurücksetzen
                    </button>
                </div>
            </form>

            <div class="space-y-2">
                <div class="flex items-center justify-between">
                    <p class="text-xs font-semibold uppercase tracking-wide text-gray-400">Live Vorschau</p>
                    <small class="text-xs text-gray-500">Aktualisiert bei jeder Änderung</small>
                </div>
                <div id="signature-preview" class="signature-preview min-h-[160px] rounded-2xl p-4 text-sm leading-relaxed text-gray-100"></div>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
<script>
    const csrfToken = '{{ csrf_token }}';
    const signatureApiBase = '{% url "mailbox:signature-list" %}';
    let editingSignatureId = null;
    let alertTimeout = null;

    function showAlert(message, variant = 'success') {
        const alertEl = document.getElementById('signature-alert');
        if (!alertEl) return;
        alertEl.textContent = message;
        alertEl.classList.remove('hidden', 'border-rose-500/50', 'bg-rose-500/10', 'text-rose-300');
        alertEl.classList.remove('border-emerald-500/50', 'bg-emerald-500/10', 'text-emerald-300');
        if (variant === 'error') {
            alertEl.classList.add('border-rose-500/50', 'bg-rose-500/10', 'text-rose-300');
        } else {
            alertEl.classList.add('border-emerald-500/50', 'bg-emerald-500/10', 'text-emerald-300');
        }
        if (alertTimeout) {
            clearTimeout(alertTimeout);
        }
        alertTimeout = setTimeout(() => {
            alertEl.classList.add('hidden');
        }, 3500);
    }

    function decodeHtmlEntities(value = '') {
        const textarea = document.createElement('textarea');
        textarea.innerHTML = value;
        return textarea.value;
    }

    function refreshPreview(content = '') {
        const preview = document.getElementById('signature-preview');
        if (!preview) return;
        preview.innerHTML = content || '<p class="text-gray-500">Hier erscheint die Live-Vorschau deiner HTML-Signatur.</p>';
    }

    function resetForm() {
        editingSignatureId = null;
        document.getElementById('signature-name').value = '';
        document.getElementById('signature-default').checked = false;
        if (tinymce.get('signature-editor')) {
            tinymce.get('signature-editor').setContent('');
        }
        refreshPreview('');
    }

    function fillFormFromRow(row) {
        if (!row) return;
        editingSignatureId = row.dataset.signatureId;
        document.getElementById('signature-name').value = row.dataset.signatureName || '';
        document.getElementById('signature-default').checked = row.dataset.signatureDefault === 'true';
        const html = decodeHtmlEntities(row.dataset.signatureHtml || '');
        if (tinymce.get('signature-editor')) {
            tinymce.get('signature-editor').setContent(html);
        }
        refreshPreview(html);
    }

    async function saveSignature(event) {
        event.preventDefault();
        const name = document.getElementById('signature-name').value.trim();
        const isDefault = document.getElementById('signature-default').checked;
        const editor = tinymce.get('signature-editor');
        const htmlContent = editor ? editor.getContent() : '';
        const textOnly = editor ? editor.getContent({ format: 'text' }).trim() : '';

        if (!name) {
            showAlert('Bitte gib deiner Signatur einen Namen.', 'error');
            return;
        }

        const payload = {
            name,
            content_html: htmlContent,
            content_text: textOnly,
            is_default: isDefault
        };

        const url = editingSignatureId ? `${signatureApiBase}${editingSignatureId}/` : signatureApiBase;
        const method = editingSignatureId ? 'PATCH' : 'POST';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const error = await response.text();
                throw new Error(error || 'Fehler beim Speichern der Signatur.');
            }
            showAlert('Signatur gespeichert.');
            setTimeout(() => location.reload(), 300);
        } catch (err) {
            console.error(err);
            showAlert('Fehler: ' + err.message, 'error');
        }
    }

    async function setDefaultSignature(signatureId) {
        try {
            const response = await fetch(`${signatureApiBase}${signatureId}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ is_default: true })
            });
            if (!response.ok) {
                throw new Error('Standard konnte nicht gesetzt werden.');
            }
            showAlert('Neue Standard-Signatur gespeichert.');
            setTimeout(() => location.reload(), 300);
        } catch (err) {
            console.error(err);
            showAlert('Fehler: ' + err.message, 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('signature-form');
        form?.addEventListener('submit', saveSignature);
        document.getElementById('reset-form')?.addEventListener('click', resetForm);

        const table = document.querySelector('.signature-table tbody');
        table?.addEventListener('click', (event) => {
            const editBtn = event.target.closest('.edit-signature-btn');
            const defaultBtn = event.target.closest('.set-default-btn');
            if (editBtn) {
                const row = editBtn.closest('tr');
                fillFormFromRow(row);
            }
            if (defaultBtn) {
                const signatureId = defaultBtn.dataset.signatureId;
                setDefaultSignature(signatureId);
            }
        });

        tinymce.init({
            selector: '#signature-editor',
            height: 240,
            menubar: false,
            statusbar: false,
            skin: 'oxide-dark',
            content_css: 'dark',
            plugins: 'lists link autolink autoresize',
            toolbar: 'undo redo | bold italic underline | alignleft aligncenter alignright | bullist numlist | link',
            setup(editor) {
                editor.on('keyup change blur', () => {
                    const html = editor.getContent();
                    refreshPreview(html);
                });
            }
        });
    });
</script>
{% endblock %}
