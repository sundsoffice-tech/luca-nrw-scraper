{% extends "crm/base.html" %}
{% load static %}

{% block title %}üì¨ Posteingang - Mailbox{% endblock %}

{% block extra_head %}
<style>
    .mailbox-sidebar {
        background: #1a1a2e;
        border-right: 1px solid #2d2d44;
        min-height: calc(100vh - 60px);
    }
    .mailbox-sidebar .nav-link {
        color: #a0a0b0;
        padding: 12px 20px;
        border-radius: 8px;
        margin: 4px 12px;
        transition: all 0.2s;
    }
    .mailbox-sidebar .nav-link:hover {
        background: rgba(99, 102, 241, 0.1);
        color: #fff;
    }
    .mailbox-sidebar .nav-link.active {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: #fff;
    }
    .conversation-item {
        padding: 16px 20px;
        border-bottom: 1px solid #2d2d44;
        cursor: pointer;
        transition: all 0.2s;
    }
    .conversation-item:hover {
        background: rgba(99, 102, 241, 0.05);
    }
    .conversation-item.unread {
        background: rgba(99, 102, 241, 0.1);
        border-left: 3px solid #6366f1;
    }
    .conversation-item .subject {
        font-weight: 500;
        color: #fff;
        margin-bottom: 4px;
    }
    .conversation-item.unread .subject {
        font-weight: 700;
    }
    .conversation-item .snippet {
        color: #888;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .conversation-item .meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    .conversation-item .contact {
        color: #a0a0b0;
        font-size: 14px;
    }
    .conversation-item .time {
        color: #666;
        font-size: 12px;
    }
    .badge-count {
        background: #6366f1;
        color: #fff;
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 12px;
    }
    .star-btn {
        color: #666;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
    }
    .star-btn.starred {
        color: #fbbf24;
    }
    .compose-btn {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        color: #fff;
        font-weight: 600;
        width: 100%;
        margin-bottom: 20px;
    }
    .compose-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }
    .search-box {
        background: #16162a;
        border: 1px solid #2d2d44;
        border-radius: 8px;
        padding: 12px 16px;
        color: #fff;
    }
    .search-box:focus {
        border-color: #6366f1;
        outline: none;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex" style="min-height: calc(100vh - 60px);">
    <!-- Sidebar -->
    <div class="mailbox-sidebar" style="width: 280px; flex-shrink: 0;">
        <div class="p-3">
            <a href="{% url 'mailbox:compose' %}" class="compose-btn d-block text-center text-decoration-none">
                ‚úâÔ∏è Neue Email
            </a>
            
            <nav class="nav flex-column">
                <a href="?folder=all" class="nav-link {% if folder == 'all' %}active{% endif %}">
                    üì• Posteingang
                    {% if unread_count %}<span class="badge-count float-end">{{ unread_count }}</span>{% endif %}
                </a>
                <a href="?folder=unread" class="nav-link {% if folder == 'unread' %}active{% endif %}">
                    üìß Ungelesen
                </a>
                <a href="?folder=starred" class="nav-link {% if folder == 'starred' %}active{% endif %}">
                    ‚≠ê Markiert
                </a>
                <a href="?folder=sent" class="nav-link {% if folder == 'sent' %}active{% endif %}">
                    üì§ Gesendet
                </a>
                <a href="?folder=drafts" class="nav-link {% if folder == 'drafts' %}active{% endif %}">
                    üìù Entw√ºrfe
                </a>
                <a href="?folder=scheduled" class="nav-link {% if folder == 'scheduled' %}active{% endif %}">
                    ‚è∞ Geplant
                </a>
                <a href="?folder=trash" class="nav-link {% if folder == 'trash' %}active{% endif %}">
                    üóëÔ∏è Papierkorb
                </a>
            </nav>
            
            {% if labels %}
            <hr style="border-color: #2d2d44;">
            <h6 class="px-3 text-muted mb-2">Labels</h6>
            <nav class="nav flex-column">
                {% for label in labels %}
                <a href="?label={{ label.id }}" class="nav-link">
                    <span style="color: {{ label.color }};">‚óè</span> {{ label.name }}
                </a>
                {% endfor %}
            </nav>
            {% endif %}
            
            <hr style="border-color: #2d2d44;">
            <nav class="nav flex-column">
                <a href="{% url 'mailbox:settings' %}" class="nav-link">
                    ‚öôÔ∏è Einstellungen
                </a>
                <a href="{% url 'mailbox:signatures' %}" class="nav-link">
                    ‚úçÔ∏è Signaturen
                </a>
                <a href="{% url 'mailbox:quick-replies' %}" class="nav-link">
                    ‚ö° Schnellantworten
                </a>
            </nav>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="flex-grow-1" style="background: #0f0f1a;">
        <!-- Search & Actions Bar -->
        <div class="p-3 border-bottom" style="border-color: #2d2d44 !important;">
            <div class="d-flex gap-3">
                <form method="get" class="flex-grow-1">
                    <input type="hidden" name="folder" value="{{ folder }}">
                    <input type="text" name="search" class="search-box w-100" 
                           placeholder="üîç Emails durchsuchen..." value="{{ search }}">
                </form>
                <div class="btn-group">
                    <button class="btn btn-outline-secondary btn-sm" onclick="markSelectedRead()">
                        ‚úì Gelesen
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="archiveSelected()">
                        üìÅ Archivieren
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteSelected()">
                        üóëÔ∏è L√∂schen
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Conversation List -->
        <div class="conversation-list">
            {% for conv in page_obj %}
            <div class="conversation-item {% if not conv.is_read %}unread{% endif %}" 
                 onclick="window.location='{% url 'mailbox:conversation' conv.id %}'">
                <div class="d-flex align-items-start">
                    <input type="checkbox" class="form-check-input me-3 mt-1" 
                           onclick="event.stopPropagation();" data-id="{{ conv.id }}">
                    <button class="star-btn me-3 {% if conv.is_starred %}starred{% endif %}" 
                            onclick="event.stopPropagation(); toggleStar({{ conv.id }});">
                        {% if conv.is_starred %}‚òÖ{% else %}‚òÜ{% endif %}
                    </button>
                    <div class="flex-grow-1">
                        <div class="meta">
                            <span class="contact">
                                {{ conv.contact_name|default:conv.contact_email }}
                                {% if conv.lead %}
                                    <span class="badge bg-info ms-2">Lead</span>
                                {% endif %}
                            </span>
                            <span class="time">{{ conv.last_message_at|timesince }} ago</span>
                        </div>
                        <div class="subject">{{ conv.subject|truncatewords:10 }}</div>
                        <div class="snippet">{{ conv.messages.last.snippet|default:"" }}</div>
                    </div>
                    {% if conv.message_count > 1 %}
                    <span class="badge-count">{{ conv.message_count }}</span>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="text-center py-5 text-muted">
                <p style="font-size: 48px;">üì≠</p>
                <p>Keine Emails in diesem Ordner</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="p-3 border-top" style="border-color: #2d2d44 !important;">
            <nav>
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}&folder={{ folder }}">‚Üê</a>
                    </li>
                    {% endif %}
                    <li class="page-item disabled">
                        <span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
                    </li>
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}&folder={{ folder }}">‚Üí</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<script>
const csrfToken = '{{ csrf_token }}';

async function toggleStar(convId) {
    try {
        const response = await fetch(`/crm/mailbox/api/conversations/${convId}/star/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        });
        if (response.ok) {
            location.reload();
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function getSelectedIds() {
    return Array.from(document.querySelectorAll('.conversation-item input[type="checkbox"]:checked'))
        .map(cb => cb.dataset.id);
}

async function markSelectedRead() {
    const ids = getSelectedIds();
    for (const id of ids) {
        await fetch(`/crm/mailbox/api/conversations/${id}/mark_read/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        });
    }
    location.reload();
}

async function archiveSelected() {
    const ids = getSelectedIds();
    for (const id of ids) {
        await fetch(`/crm/mailbox/api/conversations/${id}/archive/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        });
    }
    location.reload();
}

async function deleteSelected() {
    if (!confirm('Ausgew√§hlte Konversationen l√∂schen?')) return;
    const ids = getSelectedIds();
    for (const id of ids) {
        await fetch(`/crm/mailbox/api/conversations/${id}/`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': csrfToken }
        });
    }
    location.reload();
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    
    if (e.key === 'c') {
        window.location = '{% url "mailbox:compose" %}';
    }
});
</script>
{% endblock %}
