{% extends "crm/base.html" %}
{% load static %}

{% block title %}üì¨ Posteingang - Mailbox{% endblock %}

{% block extra_head %}
<style>
    .mailbox-sidebar {
        background: #1e293b;
        border-right: 1px solid #334155;
        min-height: calc(100vh - 60px);
    }
    .mailbox-sidebar .nav-link {
        display: block;
        color: #94a3b8;
        padding: 12px 20px;
        border-radius: 8px;
        margin: 4px 12px;
        transition: all 0.2s;
        text-decoration: none;
    }
    .mailbox-sidebar .nav-link:hover {
        background: rgba(99, 102, 241, 0.1);
        color: #f1f5f9;
    }
    .mailbox-sidebar .nav-link.active {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: #fff;
    }
    .conversation-item {
        padding: 16px 20px;
        border-bottom: 1px solid #334155;
        cursor: pointer;
        transition: all 0.2s;
    }
    .conversation-item:hover {
        background: rgba(99, 102, 241, 0.05);
    }
    .conversation-item.unread {
        background: rgba(99, 102, 241, 0.1);
        border-left: 3px solid #6366f1;
    }
    .conversation-item .subject {
        font-weight: 500;
        color: #f1f5f9;
        margin-bottom: 4px;
    }
    .conversation-item.unread .subject {
        font-weight: 700;
    }
    .conversation-item .snippet {
        color: #64748b;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .conversation-item .meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    .conversation-item .contact {
        color: #94a3b8;
        font-size: 14px;
    }
    .conversation-item .time {
        color: #64748b;
        font-size: 12px;
    }
    .badge-count {
        background: #6366f1;
        color: #fff;
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 12px;
    }
    .badge-info {
        background: #06b6d4;
        color: #fff;
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 4px;
        display: inline-block;
    }
    .star-btn {
        color: #64748b;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
        transition: color 0.2s;
    }
    .star-btn:hover {
        color: #94a3b8;
    }
    .star-btn.starred {
        color: #fbbf24;
    }
    .compose-btn {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        color: #fff;
        font-weight: 600;
        width: 100%;
        margin-bottom: 20px;
        transition: all 0.2s;
        text-decoration: none;
    }
    .compose-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }
    .search-box {
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 8px;
        padding: 12px 16px;
        color: #f1f5f9;
        width: 100%;
    }
    .search-box:focus {
        border-color: #6366f1;
        outline: none;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }
    .action-btn, .action-btn-danger {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        border: 1px solid #334155;
        background: #1e293b;
        color: #94a3b8;
        cursor: pointer;
        transition: all 0.2s;
    }
    .action-btn:hover {
        background: rgba(99, 102, 241, 0.1);
        border-color: #6366f1;
        color: #f1f5f9;
    }
    .action-btn-danger {
        border-color: #991b1b;
        color: #fca5a5;
    }
    .action-btn-danger:hover {
        background: rgba(220, 38, 38, 0.1);
        border-color: #dc2626;
        color: #fee2e2;
    }
    .checkbox-input {
        width: 16px;
        height: 16px;
        cursor: pointer;
        accent-color: #6366f1;
    }
    .pagination-link {
        padding: 6px 12px;
        border-radius: 6px;
        background: #1e293b;
        border: 1px solid #334155;
        color: #94a3b8;
        text-decoration: none;
        transition: all 0.2s;
    }
    .pagination-link:hover {
        background: rgba(99, 102, 241, 0.1);
        border-color: #6366f1;
        color: #f1f5f9;
    }
    .pagination-info {
        padding: 6px 12px;
        color: #94a3b8;
        font-size: 14px;
    }
    /* Utility classes */
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .flex-grow { flex-grow: 1; }
    .items-start { align-items: flex-start; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 0.75rem; }
    .mr-3 { margin-right: 0.75rem; }
    .ml-2 { margin-left: 0.5rem; }
    .mt-1 { margin-top: 0.25rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-0 { margin-bottom: 0; }
    .p-3 { padding: 0.75rem; }
    .py-12 { padding-top: 3rem; padding-bottom: 3rem; }
    .w-full { width: 100%; }
    .border-b { border-bottom-width: 1px; }
    .border-t { border-top-width: 1px; }
    .text-center { text-align: center; }
    .text-gray-500 { color: #64748b; }
    .no-underline { text-decoration: none; }
    .block { display: block; }
    .float-right { float: right; }
</style>
{% endblock %}

{% block content %}
<div class="flex" style="min-height: calc(100vh - 60px);">
    <!-- Sidebar -->
    <div class="mailbox-sidebar" style="width: 280px; flex-shrink: 0;">
        <div class="p-3">
            <a href="{% url 'mailbox:compose' %}" class="compose-btn block text-center no-underline">
                ‚úâÔ∏è Neue Email
            </a>
            
            <nav class="flex flex-col">
                <a href="?folder=all" class="nav-link {% if folder == 'all' %}active{% endif %}">
                    üì• Posteingang
                    {% if unread_count %}<span class="badge-count float-right">{{ unread_count }}</span>{% endif %}
                </a>
                <a href="?folder=unread" class="nav-link {% if folder == 'unread' %}active{% endif %}">
                    üìß Ungelesen
                </a>
                <a href="?folder=starred" class="nav-link {% if folder == 'starred' %}active{% endif %}">
                    ‚≠ê Markiert
                </a>
                <a href="?folder=sent" class="nav-link {% if folder == 'sent' %}active{% endif %}">
                    üì§ Gesendet
                </a>
                <a href="?folder=drafts" class="nav-link {% if folder == 'drafts' %}active{% endif %}">
                    üìù Entw√ºrfe
                </a>
                <a href="?folder=scheduled" class="nav-link {% if folder == 'scheduled' %}active{% endif %}">
                    ‚è∞ Geplant
                </a>
                <a href="?folder=trash" class="nav-link {% if folder == 'trash' %}active{% endif %}">
                    üóëÔ∏è Papierkorb
                </a>
            </nav>
            
            {% if labels %}
            <hr style="border-color: #2d2d44;">
            <h6 class="px-3 text-gray-500 mb-2">Labels</h6>
            <nav class="flex flex-col">
                {% for label in labels %}
                <a href="?label={{ label.id }}" class="nav-link">
                    <span style="color: {{ label.color }};">‚óè</span> {{ label.name }}
                </a>
                {% endfor %}
            </nav>
            {% endif %}
            
            <hr style="border-color: #2d2d44;">
            <nav class="flex flex-col">
                <a href="{% url 'mailbox:settings' %}" class="nav-link">
                    ‚öôÔ∏è Einstellungen
                </a>
                <a href="{% url 'mailbox:signatures' %}" class="nav-link">
                    ‚úçÔ∏è Signaturen
                </a>
                <a href="{% url 'mailbox:quick-replies' %}" class="nav-link">
                    ‚ö° Schnellantworten
                </a>
            </nav>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="flex-grow" style="background: #0f0f1a;">
        <!-- Search & Actions Bar -->
        <div class="p-3 border-b" style="border-color: #2d2d44 !important;">
            <div class="flex gap-3">
                <form method="get" class="flex-grow">
                    <input type="hidden" name="folder" value="{{ folder }}">
                    <input type="text" name="search" class="search-box w-full" 
                           placeholder="üîç Emails durchsuchen..." value="{{ search }}">
                </form>
                <div class="flex gap-2">
                    <button class="action-btn" onclick="markSelectedRead()">
                        ‚úì Gelesen
                    </button>
                    <button class="action-btn" onclick="archiveSelected()">
                        üìÅ Archivieren
                    </button>
                    <button class="action-btn-danger" onclick="deleteSelected()">
                        üóëÔ∏è L√∂schen
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Conversation List -->
        <div class="conversation-list">
            {% for conv in page_obj %}
            <div class="conversation-item {% if not conv.is_read %}unread{% endif %}" 
                 onclick="window.location='{% url 'mailbox:conversation' conv.id %}'">
                <div class="flex items-start">
                    <input type="checkbox" class="checkbox-input mr-3 mt-1" 
                           onclick="event.stopPropagation();" data-id="{{ conv.id }}">
                    <button class="star-btn mr-3 {% if conv.is_starred %}starred{% endif %}" 
                            onclick="event.stopPropagation(); toggleStar({{ conv.id }});">
                        {% if conv.is_starred %}‚òÖ{% else %}‚òÜ{% endif %}
                    </button>
                    <div class="flex-grow">
                        <div class="meta">
                            <span class="contact">
                                {{ conv.contact_name|default:conv.contact_email }}
                                {% if conv.lead %}
                                    <span class="badge-info ml-2">Lead</span>
                                {% endif %}
                            </span>
                            <span class="time">{{ conv.last_message_at|timesince }} ago</span>
                        </div>
                        <div class="subject">{{ conv.subject|truncatewords:10 }}</div>
                        <div class="snippet">{{ conv.messages.last.snippet|default:"" }}</div>
                    </div>
                    {% if conv.message_count > 1 %}
                    <span class="badge-count">{{ conv.message_count }}</span>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="text-center py-12 text-gray-500">
                <p style="font-size: 48px;">üì≠</p>
                <p>Keine Emails in diesem Ordner</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="p-3 border-t" style="border-color: #2d2d44 !important;">
            <nav>
                <div class="flex justify-center items-center gap-2 mb-0">
                    {% if page_obj.has_previous %}
                    <a class="pagination-link" href="?page={{ page_obj.previous_page_number }}&folder={{ folder }}">‚Üê</a>
                    {% endif %}
                    <span class="pagination-info">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
                    {% if page_obj.has_next %}
                    <a class="pagination-link" href="?page={{ page_obj.next_page_number }}&folder={{ folder }}">‚Üí</a>
                    {% endif %}
                </div>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<script>
const csrfToken = '{{ csrf_token }}';

async function toggleStar(convId) {
    try {
        const response = await fetch(`/crm/mailbox/api/conversations/${convId}/star/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        });
        if (response.ok) {
            location.reload();
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function getSelectedIds() {
    return Array.from(document.querySelectorAll('.conversation-item input[type="checkbox"]:checked'))
        .map(cb => cb.dataset.id);
}

async function markSelectedRead() {
    const ids = getSelectedIds();
    for (const id of ids) {
        await fetch(`/crm/mailbox/api/conversations/${id}/mark_read/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        });
    }
    location.reload();
}

async function archiveSelected() {
    const ids = getSelectedIds();
    for (const id of ids) {
        await fetch(`/crm/mailbox/api/conversations/${id}/archive/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        });
    }
    location.reload();
}

async function deleteSelected() {
    if (!confirm('Ausgew√§hlte Konversationen l√∂schen?')) return;
    const ids = getSelectedIds();
    for (const id of ids) {
        await fetch(`/crm/mailbox/api/conversations/${id}/`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': csrfToken }
        });
    }
    location.reload();
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    
    if (e.key === 'c') {
        window.location = '{% url "mailbox:compose" %}';
    }
});
</script>
{% endblock %}
