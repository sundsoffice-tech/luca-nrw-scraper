{% extends "crm/base.html" %}
{% load static mailbox_extras %}

{% block title %}üì¨ Posteingang - Mailbox{% endblock %}

{% block extra_head %}
<style>
    .conversation-item {
        padding: 16px 20px;
        border-bottom: 1px solid #2d2d44;
        cursor: pointer;
        transition: box-shadow 0.3s ease, background 0.25s ease, border-left 0.25s ease;
        will-change: box-shadow, background;
    }
    .conversation-item:hover {
        background: rgba(99, 102, 241, 0.05);
    }
    .conversation-item.unread {
        background: rgba(99, 102, 241, 0.18);
        border-left: 4px solid #5b2df4;
        font-weight: 600;
        animation: unreadEntrance 0.4s ease-out;
        box-shadow: 0 8px 30px rgba(15, 23, 42, 0.4);
    }
    @keyframes unreadEntrance {
        from {
            transform: translateY(6px);
            opacity: 0.4;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    .conversation-item .subject {
        font-weight: 500;
        color: #fff;
        margin-bottom: 4px;
    }
    .conversation-item.unread .subject {
        font-weight: 700;
    }
    .conversation-item .snippet {
        color: #888;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .conversation-item .meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    .conversation-item .contact {
        color: #a0a0b0;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    .conversation-item.unread .contact::before {
        content: '';
        width: 7px;
        height: 7px;
        background: #60a5fa;
        border-radius: 999px;
        display: inline-block;
        box-shadow: 0 0 8px rgba(96, 165, 250, 0.9);
    }
    .conversation-item .time {
        color: #666;
        font-size: 12px;
    }
    .badge-count {
        background: #6366f1;
        color: #fff;
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 12px;
    }
    .star-btn {
        color: #666;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
    }
    .star-btn.starred {
        color: #fbbf24;
    }

    .search-box {
        background: #16162a;
        border: 1px solid #2d2d44;
        border-radius: 8px;
        padding: 12px 16px;
        color: #fff;
    }
    .search-box:focus {
        border-color: #6366f1;
        outline: none;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }
    .shortcut-help {
        position: relative;
    }
    .shortcut-help-button {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 1px solid #2d2d44;
        background: #0f0f1a;
        color: #a0a0b0;
        font-weight: 700;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease;
    }
    .shortcut-help-button:hover {
        border-color: #6366f1;
        color: #fff;
        background: #13162a;
    }
    .shortcut-help-box {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: #0f0f1a;
        border-radius: 12px;
        border: 1px solid #1f2937;
        padding: 12px;
        min-width: 220px;
        box-shadow: 0 14px 35px rgba(15, 23, 42, 0.6);
        z-index: 20;
    }
    .shortcut-help-box ul {
        margin: 0;
        padding: 0;
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 13px;
        color: #cbd5f5;
    }
    .shortcut-help-box .shortcut-key {
        display: inline-flex;
        border-radius: 6px;
        padding: 1px 6px;
        background: #111426;
        border: 1px solid #2d2d44;
        font-size: 11px;
        font-weight: 600;
        margin-right: 6px;
        text-transform: uppercase;
    }
    .shortcut-help-box .shortcut-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .shortcut-help-box .shortcut-row span {
        color: #e2e8f0;
    }

    
    /* Additional mobile responsiveness for smaller screens */
    @media (max-width: 640px) {
        .conversation-item .meta {
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
        }
        .conversation-item .time {
            font-size: 11px;
        }
        .conversation-item .subject {
            font-size: 15px;
        }
        .conversation-item .snippet {
            font-size: 13px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-4">
    <!-- Header with Compose Button -->
    <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold text-white">üì¨ Posteingang</h1>
        <a href="{% url 'mailbox:compose' %}" class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition">
            ‚úâÔ∏è Neue Email
        </a>
    </div>
    
    <!-- Horizontale Folder Tabs -->
    <div class="flex flex-wrap gap-2 mb-4 border-b border-dark-700 pb-4">
        <a href="?folder=all" class="px-4 py-2 rounded-lg {% if folder == 'all' %}bg-indigo-600 text-white{% else %}bg-dark-800 text-gray-400 hover:bg-dark-700{% endif %}">
            üì• Posteingang {% if unread_count %}<span class="ml-1 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">{{ unread_count }}</span>{% endif %}
        </a>
        <a href="?folder=unread" class="px-4 py-2 rounded-lg {% if folder == 'unread' %}bg-indigo-600 text-white{% else %}bg-dark-800 text-gray-400 hover:bg-dark-700{% endif %}">
            üìß Ungelesen
        </a>
        <a href="?folder=starred" class="px-4 py-2 rounded-lg {% if folder == 'starred' %}bg-indigo-600 text-white{% else %}bg-dark-800 text-gray-400 hover:bg-dark-700{% endif %}">
            ‚≠ê Markiert
        </a>
        <a href="?folder=sent" class="px-4 py-2 rounded-lg {% if folder == 'sent' %}bg-indigo-600 text-white{% else %}bg-dark-800 text-gray-400 hover:bg-dark-700{% endif %}">
            üì§ Gesendet
        </a>
        <a href="?folder=drafts" class="px-4 py-2 rounded-lg {% if folder == 'drafts' %}bg-indigo-600 text-white{% else %}bg-dark-800 text-gray-400 hover:bg-dark-700{% endif %}">
            üìù Entw√ºrfe
        </a>
        <a href="?folder=scheduled" class="px-4 py-2 rounded-lg {% if folder == 'scheduled' %}bg-indigo-600 text-white{% else %}bg-dark-800 text-gray-400 hover:bg-dark-700{% endif %}">
            ‚è∞ Geplant
        </a>
        <a href="?folder=trash" class="px-4 py-2 rounded-lg {% if folder == 'trash' %}bg-indigo-600 text-white{% else %}bg-dark-800 text-gray-400 hover:bg-dark-700{% endif %}">
            üóëÔ∏è Papierkorb
        </a>
    </div>
    
    <!-- Sekund√§re Links (Settings, Signaturen, etc.) -->
    <div class="flex gap-4 mb-4 text-sm">
        <a href="{% url 'mailbox:settings' %}" class="text-gray-400 hover:text-white">‚öôÔ∏è Einstellungen</a>
        <a href="{% url 'mailbox:signatures' %}" class="text-gray-400 hover:text-white">‚úçÔ∏è Signaturen</a>
        <a href="{% url 'mailbox:quick-replies' %}" class="text-gray-400 hover:text-white">‚ö° Schnellantworten</a>
    </div>
    
    <!-- Content Area -->
    <div class="bg-dark-800 rounded-lg border border-dark-700">
        <!-- Search & Actions Bar -->
        <div class="p-3 border-b" style="border-color: #2d2d44 !important;">
            <div class="d-flex gap-3 align-items-center">
                <form method="get" class="flex-grow-1">
                    <input type="hidden" name="folder" value="{{ folder }}">
                    <input type="text" name="search" class="search-box w-100" 
                           placeholder="üîç Emails durchsuchen..." value="{{ search }}">
                </form>
                <div class="btn-group">
                    <button class="btn btn-outline-secondary btn-sm" onclick="markSelectedRead()">
                        ‚úì Gelesen
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="archiveSelected()">
                        üìÅ Archivieren
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteSelected()">
                        üóëÔ∏è L√∂schen
                    </button>
                </div>
                <div class="ms-auto position-relative shortcut-help">
                    <button type="button" id="shortcut-help-toggle" class="shortcut-help-button" aria-label="Tastenk√ºrzel anzeigen">?</button>
                    <div id="shortcut-help-box" class="shortcut-help-box hidden">
                        <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Shortcuts</div>
                        <ul>
                            <li class="shortcut-row"><span class="shortcut-key">c</span><span>Neue E-Mail</span></li>
                            <li class="shortcut-row"><span class="shortcut-key">r</span><span>Antworten (ausgew√§hlt)</span></li>
                            <li class="shortcut-row"><span class="shortcut-key">a</span><span>Alle markieren</span></li>
                            <li class="shortcut-row"><span class="shortcut-key">s</span><span>Stern umschalten</span></li>
                            <li class="shortcut-row"><span class="shortcut-key">Delete</span><span>In den Papierkorb</span></li>
                            <li class="shortcut-row"><span class="shortcut-key">?</span><span>Hilfe anzeigen</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Conversation List -->
        <div class="conversation-list">
            {% for conv in page_obj %}
            <div class="conversation-item {% if not conv.is_read %}unread{% endif %}" 
                 data-conversation-detail-url="{% url 'mailbox:conversation' conv.id %}"
                 data-conv-id="{{ conv.id }}"
                 onclick="window.location='{% url 'mailbox:conversation' conv.id %}'">
                <div class="d-flex align-items-start">
                    <input type="checkbox" class="form-check-input me-3 mt-1" 
                           onclick="event.stopPropagation();" data-id="{{ conv.id }}">
                    <button class="star-btn me-3 {% if conv.is_starred %}starred{% endif %}" 
                            onclick="event.stopPropagation(); toggleStar({{ conv.id }});">
                        {% if conv.is_starred %}‚òÖ{% else %}‚òÜ{% endif %}
                    </button>
                    <div class="flex-grow-1">
                        <div class="meta">
                            <span class="contact">
                                {{ conv.contact_name|default:conv.contact_email|highlight:search }}
                                {% if conv.lead %}
                                    <span class="badge bg-info ms-2">Lead</span>
                                {% endif %}
                            </span>
                            <span class="time">{{ conv.last_message_at|timesince }} ago</span>
                        </div>
                        <div class="subject">{{ conv.subject|truncatewords:10|highlight:search }}</div>
                        <div class="snippet">{{ conv.messages.last.snippet|default:""|highlight:search }}</div>
                    </div>
                    {% if conv.message_count > 1 %}
                    <span class="badge-count">{{ conv.message_count }}</span>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            {% include "mailbox/partials/empty_state.html" with icon="üì≠" title="All caught up!" message="Keine Emails in diesem Ordner" %}
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="p-3 border-top" style="border-color: #2d2d44 !important;">
            <nav>
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}&folder={{ folder }}">‚Üê</a>
                    </li>
                    {% endif %}
                    <li class="page-item disabled">
                        <span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
                    </li>
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}&folder={{ folder }}">‚Üí</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<script>
const csrfToken = '{{ csrf_token }}';
const composeUrl = '{% url "mailbox:compose" %}';
const shortcutHelpButton = document.getElementById('shortcut-help-toggle');
const shortcutHelpBox = document.getElementById('shortcut-help-box');

async function toggleStar(convId) {
    try {
        const response = await fetch(`/crm/mailbox/api/conversations/${convId}/star/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        });
        if (response.ok) {
            location.reload();
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function getSelectedIds() {
    return Array.from(document.querySelectorAll('.conversation-item input[type="checkbox"]:checked'))
        .map(cb => cb.dataset.id);
}

async function markSelectedRead() {
    const ids = getSelectedIds();
    for (const id of ids) {
        await fetch(`/crm/mailbox/api/conversations/${id}/mark_read/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        });
    }
    location.reload();
}

async function archiveSelected() {
    const ids = getSelectedIds();
    for (const id of ids) {
        await fetch(`/crm/mailbox/api/conversations/${id}/archive/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        });
    }
    location.reload();
}

async function deleteSelected() {
    if (!confirm('Ausgew√§hlte Konversationen l√∂schen?')) return;
    const ids = getSelectedIds();
    for (const id of ids) {
        await fetch(`/crm/mailbox/api/conversations/${id}/`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': csrfToken }
        });
    }
    location.reload();
}

function toggleShortcutHelp(force) {
    if (!shortcutHelpBox) {
        return;
    }
    const currentlyVisible = !shortcutHelpBox.classList.contains('hidden');
    const shouldShow = typeof force === 'boolean' ? force : !currentlyVisible;
    shortcutHelpBox.classList.toggle('hidden', !shouldShow);
}

function toggleSelectAll() {
    const checkboxes = document.querySelectorAll('.conversation-item input[type="checkbox"]');
    if (!checkboxes.length) {
        return;
    }
    const shouldCheck = Array.from(checkboxes).some(cb => !cb.checked);
    checkboxes.forEach(cb => cb.checked = shouldCheck);
}

function getFirstSelectedRow() {
    const checkbox = document.querySelector('.conversation-item input[type="checkbox"]:checked');
    return checkbox ? checkbox.closest('.conversation-item') : null;
}

shortcutHelpButton?.addEventListener('click', (event) => {
    event.stopPropagation();
    toggleShortcutHelp();
});

document.addEventListener('click', (event) => {
    if (!shortcutHelpBox || shortcutHelpBox.classList.contains('hidden')) {
        return;
    }
    if (shortcutHelpButton?.contains(event.target) || shortcutHelpBox.contains(event.target)) {
        return;
    }
    toggleShortcutHelp(false);
});

document.addEventListener('keydown', function(e) {
    const target = e.target;
    const isTyping = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable;
    if (isTyping) {
        return;
    }

    const key = e.key.toLowerCase();

    if (key === '?') {
        e.preventDefault();
        toggleShortcutHelp();
        return;
    }

    if (key === 'c') {
        e.preventDefault();
        window.location = composeUrl;
        return;
    }

    if (key === 'r') {
        const row = getFirstSelectedRow();
        if (row) {
            const url = row.dataset.conversationDetailUrl;
            if (url) {
                e.preventDefault();
                window.location = url;
            }
        }
        return;
    }

    if (key === 'a') {
        e.preventDefault();
        toggleSelectAll();
        return;
    }

    if (key === 's') {
        const row = getFirstSelectedRow();
        if (row) {
            const checkbox = row.querySelector('input[type="checkbox"]');
            const convId = checkbox?.dataset?.id;
            if (convId) {
                e.preventDefault();
                toggleStar(convId);
            }
        }
        return;
    }

    if (key === 'delete') {
        if (getSelectedIds().length > 0) {
            e.preventDefault();
            deleteSelected();
        }
        return;
    }
});

async function archiveConversation(convId) {
    try {
        const response = await fetch(`/crm/mailbox/api/conversations/${convId}/archive/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        });
        if (response.ok) {
            location.reload();
        }
    } catch (error) {
        console.error('Archive swipe failed:', error);
    }
}

const SWIPE_THRESHOLD = 70;

function addSwipeHandlers(row) {
    let startX = 0;
    let startY = 0;
    let swiped = false;

    row.addEventListener('touchstart', (event) => {
        if (event.touches.length > 1) return;
        startX = event.touches[0].clientX;
        startY = event.touches[0].clientY;
        swiped = false;
        row.dataset.swipeAction = '';
        row.style.transition = 'none';
    });

    row.addEventListener('touchmove', (event) => {
        if (event.touches.length > 1) return;
        const currentX = event.touches[0].clientX;
        const currentY = event.touches[0].clientY;
        const deltaX = currentX - startX;
        const deltaY = currentY - startY;
        if (Math.abs(deltaY) > Math.abs(deltaX)) {
            return;
        }
        event.preventDefault();
        const clamped = Math.max(Math.min(deltaX, 120), -120);
        row.style.transform = `translateX(${clamped}px)`;

        if (Math.abs(deltaX) >= SWIPE_THRESHOLD && !swiped) {
            swiped = true;
            row.dataset.swipeAction = 'true';
            const convId = row.dataset.convId;
            if (!convId) return;
            if (deltaX < 0) {
                archiveConversation(convId);
            } else {
                toggleStar(convId);
            }
        }
    });

    row.addEventListener('touchend', () => {
        row.style.transition = 'transform 0.25s ease';
        row.style.transform = '';
        setTimeout(() => {
            row.style.transition = '';
        }, 250);
    });
}

const conversationRows = Array.from(document.querySelectorAll('.conversation-item'));
conversationRows.forEach((row) => {
    addSwipeHandlers(row);
    row.addEventListener('click', (event) => {
        if (row.dataset.swipeAction === 'true') {
            event.stopPropagation();
            row.dataset.swipeAction = '';
            return;
        }
        const detailUrl = row.dataset.conversationDetailUrl;
        if (detailUrl) {
            window.location = detailUrl;
        }
    });
});
</script>
{% endblock %}
