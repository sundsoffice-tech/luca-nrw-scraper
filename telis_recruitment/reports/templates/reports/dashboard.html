{% extends "crm/base.html" %}

{% block title %}Reports - TELIS CRM{% endblock %}

{% block breadcrumbs %}
<span class="text-gray-400 mx-2">/</span>
<span class="text-primary">Reports</span>
{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
    .card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.15);
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-100">Reports & Analysen</h1>
            <p class="text-gray-400 mt-1">Automatische Reports und Datenanalyse</p>
        </div>
        <div class="flex space-x-3">
            <!-- Zeitraum-Auswahl -->
            <select id="periodSelect" class="px-4 py-2 bg-dark-800 text-gray-300 rounded-lg border border-dark-700 hover:bg-dark-700 transition duration-150 focus:outline-none focus:ring-2 focus:ring-primary">
                <option value="7">Letzte 7 Tage</option>
                <option value="30" selected>Letzte 30 Tage</option>
                <option value="90">Letzte 90 Tage</option>
            </select>
            
            <!-- Report-Typ Auswahl -->
            <select id="reportTypeSelect" class="px-4 py-2 bg-dark-800 text-gray-300 rounded-lg border border-dark-700 hover:bg-dark-700 transition duration-150 focus:outline-none focus:ring-2 focus:ring-primary">
                <option value="lead_overview">Lead-√úbersicht</option>
                <option value="scraper_performance">Scraper-Performance</option>
                <option value="cost_analysis">Kosten-Analyse</option>
                <option value="source_analysis">Quellen-Analyse</option>
                <option value="conversion_funnel">Conversion-Funnel</option>
            </select>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="card bg-dark-800 rounded-lg border border-dark-700 p-6">
            <div class="flex items-center justify-between mb-2">
                <span class="text-gray-400 text-sm">Gesamt Leads</span>
                <span class="text-2xl">üìä</span>
            </div>
            <div class="text-3xl font-bold text-gray-100" id="kpi-total-leads">-</div>
            <div class="mt-2">
                <span class="text-sm" id="kpi-total-change">-</span>
            </div>
        </div>
        
        <div class="card bg-dark-800 rounded-lg border border-dark-700 p-6">
            <div class="flex items-center justify-between mb-2">
                <span class="text-gray-400 text-sm">Mit Telefon</span>
                <span class="text-2xl">üìû</span>
            </div>
            <div class="text-3xl font-bold text-gray-100" id="kpi-with-phone">-</div>
            <div class="mt-2">
                <span class="text-sm" id="kpi-phone-change">-</span>
            </div>
        </div>
        
        <div class="card bg-dark-800 rounded-lg border border-dark-700 p-6">
            <div class="flex items-center justify-between mb-2">
                <span class="text-gray-400 text-sm">Phone Rate</span>
                <span class="text-2xl">üìà</span>
            </div>
            <div class="text-3xl font-bold text-gray-100" id="kpi-phone-rate">-</div>
            <div class="mt-2">
                <span class="text-sm" id="kpi-phone-rate-change">-</span>
            </div>
        </div>
        
        <div class="card bg-dark-800 rounded-lg border border-dark-700 p-6">
            <div class="flex items-center justify-between mb-2">
                <span class="text-gray-400 text-sm">Zeitraum</span>
                <span class="text-2xl">üìÖ</span>
            </div>
            <div class="text-3xl font-bold text-gray-100" id="kpi-period">30</div>
            <div class="mt-2">
                <span class="text-sm text-gray-400">Tage</span>
            </div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Lead-Trend Chart -->
        <div class="bg-dark-800 rounded-lg border border-dark-700 p-6">
            <h2 class="text-xl font-semibold text-gray-100 mb-4">Lead-Trend</h2>
            <canvas id="trendChart" height="200"></canvas>
        </div>
        
        <!-- Status-Verteilung Chart -->
        <div class="bg-dark-800 rounded-lg border border-dark-700 p-6">
            <h2 class="text-xl font-semibold text-gray-100 mb-4">Status-Verteilung</h2>
            <canvas id="statusChart" height="200"></canvas>
        </div>
        
        <!-- Top Quellen Chart -->
        <div class="bg-dark-800 rounded-lg border border-dark-700 p-6 lg:col-span-2">
            <h2 class="text-xl font-semibold text-gray-100 mb-4">Top Quellen</h2>
            <canvas id="sourceChart" height="100"></canvas>
        </div>
    </div>

    <!-- Export Buttons -->
    <div class="bg-dark-800 rounded-lg border border-dark-700 p-6">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-xl font-semibold text-gray-100">Report Exportieren</h2>
                <p class="text-sm text-gray-400 mt-1">W√§hlen Sie ein Format f√ºr den Export</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="exportReport('pdf')" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition duration-150 flex items-center space-x-2">
                    <span>üìÑ</span>
                    <span>PDF</span>
                </button>
                <button onclick="exportReport('xlsx')" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition duration-150 flex items-center space-x-2">
                    <span>üìä</span>
                    <span>Excel</span>
                </button>
                <button onclick="exportReport('csv')" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition duration-150 flex items-center space-x-2">
                    <span>üìã</span>
                    <span>CSV</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Letzte Reports Tabelle -->
    <div class="bg-dark-800 rounded-lg border border-dark-700 overflow-hidden">
        <div class="p-4 border-b border-dark-700">
            <h2 class="text-xl font-semibold text-gray-100">Letzte Reports</h2>
        </div>
        <div class="p-4">
            {% if recent_reports %}
            <div class="space-y-3">
                {% for report in recent_reports %}
                <div class="flex items-center justify-between p-4 bg-dark-900 rounded-lg hover:bg-dark-700 transition duration-150">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-cyan-500/20 rounded-lg flex items-center justify-center text-2xl">
                            {% if report.file_format == 'pdf' %}
                            üìÑ
                            {% elif report.file_format == 'xlsx' %}
                            üìä
                            {% elif report.file_format == 'csv' %}
                            üìã
                            {% else %}
                            üìÅ
                            {% endif %}
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-100">{{ report.report_type }}</h3>
                            <p class="text-sm text-gray-400">
                                {{ report.period_start|date:"d.m.Y" }} - {{ report.period_end|date:"d.m.Y" }}
                                {% if report.generated_by %}
                                ‚Ä¢ Von {{ report.generated_by.username }}
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right text-sm">
                            <p class="text-gray-400">Erstellt am</p>
                            <p class="text-gray-200">{{ report.generated_at|date:"d.m.Y H:i" }}</p>
                        </div>
                        {% if report.file_format %}
                        <span class="px-3 py-1 bg-primary/20 text-primary text-sm rounded-full uppercase">
                            {{ report.file_format }}
                        </span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <div class="text-4xl mb-3">üìä</div>
                <p class="text-gray-400">Noch keine Reports generiert.</p>
                <p class="text-sm text-gray-500 mt-1">Reports werden automatisch generiert.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Chart.js Konfiguration
Chart.defaults.color = '#9ca3af';  // text-gray-400
Chart.defaults.borderColor = '#334155';  // border-dark-700

let trendChart, statusChart, sourceChart;

// KPIs laden
async function loadKPIs() {
    const days = document.getElementById('periodSelect').value;
    
    try {
        const response = await fetch(`/reports/api/kpis/?days=${days}`);
        const data = await response.json();
        
        // Update KPI Cards
        document.getElementById('kpi-total-leads').textContent = data.total_leads.toLocaleString();
        document.getElementById('kpi-with-phone').textContent = data.with_phone.toLocaleString();
        document.getElementById('kpi-phone-rate').textContent = data.phone_rate + '%';
        document.getElementById('kpi-period').textContent = data.period_days;
        
        // Update Changes mit Farbe
        updateChangeDisplay('kpi-total-change', data.total_leads_change);
        updateChangeDisplay('kpi-phone-change', data.with_phone_change);
        updateChangeDisplay('kpi-phone-rate-change', data.phone_rate_change);
        
    } catch (error) {
        console.error('Fehler beim Laden der KPIs:', error);
    }
}

function updateChangeDisplay(elementId, change) {
    const element = document.getElementById(elementId);
    const isPositive = change >= 0;
    const arrow = isPositive ? '‚Üë' : '‚Üì';
    const colorClass = isPositive ? 'text-green-400' : 'text-red-400';
    
    element.className = `text-sm ${colorClass}`;
    element.textContent = `${arrow} ${Math.abs(change)}%`;
}

// Trend-Daten laden
async function loadTrend() {
    const days = document.getElementById('periodSelect').value;
    
    try {
        const response = await fetch(`/reports/api/trend/?days=${days}`);
        const data = await response.json();
        
        const labels = data.trend.map(t => t.date);
        const totalData = data.trend.map(t => t.total);
        const phoneData = data.trend.map(t => t.with_phone);
        
        if (trendChart) {
            trendChart.destroy();
        }
        
        const ctx = document.getElementById('trendChart').getContext('2d');
        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Gesamt Leads',
                        data: totalData,
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Mit Telefon',
                        data: phoneData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#334155'
                        }
                    },
                    x: {
                        grid: {
                            color: '#334155'
                        }
                    }
                }
            }
        });
        
    } catch (error) {
        console.error('Fehler beim Laden der Trend-Daten:', error);
    }
}

// Report-Daten laden
async function loadReport() {
    const days = document.getElementById('periodSelect').value;
    const reportType = document.getElementById('reportTypeSelect').value;
    
    try {
        const response = await fetch(`/reports/api/report/${reportType}/?days=${days}`);
        const data = await response.json();
        
        if (data.error) {
            console.error('Report Fehler:', data.error);
            return;
        }
        
        // Status-Verteilung Chart
        if (data.status_distribution) {
            updateStatusChart(data.status_distribution);
        }
        
        // Quellen Chart
        if (data.source_distribution) {
            updateSourceChart(data.source_distribution);
        } else if (data.sources) {
            updateSourceChart(data.sources.slice(0, 10));
        }
        
    } catch (error) {
        console.error('Fehler beim Laden der Report-Daten:', error);
    }
}

function updateStatusChart(statusData) {
    if (statusChart) {
        statusChart.destroy();
    }
    
    const labels = statusData.map(s => s.status || 'Unknown');
    const counts = statusData.map(s => s.count);
    
    const ctx = document.getElementById('statusChart').getContext('2d');
    statusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: counts,
                backgroundColor: [
                    '#06b6d4',
                    '#10b981',
                    '#f59e0b',
                    '#ef4444',
                    '#8b5cf6',
                    '#ec4899',
                    '#6366f1'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
}

function updateSourceChart(sourceData) {
    if (sourceChart) {
        sourceChart.destroy();
    }
    
    const labels = sourceData.map(s => s.source || s.quelle || 'Unknown');
    const counts = sourceData.map(s => s.count || s.total);
    
    const ctx = document.getElementById('sourceChart').getContext('2d');
    sourceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Anzahl Leads',
                data: counts,
                backgroundColor: '#06b6d4',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    grid: {
                        color: '#334155'
                    }
                },
                y: {
                    grid: {
                        color: '#334155'
                    }
                }
            }
        }
    });
}

// Export Funktion
function exportReport(format) {
    const days = document.getElementById('periodSelect').value;
    const reportType = document.getElementById('reportTypeSelect').value;
    
    const url = `/reports/export/${reportType}/${format}/?days=${days}`;
    window.location.href = url;
}

// Event Listeners
document.getElementById('periodSelect').addEventListener('change', function() {
    loadKPIs();
    loadTrend();
    loadReport();
});

document.getElementById('reportTypeSelect').addEventListener('change', function() {
    loadReport();
});

// Beim Laden der Seite
document.addEventListener('DOMContentLoaded', function() {
    loadKPIs();
    loadTrend();
    loadReport();
});
</script>
{% endblock %}
