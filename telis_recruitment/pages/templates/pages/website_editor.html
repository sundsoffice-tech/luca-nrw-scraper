{% extends 'crm/base.html' %}

{% block title %}Code Editor - {{ page.title }} - TELIS CRM{% endblock %}

{% block extra_head %}
<style>
    /* Full-height layout */
    #editor-container {
        height: calc(100vh - 120px);
    }
    
    /* File tree styles */
    .file-tree {
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
    }
    .file-tree-item {
        cursor: pointer;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0.125rem 0;
    }
    .file-tree-item:hover {
        background-color: rgba(6, 182, 212, 0.15);
        transform: translateX(2px);
    }
    .file-tree-item.active {
        background-color: rgba(6, 182, 212, 0.25);
        border-left: 3px solid #06b6d4;
        font-weight: 500;
    }
    .file-tree-item .file-icon {
        font-size: 1rem;
        width: 1.25rem;
        text-align: center;
    }
    .folder-item {
        font-weight: 600;
        color: #60a5fa;
        cursor: pointer;
        padding: 0.375rem 0.5rem;
        border-radius: 0.25rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        user-select: none;
    }
    .folder-item:hover {
        background-color: rgba(96, 165, 250, 0.1);
    }
    .folder-item .folder-icon {
        transition: transform 0.2s;
    }
    .folder-item.collapsed .folder-icon {
        transform: rotate(-90deg);
    }
    .folder-children {
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }
    .folder-children.collapsed {
        max-height: 0 !important;
    }
    
    /* Tab styles */
    .editor-tab {
        display: inline-flex;
        align-items: center;
        padding: 0.625rem 1.25rem;
        background: linear-gradient(to bottom, #1e293b 0%, #1a2332 100%);
        border-right: 1px solid #334155;
        border-top: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        font-size: 0.875rem;
        gap: 0.5rem;
    }
    .editor-tab:hover {
        background: linear-gradient(to bottom, #334155 0%, #2d3a4d 100%);
        border-top-color: rgba(6, 182, 212, 0.3);
    }
    .editor-tab.active {
        background: linear-gradient(to bottom, #0f172a 0%, #0a101c 100%);
        border-bottom: 3px solid #06b6d4;
        border-top-color: #06b6d4;
        color: #fff;
        font-weight: 500;
    }
    .editor-tab .tab-icon {
        font-size: 0.875rem;
    }
    .editor-tab .close-btn {
        opacity: 0;
        transition: all 0.2s;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .editor-tab:hover .close-btn {
        opacity: 0.6;
    }
    .editor-tab .close-btn:hover {
        opacity: 1;
        color: #ef4444;
        background-color: rgba(239, 68, 68, 0.1);
    }
    .editor-tab.modified::after {
        content: '';
        position: absolute;
        top: 50%;
        right: 2.5rem;
        transform: translateY(-50%);
        width: 6px;
        height: 6px;
        background-color: #fbbf24;
        border-radius: 50%;
        animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    /* Monaco container */
    #monaco-container {
        width: 100%;
        height: 100%;
        border: 1px solid #334155;
        border-radius: 0.25rem;
        overflow: hidden;
    }
    
    /* Preview iframe */
    #preview-frame {
        width: 100%;
        height: 100%;
        border: 1px solid #334155;
        border-radius: 0.25rem;
        background: white;
    }
    
    /* Resizer */
    .resizer {
        width: 10px;
        cursor: col-resize;
        background: #1e293b;
        border-left: 1px solid #334155;
        border-right: 1px solid #334155;
        position: relative;
    }
    .resizer:hover {
        background: #334155;
    }
    .resizer::after {
        content: '‚ãÆ';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #64748b;
        font-size: 1.5rem;
        line-height: 0.5;
    }
    
    /* Context menu */
    .context-menu {
        position: absolute;
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 0.375rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        padding: 0.25rem 0;
        min-width: 180px;
        z-index: 1000;
        display: none;
    }
    .context-menu.show {
        display: block;
    }
    .context-menu-item {
        padding: 0.5rem 1rem;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        align-items: center;
    }
    .context-menu-item:hover {
        background-color: rgba(6, 182, 212, 0.1);
    }
    .context-menu-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .context-menu-item .icon {
        margin-right: 0.5rem;
        width: 1.25rem;
    }
    
    /* Status bar */
    .status-bar {
        background: linear-gradient(to top, #1e293b 0%, #1a2332 100%);
        border-top: 1px solid #334155;
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.1);
    }
    .status-item {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        transition: all 0.2s;
    }
    .status-item:hover {
        background-color: rgba(6, 182, 212, 0.1);
    }
    .status-item .icon {
        font-size: 0.875rem;
    }
    
    /* Breadcrumb navigation */
    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(6, 182, 212, 0.05);
        border-bottom: 1px solid #334155;
        font-size: 0.875rem;
    }
    .breadcrumb-item {
        color: #64748b;
        transition: all 0.2s;
    }
    .breadcrumb-item:hover {
        color: #06b6d4;
        cursor: pointer;
    }
    .breadcrumb-separator {
        color: #475569;
        user-select: none;
    }
    .breadcrumb-item.active {
        color: #fff;
        font-weight: 500;
    }
    
    /* Loading state */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 23, 42, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #334155;
        border-top-color: #06b6d4;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Toolbar */
    .toolbar {
        background: linear-gradient(to bottom, #1e293b 0%, #1a2332 100%);
        border-bottom: 1px solid #334155;
        padding: 0.75rem 1rem;
        display: flex;
        gap: 0.25rem;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .toolbar-btn {
        padding: 0.5rem;
        border-radius: 0.375rem;
        transition: all 0.2s;
        cursor: pointer;
        background: transparent;
        border: none;
        color: #94a3b8;
        display: flex;
        align-items: center;
        gap: 0.375rem;
        font-size: 0.875rem;
    }
    .toolbar-btn:hover {
        background-color: rgba(6, 182, 212, 0.15);
        color: #06b6d4;
        transform: translateY(-1px);
    }
    .toolbar-btn:active {
        transform: translateY(0);
    }
    .toolbar-separator {
        width: 1px;
        height: 1.5rem;
        background-color: #334155;
        margin: 0 0.5rem;
    }
    .toolbar-label {
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-left: 0.5rem;
    }
    
    /* Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }
    .modal-overlay.show {
        display: flex;
    }
    .modal {
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 0.5rem;
        padding: 1.5rem;
        max-width: 500px;
        width: 90%;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col h-full">
    <!-- Header -->
    <div class="bg-dark-800 border-b border-dark-700 px-4 py-3">
        <div class="flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <a href="{% url 'pages:builder-list' %}" 
                   class="text-gray-400 hover:text-white transition">
                    ‚Üê Back
                </a>
                <div class="text-gray-500">|</div>
                <div>
                    <h1 class="text-lg font-bold text-white">Code Editor</h1>
                    <p class="text-sm text-gray-400">{{ page.title }}</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button id="btn-preview" onclick="togglePreview()" 
                        class="px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 transition text-sm">
                    üëÅÔ∏è Preview
                </button>
                <a href="{% url 'pages:upload-manager' slug=page.slug %}" 
                   class="px-3 py-1.5 bg-dark-700 text-white rounded hover:bg-dark-600 transition text-sm border border-dark-600">
                    üì¶ Upload Manager
                </a>
                <a href="{% url 'pages:export-project' slug=page.slug %}" 
                   class="px-3 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 transition text-sm">
                    ‚¨áÔ∏è Export ZIP
                </a>
            </div>
        </div>
    </div>
    
    <!-- Main Editor Layout -->
    <div id="editor-container" class="flex overflow-hidden">
        <!-- Left Panel: File Tree -->
        <div id="file-tree-panel" class="w-64 bg-dark-800 border-r border-dark-700 flex flex-col">
            <!-- Toolbar -->
            <div class="toolbar">
                <span class="toolbar-label">Files</span>
                <button onclick="showCreateFileDialog()" 
                        class="toolbar-btn" title="New File (Ctrl+N)">
                    <span>üìÑ</span>
                    <span class="hidden md:inline">New File</span>
                </button>
                <button onclick="showCreateFolderDialog()" 
                        class="toolbar-btn" title="New Folder">
                    <span>üìÅ</span>
                    <span class="hidden md:inline">New Folder</span>
                </button>
                <div class="toolbar-separator"></div>
                <span class="toolbar-label">Search</span>
                <button onclick="showSearchDialog()" 
                        class="toolbar-btn" title="Search Files (Ctrl+P)">
                    <span>üîç</span>
                    <span class="hidden md:inline">Find</span>
                </button>
                <div class="toolbar-separator"></div>
                <span class="toolbar-label">View</span>
                <button onclick="refreshFileTree()" 
                        class="toolbar-btn" title="Refresh (F5)">
                    <span>üîÑ</span>
                    <span class="hidden md:inline">Refresh</span>
                </button>
                <button onclick="toggleFileTreeCollapse()" 
                        class="toolbar-btn" title="Collapse All Folders">
                    <span>üìÇ</span>
                    <span class="hidden md:inline">Collapse</span>
                </button>
            </div>
            
            <!-- File Tree -->
            <div id="file-tree" class="flex-1 overflow-auto p-2 file-tree">
                <!-- Populated by JavaScript -->
            </div>
        </div>
        
        <!-- Center Panel: Editor -->
        <div id="editor-panel" class="flex-1 flex flex-col">
            <!-- Breadcrumb Navigation -->
            <div id="breadcrumb" class="breadcrumb hidden">
                <!-- Populated by JavaScript -->
            </div>
            
            <!-- Tabs -->
            <div id="editor-tabs" class="bg-dark-800 border-b border-dark-700 flex overflow-x-auto">
                <!-- Tabs populated by JavaScript -->
            </div>
            
            <!-- Monaco Editor -->
            <div id="monaco-container" class="flex-1 relative">
                <!-- Loading overlay -->
                <div id="loading-overlay" class="loading-overlay hidden">
                    <div class="loading-spinner"></div>
                </div>
            </div>
            
            <!-- Status Bar -->
            <div class="status-bar">
                <div class="flex items-center space-x-2">
                    <div class="status-item">
                        <span class="icon">üìÑ</span>
                        <span id="status-file">No file open</span>
                    </div>
                    <div class="status-item">
                        <span id="status-language" class="text-gray-500"></span>
                    </div>
                    <div class="status-item">
                        <span id="status-position" class="text-gray-500"></span>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="status-item">
                        <span class="icon">üî§</span>
                        <span id="status-encoding" class="text-gray-500">UTF-8</span>
                    </div>
                    <div class="status-item">
                        <span id="status-save" class="text-green-500"></span>
                    </div>
                    <button onclick="showKeyboardShortcuts()" class="status-item hover:bg-dark-700" title="Keyboard Shortcuts">
                        <span class="icon">‚å®Ô∏è</span>
                        <span class="text-gray-500">Shortcuts</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Right Panel: Preview (Initially Hidden) -->
        <div id="preview-panel" class="hidden w-1/2 border-l border-dark-700 bg-dark-900">
            <div class="toolbar">
                <span class="text-sm text-gray-400">Preview</span>
                <div class="flex-1"></div>
                <button onclick="refreshPreview()" 
                        class="p-1 hover:bg-dark-700 rounded transition text-sm" title="Refresh">
                    üîÑ
                </button>
                <button onclick="togglePreview()" 
                        class="p-1 hover:bg-dark-700 rounded transition text-sm ml-2" title="Close">
                    ‚úï
                </button>
            </div>
            <iframe id="preview-frame"></iframe>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div id="context-menu" class="context-menu">
    <div class="context-menu-item" onclick="openFile()">
        <span class="icon">üìÇ</span> Open
    </div>
    <div class="context-menu-item" onclick="showRenameDialog()">
        <span class="icon">‚úèÔ∏è</span> Rename
    </div>
    <div class="context-menu-item" onclick="showDuplicateDialog()">
        <span class="icon">üìã</span> Duplicate
    </div>
    <div class="context-menu-item" onclick="showDeleteDialog()">
        <span class="icon">üóëÔ∏è</span> Delete
    </div>
</div>

<!-- Modal for dialogs -->
<div id="modal-overlay" class="modal-overlay">
    <div class="modal">
        <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
        <div id="modal-content" class="mb-4"></div>
        <div class="flex justify-end space-x-2">
            <button onclick="closeModal()" 
                    class="px-4 py-2 bg-dark-700 text-white rounded hover:bg-dark-600 transition">
                Cancel
            </button>
            <button id="modal-confirm" onclick="confirmModal()" 
                    class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                OK
            </button>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-4 right-4 hidden">
    <div class="bg-dark-800 border border-dark-700 rounded-lg shadow-xl p-4 max-w-sm">
        <div class="flex items-start">
            <div id="toast-icon" class="flex-shrink-0 mr-3"></div>
            <div>
                <p id="toast-text" class="text-white text-sm"></p>
            </div>
        </div>
    </div>
</div>

<!-- Keyboard Shortcuts Modal -->
<div id="shortcuts-modal" class="modal-overlay">
    <div class="modal" style="max-width: 600px;">
        <h3 class="text-xl font-bold mb-4 text-cyan-400">‚å®Ô∏è Keyboard Shortcuts</h3>
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
                <h4 class="text-sm font-semibold text-gray-400 mb-2">File Operations</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-300">Save File</span>
                        <kbd class="px-2 py-1 bg-dark-700 rounded text-cyan-400">Ctrl+S</kbd>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">New File</span>
                        <kbd class="px-2 py-1 bg-dark-700 rounded text-cyan-400">Ctrl+N</kbd>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Quick Open</span>
                        <kbd class="px-2 py-1 bg-dark-700 rounded text-cyan-400">Ctrl+P</kbd>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Refresh</span>
                        <kbd class="px-2 py-1 bg-dark-700 rounded text-cyan-400">F5</kbd>
                    </div>
                </div>
            </div>
            <div>
                <h4 class="text-sm font-semibold text-gray-400 mb-2">Editor</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-300">Find</span>
                        <kbd class="px-2 py-1 bg-dark-700 rounded text-cyan-400">Ctrl+F</kbd>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Replace</span>
                        <kbd class="px-2 py-1 bg-dark-700 rounded text-cyan-400">Ctrl+H</kbd>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Go to Line</span>
                        <kbd class="px-2 py-1 bg-dark-700 rounded text-cyan-400">Ctrl+G</kbd>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Comment Line</span>
                        <kbd class="px-2 py-1 bg-dark-700 rounded text-cyan-400">Ctrl+/</kbd>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex justify-end">
            <button onclick="hideKeyboardShortcuts()" 
                    class="px-4 py-2 bg-cyan-600 text-white rounded hover:bg-cyan-700 transition">
                Got it!
            </button>
        </div>
    </div>
</div>

<!-- Load Monaco Editor -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

<script>
// Global state
const state = {
    currentFile: null,
    openTabs: [],
    activeTab: null,
    editor: null,
    fileTree: null,
    contextTarget: null,
    unsavedChanges: {},
    modalCallback: null,
    autoSaveTimer: null,
    collapsedFolders: new Set()
};

const pageSlug = '{{ page.slug }}';
const csrfToken = '{{ csrf_token }}';

// File type icons mapping
const fileIcons = {
    'html': 'üìÑ',
    'htm': 'üìÑ',
    'css': 'üé®',
    'js': '‚ö°',
    'json': 'üìä',
    'md': 'üìù',
    'txt': 'üìù',
    'xml': 'üìã',
    'svg': 'üñºÔ∏è',
    'jpg': 'üñºÔ∏è',
    'jpeg': 'üñºÔ∏è',
    'png': 'üñºÔ∏è',
    'gif': 'üñºÔ∏è',
    'webp': 'üñºÔ∏è',
    'ts': 'üìò',
    'jsx': '‚öõÔ∏è',
    'tsx': '‚öõÔ∏è',
    'py': 'üêç',
    'php': 'üêò',
    'rb': 'üíé',
    'java': '‚òï',
    'default': 'üìÑ'
};

// Get file icon based on extension
function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    return fileIcons[ext] || fileIcons.default;
}

// Initialize Monaco Editor
require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
require(['vs/editor/editor.main'], function() {
    state.editor = monaco.editor.create(document.getElementById('monaco-container'), {
        value: '// Select a file to start editing\n// Use Ctrl+P to open files quickly\n// Press Ctrl+S to save\n// Click the keyboard icon in the status bar for more shortcuts',
        language: 'javascript',
        theme: 'vs-dark',
        automaticLayout: true,
        fontSize: 14,
        minimap: { enabled: true },
        scrollBeyondLastLine: false,
        lineNumbers: 'on',
        folding: true,
        wordWrap: 'on',
        formatOnPaste: true,
        formatOnType: true
    });
    
    // Listen for content changes
    state.editor.onDidChangeModelContent(() => {
        if (state.currentFile) {
            state.unsavedChanges[state.currentFile] = true;
            updateStatusBar();
            updateTabTitle(state.currentFile);
            renderFileTree(); // Update file tree to show unsaved indicator
            startAutoSave();
        }
    });
    
    // Listen for cursor position changes
    state.editor.onDidChangeCursorPosition((e) => {
        updateStatusBar();
    });
    
    // Register keyboard shortcuts
    state.editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
        saveCurrentFile();
    });
    
    // Load initial file tree
    refreshFileTree();
});

// File Tree Functions
function refreshFileTree() {
    fetch(`/crm/pages/api/${pageSlug}/upload/list/`, {
        headers: { 'X-CSRFToken': csrfToken }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            state.fileTree = data.data;
            renderFileTree();
        }
    })
    .catch(error => {
        console.error('Error loading file tree:', error);
        showToast('Error loading file tree', 'error');
    });
}

function renderFileTree() {
    const treeDiv = document.getElementById('file-tree');
    treeDiv.innerHTML = renderTreeNode(state.fileTree, 0);
}

function renderTreeNode(node, level) {
    if (!node) return '';
    
    let html = '';
    const indent = level * 12;
    
    if (node.type === 'directory') {
        const folderId = `folder-${node.path || node.name}`;
        const isCollapsed = state.collapsedFolders.has(folderId);
        const folderIcon = isCollapsed ? '‚ñ∂' : '‚ñº';
        
        html += `<div style="padding-left: ${indent}px" 
                     class="folder-item ${isCollapsed ? 'collapsed' : ''}"
                     onclick="toggleFolder('${folderId}', event)">
            <span class="folder-icon">${folderIcon}</span>
            <span>üìÅ ${node.name}/</span>
        </div>`;
        
        if (node.children) {
            const childrenHtml = node.children.map(child => renderTreeNode(child, level + 1)).join('');
            const maxHeight = isCollapsed ? '0' : `${node.children.length * 40}px`;
            html += `<div id="${folderId}-children" class="folder-children ${isCollapsed ? 'collapsed' : ''}" 
                         style="max-height: ${maxHeight}">
                ${childrenHtml}
            </div>`;
        }
    } else if (node.type === 'file') {
        const isActive = state.currentFile === node.path;
        const fileIcon = getFileIcon(node.name);
        const hasChanges = state.unsavedChanges[node.path];
        
        html += `<div style="padding-left: ${indent}px" 
                     class="file-tree-item ${isActive ? 'active' : ''}"
                     data-path="${node.path}"
                     onclick="loadFile('${node.path}')"
                     oncontextmenu="showContextMenu(event, '${node.path}')">
            <span class="file-icon">${fileIcon}</span>
            <span>${node.name}</span>
            ${hasChanges ? '<span class="text-yellow-500 ml-auto">‚óè</span>' : ''}
        </div>`;
    }
    
    return html;
}

// Toggle folder collapse/expand
function toggleFolder(folderId, event) {
    if (event) event.stopPropagation();
    
    const folderDiv = event.target.closest('.folder-item');
    const childrenDiv = document.getElementById(`${folderId}-children`);
    
    if (state.collapsedFolders.has(folderId)) {
        state.collapsedFolders.delete(folderId);
        folderDiv.classList.remove('collapsed');
        childrenDiv.classList.remove('collapsed');
        childrenDiv.style.maxHeight = `${childrenDiv.scrollHeight}px`;
    } else {
        state.collapsedFolders.add(folderId);
        folderDiv.classList.add('collapsed');
        childrenDiv.classList.add('collapsed');
        childrenDiv.style.maxHeight = '0';
    }
}

// Collapse all folders
function toggleFileTreeCollapse() {
    const allFolders = document.querySelectorAll('.folder-item');
    const shouldCollapse = state.collapsedFolders.size === 0;
    
    allFolders.forEach(folder => {
        const folderId = folder.getAttribute('onclick').match(/'([^']+)'/)[1];
        if (shouldCollapse) {
            state.collapsedFolders.add(folderId);
        } else {
            state.collapsedFolders.delete(folderId);
        }
    });
    
    renderFileTree();
}

// File Operations
function loadFile(path) {
    // Check for unsaved changes
    if (state.currentFile && state.unsavedChanges[state.currentFile]) {
        if (!confirm('You have unsaved changes. Continue without saving?')) {
            return;
        }
    }
    
    // Show loading
    showLoading(true);
    
    fetch(`/crm/pages/api/${pageSlug}/editor/file/?path=${encodeURIComponent(path)}`, {
        headers: { 'X-CSRFToken': csrfToken }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const fileData = data.data;
            state.currentFile = path;
            
            // Update editor content
            state.editor.setValue(fileData.content);
            monaco.editor.setModelLanguage(state.editor.getModel(), fileData.language);
            
            // Add to tabs
            addTab(path);
            
            // Update UI
            renderFileTree();
            updateStatusBar();
            updateBreadcrumb();
            
            // Clear unsaved flag
            delete state.unsavedChanges[path];
            
            // Start auto-save
            startAutoSave();
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error loading file:', error);
        showToast('Error loading file', 'error');
    })
    .finally(() => {
        showLoading(false);
    });
}

function saveCurrentFile(silent = false) {
    if (!state.currentFile) {
        if (!silent) showToast('No file open', 'error');
        return;
    }
    
    const content = state.editor.getValue();
    
    if (!silent) showLoading(true);
    
    fetch(`/crm/pages/api/${pageSlug}/editor/file/save/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            path: state.currentFile,
            content: content,
            create_version: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            delete state.unsavedChanges[state.currentFile];
            updateStatusBar();
            updateTabTitle(state.currentFile);
            if (!silent) showToast('File saved successfully', 'success');
            
            // Refresh preview if open
            if (!document.getElementById('preview-panel').classList.contains('hidden')) {
                refreshPreview();
            }
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error saving file:', error);
        showToast('Error saving file', 'error');
    })
    .finally(() => {
        if (!silent) showLoading(false);
    });
}

// Auto-save functionality
function startAutoSave() {
    // Clear existing timer
    if (state.autoSaveTimer) {
        clearTimeout(state.autoSaveTimer);
    }
    
    // Set new timer for 30 seconds
    state.autoSaveTimer = setTimeout(() => {
        if (state.currentFile && state.unsavedChanges[state.currentFile]) {
            saveCurrentFile(true);
            showToast('Auto-saved', 'info');
        }
    }, 30000); // 30 seconds
}

// Update breadcrumb navigation
function updateBreadcrumb() {
    const breadcrumb = document.getElementById('breadcrumb');
    
    if (!state.currentFile) {
        breadcrumb.classList.add('hidden');
        return;
    }
    
    breadcrumb.classList.remove('hidden');
    
    const parts = state.currentFile.split('/');
    let html = '<span class="breadcrumb-item" onclick="loadFile(\'\')">üìÅ Root</span>';
    
    let currentPath = '';
    parts.forEach((part, index) => {
        currentPath += (currentPath ? '/' : '') + part;
        const isLast = index === parts.length - 1;
        
        if (isLast) {
            html += `<span class="breadcrumb-separator">‚Ä∫</span>
                     <span class="breadcrumb-item active">${getFileIcon(part)} ${part}</span>`;
        } else {
            html += `<span class="breadcrumb-separator">‚Ä∫</span>
                     <span class="breadcrumb-item">${part}</span>`;
        }
    });
    
    breadcrumb.innerHTML = html;
}

// Loading state
function showLoading(show) {
    const overlay = document.getElementById('loading-overlay');
    if (show) {
        overlay.classList.remove('hidden');
    } else {
        overlay.classList.add('hidden');
    }
}

// Tab Management
function addTab(path) {
    if (!state.openTabs.includes(path)) {
        state.openTabs.push(path);
    }
    state.activeTab = path;
    renderTabs();
}

function closeTab(path, event) {
    if (event) {
        event.stopPropagation();
    }
    
    // Check for unsaved changes
    if (state.unsavedChanges[path]) {
        if (!confirm('Close without saving?')) {
            return;
        }
    }
    
    const index = state.openTabs.indexOf(path);
    if (index > -1) {
        state.openTabs.splice(index, 1);
        delete state.unsavedChanges[path];
    }
    
    // Switch to another tab or clear editor
    if (state.currentFile === path) {
        if (state.openTabs.length > 0) {
            const newTab = index > 0 ? state.openTabs[index - 1] : state.openTabs[0];
            loadFile(newTab);
        } else {
            state.currentFile = null;
            state.editor.setValue('// Select a file to start editing');
            updateStatusBar();
        }
    }
    
    renderTabs();
}

function renderTabs() {
    const tabsDiv = document.getElementById('editor-tabs');
    tabsDiv.innerHTML = state.openTabs.map(path => {
        const fileName = path.split('/').pop();
        const fileIcon = getFileIcon(fileName);
        const isActive = path === state.activeTab;
        const hasChanges = state.unsavedChanges[path];
        
        return `<div class="editor-tab ${isActive ? 'active' : ''} ${hasChanges ? 'modified' : ''}" 
                     onclick="loadFile('${path}')">
            <span class="tab-icon">${fileIcon}</span>
            <span>${fileName}</span>
            <span class="close-btn" onclick="closeTab('${path}', event)">‚úï</span>
        </div>`;
    }).join('');
}

function updateTabTitle(path) {
    renderTabs();
}

// Status Bar
function updateStatusBar() {
    const fileSpan = document.getElementById('status-file');
    const langSpan = document.getElementById('status-language');
    const posSpan = document.getElementById('status-position');
    const saveSpan = document.getElementById('status-save');
    
    if (state.currentFile) {
        fileSpan.textContent = state.currentFile;
        langSpan.textContent = state.editor.getModel().getLanguageId();
        
        const position = state.editor.getPosition();
        posSpan.textContent = `Ln ${position.lineNumber}, Col ${position.column}`;
        
        if (state.unsavedChanges[state.currentFile]) {
            saveSpan.textContent = '‚óè Modified';
            saveSpan.className = 'text-yellow-500';
        } else {
            saveSpan.textContent = '‚úì Saved';
            saveSpan.className = 'text-green-500';
        }
    } else {
        fileSpan.textContent = 'No file open';
        langSpan.textContent = '';
        posSpan.textContent = '';
        saveSpan.textContent = '';
    }
}

// Context Menu
function showContextMenu(event, path) {
    event.preventDefault();
    state.contextTarget = path;
    
    const menu = document.getElementById('context-menu');
    menu.style.left = event.pageX + 'px';
    menu.style.top = event.pageY + 'px';
    menu.classList.add('show');
    
    // Close on click outside
    setTimeout(() => {
        document.addEventListener('click', closeContextMenu);
    }, 0);
}

function closeContextMenu() {
    const menu = document.getElementById('context-menu');
    menu.classList.remove('show');
    document.removeEventListener('click', closeContextMenu);
}

function openFile() {
    if (state.contextTarget) {
        loadFile(state.contextTarget);
    }
    closeContextMenu();
}

// Dialogs
function showCreateFileDialog() {
    showModal('Create New File', `
        <label class="block text-sm text-gray-400 mb-2">File path (e.g., js/app.js)</label>
        <input type="text" id="modal-input" 
               class="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded text-white"
               placeholder="path/to/file.js">
    `, () => {
        const path = document.getElementById('modal-input').value.trim();
        if (path) {
            createFile(path);
        }
    });
}

function showCreateFolderDialog() {
    showModal('Create New Folder', `
        <label class="block text-sm text-gray-400 mb-2">Folder path (e.g., css/components)</label>
        <input type="text" id="modal-input" 
               class="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded text-white"
               placeholder="path/to/folder">
    `, () => {
        const path = document.getElementById('modal-input').value.trim();
        if (path) {
            createFolder(path);
        }
    });
}

function showRenameDialog() {
    if (!state.contextTarget) return;
    
    showModal('Rename File', `
        <label class="block text-sm text-gray-400 mb-2">New path</label>
        <input type="text" id="modal-input" 
               class="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded text-white"
               value="${state.contextTarget}">
    `, () => {
        const newPath = document.getElementById('modal-input').value.trim();
        if (newPath && newPath !== state.contextTarget) {
            renameFile(state.contextTarget, newPath);
        }
    });
    closeContextMenu();
}

function showDuplicateDialog() {
    if (!state.contextTarget) return;
    
    const baseName = state.contextTarget.replace(/\.[^/.]+$/, '');
    const ext = state.contextTarget.split('.').pop();
    const defaultName = `${baseName}_copy.${ext}`;
    
    showModal('Duplicate File', `
        <label class="block text-sm text-gray-400 mb-2">New file path</label>
        <input type="text" id="modal-input" 
               class="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded text-white"
               value="${defaultName}">
    `, () => {
        const destPath = document.getElementById('modal-input').value.trim();
        if (destPath) {
            duplicateFile(state.contextTarget, destPath);
        }
    });
    closeContextMenu();
}

function showDeleteDialog() {
    if (!state.contextTarget) return;
    
    showModal('Delete File', `
        <p class="text-gray-400">Are you sure you want to delete:</p>
        <p class="text-white font-mono mt-2">${state.contextTarget}</p>
        <p class="text-red-500 text-sm mt-2">This action cannot be undone.</p>
    `, () => {
        deleteFile(state.contextTarget);
    });
    closeContextMenu();
}

function showSearchDialog() {
    showModal('Search Files', `
        <label class="block text-sm text-gray-400 mb-2">Search query</label>
        <input type="text" id="modal-input" 
               class="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded text-white"
               placeholder="Enter search term...">
        <div class="mt-2">
            <label class="flex items-center text-sm text-gray-400">
                <input type="checkbox" id="search-content" checked class="mr-2">
                Search file contents
            </label>
        </div>
    `, () => {
        const query = document.getElementById('modal-input').value.trim();
        const searchContent = document.getElementById('search-content').checked;
        if (query) {
            searchFiles(query, searchContent);
        }
    });
}

function showModal(title, content, callback) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-content').innerHTML = content;
    document.getElementById('modal-overlay').classList.add('show');
    state.modalCallback = callback;
    
    // Focus input if exists
    setTimeout(() => {
        const input = document.getElementById('modal-input');
        if (input) input.focus();
    }, 100);
}

function closeModal() {
    document.getElementById('modal-overlay').classList.remove('show');
    state.modalCallback = null;
}

function confirmModal() {
    if (state.modalCallback) {
        state.modalCallback();
    }
    closeModal();
}

// File Operations API Calls
function createFile(path) {
    fetch(`/crm/pages/api/${pageSlug}/editor/file/create/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ path: path, content: '' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('File created successfully', 'success');
            refreshFileTree();
            loadFile(path);
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error creating file:', error);
        showToast('Error creating file', 'error');
    });
}

function createFolder(path) {
    fetch(`/crm/pages/api/${pageSlug}/editor/folder/create/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ path: path })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Folder created successfully', 'success');
            refreshFileTree();
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error creating folder:', error);
        showToast('Error creating folder', 'error');
    });
}

function renameFile(oldPath, newPath) {
    fetch(`/crm/pages/api/${pageSlug}/editor/file/rename/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ old_path: oldPath, new_path: newPath })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('File renamed successfully', 'success');
            refreshFileTree();
            
            // Update tabs if file is open
            const index = state.openTabs.indexOf(oldPath);
            if (index > -1) {
                state.openTabs[index] = newPath;
            }
            if (state.currentFile === oldPath) {
                state.currentFile = newPath;
            }
            renderTabs();
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error renaming file:', error);
        showToast('Error renaming file', 'error');
    });
}

function duplicateFile(sourcePath, destPath) {
    fetch(`/crm/pages/api/${pageSlug}/editor/file/duplicate/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ source_path: sourcePath, dest_path: destPath })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('File duplicated successfully', 'success');
            refreshFileTree();
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error duplicating file:', error);
        showToast('Error duplicating file', 'error');
    });
}

function deleteFile(path) {
    fetch(`/crm/pages/api/${pageSlug}/upload/delete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ path: path })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('File deleted successfully', 'success');
            refreshFileTree();
            
            // Close tab if open
            if (state.openTabs.includes(path)) {
                closeTab(path);
            }
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting file:', error);
        showToast('Error deleting file', 'error');
    });
}

function searchFiles(query, searchContent) {
    fetch(`/crm/pages/api/${pageSlug}/editor/search/?query=${encodeURIComponent(query)}&search_content=${searchContent}`, {
        headers: { 'X-CSRFToken': csrfToken }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Found ${data.count} results`, 'info');
            // TODO: Show results in a panel
            console.log('Search results:', data.results);
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error searching files:', error);
        showToast('Error searching files', 'error');
    });
}

// Preview Functions
function togglePreview() {
    const previewPanel = document.getElementById('preview-panel');
    previewPanel.classList.toggle('hidden');
    
    if (!previewPanel.classList.contains('hidden')) {
        refreshPreview();
    }
}

function refreshPreview() {
    const iframe = document.getElementById('preview-frame');
    iframe.src = `/p/${pageSlug}/?t=${Date.now()}`;
}

// Toast Notifications
function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    const icon = document.getElementById('toast-icon');
    const text = document.getElementById('toast-text');
    
    text.textContent = message;
    
    if (type === 'success') {
        icon.innerHTML = '<span class="text-green-500 text-2xl">‚úì</span>';
    } else if (type === 'error') {
        icon.innerHTML = '<span class="text-red-500 text-2xl">‚úï</span>';
    } else {
        icon.innerHTML = '<span class="text-blue-500 text-2xl">‚Ñπ</span>';
    }
    
    toast.classList.remove('hidden');
    
    setTimeout(() => {
        toast.classList.add('hidden');
    }, 3000);
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + P: Quick open
    if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
        e.preventDefault();
        showSearchDialog();
    }
    
    // Ctrl/Cmd + N: New file
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        showCreateFileDialog();
    }
    
    // F5: Refresh
    if (e.key === 'F5') {
        e.preventDefault();
        refreshFileTree();
    }
});

// Show keyboard shortcuts modal
function showKeyboardShortcuts() {
    document.getElementById('shortcuts-modal').classList.add('show');
}

// Hide keyboard shortcuts modal
function hideKeyboardShortcuts() {
    document.getElementById('shortcuts-modal').classList.remove('show');
}

// Prevent leaving with unsaved changes
window.addEventListener('beforeunload', (e) => {
    if (Object.keys(state.unsavedChanges).length > 0) {
        e.preventDefault();
        e.returnValue = '';
    }
});
</script>
{% endblock %}
