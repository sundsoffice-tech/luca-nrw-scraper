{% extends 'crm/base.html' %}
{% load static %}

{% block title %}Edit {{ page.title }} - TELIS CRM{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
<link rel="stylesheet" href="{% static 'pages/css/builder.css' %}">
<style>
    body { margin: 0; overflow: hidden; }
    .builder-wrapper { display: flex; flex-direction: column; height: 100vh; }
    .builder-toolbar { 
        background: #1a1a2e; 
        padding: 12px 20px; 
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        border-bottom: 2px solid #16213e;
        flex-shrink: 0;
    }
    .toolbar-left, .toolbar-right, .toolbar-center { display: flex; gap: 10px; align-items: center; }
    .toolbar-btn {
        background: #0f3460;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
        position: relative;
    }
    .toolbar-btn:hover { 
        background: #16213e; 
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
    }
    .toolbar-btn:active { 
        transform: translateY(0);
        box-shadow: 0 1px 3px rgba(0, 123, 255, 0.1);
    }
    
    /* Tooltip styles */
    .toolbar-btn[title]:hover::after {
        content: attr(title);
        position: absolute;
        bottom: -35px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 1000;
        pointer-events: none;
    }
    .toolbar-btn.primary { background: #007bff; }
    .toolbar-btn.primary:hover { background: #0056b3; }
    .toolbar-btn.success { background: #28a745; }
    .toolbar-btn.success:hover { background: #218838; }
    .device-btn {
        background: transparent;
        border: 2px solid #0f3460;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 70px;
    }
    .device-btn.active {
        background: #0f3460;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    .device-btn:hover {
        background: #0f3460;
        border-color: #007bff;
        transform: translateY(-1px);
    }
    .builder-content {
        display: flex;
        flex: 1;
        overflow: hidden;
    }
    .left-panel {
        width: 280px;
        background: #16213e;
        overflow-y: auto;
        border-right: 2px solid #0f3460;
        flex-shrink: 0;
    }
    .right-panel {
        width: 300px;
        background: #16213e;
        overflow-y: auto;
        border-left: 2px solid #0f3460;
        flex-shrink: 0;
    }
    .center-canvas {
        flex: 1;
        background: #1a1a2e;
        overflow: hidden;
        position: relative;
    }
    .panel-section {
        border-bottom: 1px solid #0f3460;
    }
    .panel-header {
        background: #0f3460;
        color: white;
        padding: 12px 15px;
        font-weight: 600;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .panel-content {
        padding: 15px;
    }
    /* Device Mode Indicator */
    .device-indicator {
        background: #007bff;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        text-align: center;
        margin: 10px 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    .device-indicator.tablet {
        background: #17a2b8;
    }
    .device-indicator.mobile {
        background: #28a745;
    }
    .gjs-block {
        background: #0f3460;
        border: 1px solid #16213e;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 10px;
        cursor: move;
        transition: all 0.2s;
        color: white;
        text-align: center;
        position: relative;
    }
    .gjs-block:hover {
        background: #16213e;
        border-color: #007bff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,123,255,0.3);
    }
    .gjs-block:active {
        cursor: grabbing;
        transform: scale(0.98);
    }
    
    /* Block dragging visual feedback */
    .gjs-block.dragging {
        opacity: 0.7;
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(0,123,255,0.4);
    }
    #gjs {
        height: 100%;
        width: 100%;
    }
    .page-info {
        color: #adb5bd;
        font-size: 13px;
    }
    .asset-upload-zone {
        border: 2px dashed #0f3460;
        padding: 30px;
        text-align: center;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        background: rgba(15, 52, 96, 0.2);
    }
    .asset-upload-zone:hover {
        border-color: #007bff;
        background: rgba(0, 123, 255, 0.1);
    }
    .asset-upload-zone p {
        color: #adb5bd;
        margin: 10px 0 0 0;
        font-size: 14px;
    }
    
    /* Loading Indicator */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }
    .loading-spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-top-color: #007bff;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* GrapesJS Customization */
    .gjs-cv-canvas { 
        background-color: #fff;
        transition: background-color 0.3s;
    }
    .gjs-cv-canvas.drag-over {
        background-color: #f0f8ff !important;
        outline: 3px dashed #007bff !important;
        outline-offset: -10px;
    }
    .gjs-block-category { background: #0f3460; }
    .gjs-title { color: white; }
    
    /* Toast Notification Styles */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        font-size: 14px;
        z-index: 10000;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        animation: slideIn 0.3s ease;
        transition: opacity 0.3s ease;
    }
    .notification.success { background: #28a745; }
    .notification.error { background: #dc3545; }
    .notification.info { background: #17a2b8; }
    .notification.warning { background: #ffc107; color: #212529; }
    
    /* Code Editor Styles */
    #code-editor-container {
        display: none;
        flex-direction: column;
        height: 100%;
        background: #1e1e1e;
    }
    #code-editor-container.active {
        display: flex;
    }
    .code-editor-tabs {
        display: flex;
        background: #252526;
        border-bottom: 1px solid #3e3e42;
        padding: 0 10px;
    }
    .code-tab {
        padding: 10px 20px;
        background: transparent;
        border: none;
        color: #969696;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
    }
    .code-tab:hover {
        color: #ffffff;
        background: rgba(255, 255, 255, 0.05);
    }
    .code-tab.active {
        color: #ffffff;
        border-bottom-color: #007bff;
    }
    .code-editor-pane {
        flex: 1;
        display: none;
        overflow: auto;
    }
    .code-editor-pane.active {
        display: block;
    }
    .code-textarea {
        width: 100%;
        height: 100%;
        background: #1e1e1e;
        color: #d4d4d4;
        border: none;
        padding: 15px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.6;
        resize: none;
        outline: none;
    }
    .code-textarea:focus {
        outline: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="builder-wrapper">
    <!-- Top Toolbar -->
    <div class="builder-toolbar">
        <div class="toolbar-left">
            <button class="toolbar-btn" onclick="saveContent()" title="Save your changes">
                üíæ <span>Save</span>
            </button>
            <button class="toolbar-btn" onclick="undoAction()" title="Undo last change (Ctrl+Z)">
                ‚Ü∂ <span>Undo</span>
            </button>
            <button class="toolbar-btn" onclick="redoAction()" title="Redo last undone change (Ctrl+Y)">
                ‚Ü∑ <span>Redo</span>
            </button>
            <button class="toolbar-btn" onclick="clearCanvas()" title="Clear all content">
                üóëÔ∏è <span>Clear</span>
            </button>
        </div>
        
        <div class="toolbar-center">
            <span class="page-info">{{ page.title }}</span>
            <span class="page-info" style="color: #6c757d; margin-left: 10px;">/p/{{ page.slug }}/</span>
            <div style="display: flex; gap: 8px; margin-left: 20px; align-items: center;">
                <span style="color: #adb5bd; font-size: 12px; margin-right: 5px;">Preview:</span>
                <button class="device-btn active" id="btn-desktop" onclick="setDevice('Desktop', this)" title="Desktop view (default)">
                    <span style="font-size: 20px;">üñ•Ô∏è</span>
                    <span style="font-size: 11px; display: block; margin-top: 2px;">Desktop</span>
                </button>
                <button class="device-btn" id="btn-tablet" onclick="setDevice('Tablet', this)" title="Tablet view (768px)">
                    <span style="font-size: 20px;">üíª</span>
                    <span style="font-size: 11px; display: block; margin-top: 2px;">Tablet</span>
                </button>
                <button class="device-btn" id="btn-mobile" onclick="setDevice('Mobile', this)" title="Mobile view (375px)">
                    <span style="font-size: 20px;">üì±</span>
                    <span style="font-size: 11px; display: block; margin-top: 2px;">Mobile</span>
                </button>
            </div>
        </div>
        
        <div class="toolbar-right">
            <button class="toolbar-btn" id="mode-toggle-btn" onclick="toggleEditorMode()" title="Switch between visual and code editor">
                üìù <span id="mode-toggle-text">Code Mode</span>
            </button>
            <button class="toolbar-btn" onclick="editor.runCommand('preview')" title="Preview your page">
                üëÅÔ∏è <span>Preview</span>
            </button>
            <button class="toolbar-btn" onclick="showHelpGuide()" title="Show help guide">
                ‚ùì <span>Help</span>
            </button>
            <button class="toolbar-btn success" onclick="publishPage()" title="Publish page to make it live">
                üöÄ <span>Publish</span>
            </button>
            <a href="{% url 'pages:builder-list' %}" class="toolbar-btn" title="Return to pages list">
                ‚Üê <span>Back</span>
            </a>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="builder-content">
        <!-- Left Panel: Blocks & Assets -->
        <div class="left-panel">
            <!-- Blocks Section -->
            <div class="panel-section">
                <div class="panel-header" onclick="togglePanel('blocks-panel')">
                    <div>
                        <div style="font-size: 16px;">üì¶ BLOCKS</div>
                        <div style="font-size: 10px; text-transform: none; opacity: 0.7; margin-top: 2px;">Drag elements onto your page</div>
                    </div>
                    <span id="blocks-toggle">‚ñº</span>
                </div>
                <div id="blocks-panel" class="panel-content">
                    <div id="blocks-container"></div>
                </div>
            </div>
            
            <!-- Asset Manager Section -->
            <div class="panel-section">
                <div class="panel-header" onclick="togglePanel('assets-panel')">
                    <div>
                        <div style="font-size: 16px;">üñºÔ∏è ASSETS</div>
                        <div style="font-size: 10px; text-transform: none; opacity: 0.7; margin-top: 2px;">Upload and manage images</div>
                    </div>
                    <span id="assets-toggle">‚ñº</span>
                </div>
                <div id="assets-panel" class="panel-content">
                    <div class="asset-upload-zone" onclick="document.getElementById('asset-upload-input').click()">
                        <div style="font-size: 40px; margin-bottom: 10px;">üì§</div>
                        <p style="font-weight: 600; margin-bottom: 5px;">Upload Images</p>
                        <p style="font-size: 12px;">Click or drag files here</p>
                        <input type="file" id="asset-upload-input" style="display: none;" accept="image/*" multiple onchange="uploadAssets(this.files)">
                    </div>
                    <div id="assets-container" style="margin-top: 15px;"></div>
                </div>
            </div>
        </div>

        <!-- Center: Canvas -->
        <div class="center-canvas">
            <div id="gjs"></div>
            
            <!-- Code Editor Mode -->
            <div id="code-editor-container">
                <div class="code-editor-tabs">
                    <button class="code-tab active" onclick="switchCodeTab('html', event)">HTML</button>
                    <button class="code-tab" onclick="switchCodeTab('css', event)">CSS</button>
                    <button class="code-tab" onclick="switchCodeTab('json', event)">Components (JSON)</button>
                </div>
                <div id="html-editor" class="code-editor-pane active">
                    <textarea id="html-code" class="code-textarea" placeholder="HTML code will appear here..."></textarea>
                </div>
                <div id="css-editor" class="code-editor-pane">
                    <textarea id="css-code" class="code-textarea" placeholder="CSS code will appear here..."></textarea>
                </div>
                <div id="json-editor" class="code-editor-pane">
                    <textarea id="json-code" class="code-textarea" placeholder="GrapesJS component JSON will appear here..."></textarea>
                </div>
            </div>
        </div>

        <!-- Right Panel: Styles & Layers -->
        <div class="right-panel">
            <!-- Device Mode Indicator -->
            <div id="device-mode-indicator" class="device-indicator">
                üñ•Ô∏è Editing: Desktop View
            </div>
            
            <!-- Style Manager Section -->
            <div class="panel-section">
                <div class="panel-header" onclick="togglePanel('styles-panel')">
                    <div>
                        <div style="font-size: 16px;">üé® STYLES</div>
                        <div style="font-size: 10px; text-transform: none; opacity: 0.7; margin-top: 2px;">Customize selected element</div>
                    </div>
                    <span id="styles-toggle">‚ñº</span>
                </div>
                <div id="styles-panel" class="panel-content">
                    <div id="styles-container"></div>
                </div>
            </div>
            
            <!-- Layer Manager Section -->
            <div class="panel-section">
                <div class="panel-header" onclick="togglePanel('layers-panel')">
                    <div>
                        <div style="font-size: 16px;">üìã LAYERS</div>
                        <div style="font-size: 10px; text-transform: none; opacity: 0.7; margin-top: 2px;">View page structure</div>
                    </div>
                    <span id="layers-toggle">‚ñº</span>
                </div>
                <div id="layers-panel" class="panel-content">
                    <div id="layers-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/grapesjs"></script>
<script src="{% static 'pages/js/grapesjs-blocks-bundle.js' %}"></script>
<script>
    // Note: Responsive CSS is handled automatically by GrapesJS via the mediaQuery property
    // on style properties. When properties have mediaQuery: 'tablet' or 'mobile', GrapesJS
    // uses the deviceManager configuration and mediaCondition setting to generate appropriate
    // CSS media queries (e.g., @media (max-width: 992px)) during CSS export.
    // Configuration constants
    const MAX_FILE_SIZE_MB = 10;
    const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;
    const WELCOME_GUIDE_DELAY_MS = 2000; // Increased from 1000ms for better accessibility
    const AUTO_SAVE_INTERVAL_MS = 60000;
    
    // Initialize GrapesJS Editor
    window.editor = grapesjs.init({
        container: '#gjs',
        height: '100%',
        width: 'auto',
        storageManager: false,
        canvas: {
            styles: [
                'https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Open+Sans:wght@400;600;700&display=swap',
                '{% url "pages:brand_css" %}', // Brand CSS variables
            ]
        },
        // Media query configuration for responsive editing
        mediaCondition: 'max-width',
        blockManager: {
            appendTo: '#blocks-container',
        },
        styleManager: {
            appendTo: '#styles-container',
            sectors: [
                {
                    name: 'Colors',
                    open: false,
                    properties: [
                        'color',
                        'background-color',
                        'border-color',
                    ]
                },
                {
                    name: 'Layout',
                    open: false,
                    properties: [
                        'width',
                        'height',
                        'max-width',
                        'min-height',
                        'margin',
                        'padding',
                        'display',
                        'flex-direction',
                        'justify-content',
                        'align-items',
                        'gap',
                    ]
                },
                {
                    name: 'Typography',
                    open: false,
                    properties: [
                        'font-family',
                        'font-size',
                        'font-weight',
                        'line-height',
                        'text-align',
                        'letter-spacing',
                    ]
                },
                {
                    name: 'Responsive Typography',
                    open: false,
                    buildProps: ['font-size', 'line-height'],
                    properties: [
                        {
                            property: 'font-size',
                            label: 'Font Size (Desktop)',
                            type: 'select',
                            defaults: '16px',
                            options: [
                                { value: '12px', name: '12px' },
                                { value: '14px', name: '14px' },
                                { value: '16px', name: '16px' },
                                { value: '18px', name: '18px' },
                                { value: '20px', name: '20px' },
                                { value: '24px', name: '24px' },
                                { value: '28px', name: '28px' },
                                { value: '32px', name: '32px' },
                                { value: '36px', name: '36px' },
                                { value: '48px', name: '48px' },
                            ]
                        },
                        {
                            id: 'font-size-tablet',
                            property: 'font-size',
                            label: 'Font Size (Tablet)',
                            type: 'select',
                            // toRequire: 1 specifies that at least 1 sub-property must have a value
                            // for the composite property to be considered valid in GrapesJS
                            toRequire: 1,
                            defaults: '',
                            options: [
                                { value: '', name: 'Inherit' },
                                { value: '12px', name: '12px' },
                                { value: '14px', name: '14px' },
                                { value: '16px', name: '16px' },
                                { value: '18px', name: '18px' },
                                { value: '20px', name: '20px' },
                                { value: '24px', name: '24px' },
                                { value: '28px', name: '28px' },
                                { value: '32px', name: '32px' },
                            ],
                            mediaQuery: 'tablet'
                        },
                        {
                            id: 'font-size-mobile',
                            property: 'font-size',
                            label: 'Font Size (Mobile)',
                            type: 'select',
                            toRequire: 1,
                            defaults: '',
                            options: [
                                { value: '', name: 'Inherit' },
                                { value: '12px', name: '12px' },
                                { value: '14px', name: '14px' },
                                { value: '16px', name: '16px' },
                                { value: '18px', name: '18px' },
                                { value: '20px', name: '20px' },
                                { value: '24px', name: '24px' },
                            ],
                            mediaQuery: 'mobile'
                        },
                        {
                            id: 'line-height-tablet',
                            property: 'line-height',
                            label: 'Line Height (Tablet)',
                            type: 'select',
                            defaults: '',
                            options: [
                                { value: '', name: 'Inherit' },
                                { value: '1', name: '1' },
                                { value: '1.2', name: '1.2' },
                                { value: '1.4', name: '1.4' },
                                { value: '1.6', name: '1.6' },
                                { value: '1.8', name: '1.8' },
                                { value: '2', name: '2' },
                            ],
                            mediaQuery: 'tablet'
                        },
                        {
                            id: 'line-height-mobile',
                            property: 'line-height',
                            label: 'Line Height (Mobile)',
                            type: 'select',
                            defaults: '',
                            options: [
                                { value: '', name: 'Inherit' },
                                { value: '1', name: '1' },
                                { value: '1.2', name: '1.2' },
                                { value: '1.4', name: '1.4' },
                                { value: '1.6', name: '1.6' },
                                { value: '1.8', name: '1.8' },
                                { value: '2', name: '2' },
                            ],
                            mediaQuery: 'mobile'
                        },
                    ]
                },
                {
                    name: 'Responsive Spacing',
                    open: false,
                    buildProps: ['margin', 'padding'],
                    properties: [
                        {
                            id: 'margin-tablet',
                            property: 'margin',
                            label: 'Margin (Tablet)',
                            type: 'composite',
                            defaults: '',
                            mediaQuery: 'tablet'
                        },
                        {
                            id: 'margin-mobile',
                            property: 'margin',
                            label: 'Margin (Mobile)',
                            type: 'composite',
                            defaults: '',
                            mediaQuery: 'mobile'
                        },
                        {
                            id: 'padding-tablet',
                            property: 'padding',
                            label: 'Padding (Tablet)',
                            type: 'composite',
                            defaults: '',
                            mediaQuery: 'tablet'
                        },
                        {
                            id: 'padding-mobile',
                            property: 'padding',
                            label: 'Padding (Mobile)',
                            type: 'composite',
                            defaults: '',
                            mediaQuery: 'mobile'
                        },
                    ]
                },
                {
                    name: 'Responsive Visibility',
                    open: false,
                    properties: [
                        {
                            id: 'display-desktop',
                            property: 'display',
                            label: 'Display (Desktop)',
                            type: 'select',
                            defaults: '',
                            options: [
                                { value: '', name: 'Default' },
                                { value: 'block', name: 'Block' },
                                { value: 'inline-block', name: 'Inline Block' },
                                { value: 'flex', name: 'Flex' },
                                { value: 'inline-flex', name: 'Inline Flex' },
                                { value: 'grid', name: 'Grid' },
                                { value: 'none', name: 'Hidden' },
                            ]
                        },
                        {
                            id: 'display-tablet',
                            property: 'display',
                            label: 'Display (Tablet)',
                            type: 'select',
                            defaults: '',
                            options: [
                                { value: '', name: 'Inherit' },
                                { value: 'block', name: 'Block' },
                                { value: 'inline-block', name: 'Inline Block' },
                                { value: 'flex', name: 'Flex' },
                                { value: 'inline-flex', name: 'Inline Flex' },
                                { value: 'grid', name: 'Grid' },
                                { value: 'none', name: 'Hidden' },
                            ],
                            mediaQuery: 'tablet'
                        },
                        {
                            id: 'display-mobile',
                            property: 'display',
                            label: 'Display (Mobile)',
                            type: 'select',
                            defaults: '',
                            options: [
                                { value: '', name: 'Inherit' },
                                { value: 'block', name: 'Block' },
                                { value: 'inline-block', name: 'Inline Block' },
                                { value: 'flex', name: 'Flex' },
                                { value: 'inline-flex', name: 'Inline Flex' },
                                { value: 'grid', name: 'Grid' },
                                { value: 'none', name: 'Hidden' },
                            ],
                            mediaQuery: 'mobile'
                        },
                    ]
                },
                {
                    name: 'Decorations',
                    open: false,
                    properties: [
                        'border-radius',
                        'border',
                        'box-shadow',
                        'opacity',
                        'overflow',
                    ]
                },
            ]
        },
        layerManager: {
            appendTo: '#layers-container'
        },
        assetManager: {
            upload: '{% url "pages:upload-asset" %}',
            uploadName: 'file',
            assets: [],
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        },
        deviceManager: {
            devices: [
                { 
                    name: 'Desktop', 
                    width: '',
                    id: 'desktop'
                },
                { 
                    name: 'Tablet', 
                    width: '768px', 
                    widthMedia: '992px',
                    id: 'tablet'
                },
                { 
                    name: 'Mobile', 
                    width: '375px', 
                    widthMedia: '480px',
                    id: 'mobile'
                },
            ]
        },
    });

    // Load custom blocks (now from global function)
    if (typeof loadAllBlocks === 'function') {
        loadAllBlocks(window.editor);
    } else {
        console.error('‚ùå loadAllBlocks function not found!');
    }

    // Load existing page content
    fetch('{% url "pages:builder-load" page.slug %}')
        .then(response => response.json())
        .then(data => {
            if (data.html_json && Object.keys(data.html_json).length > 0) {
                window.editor.setComponents(data.html_json);
                window.editor.setStyle(data.css);
            }
        })
        .catch(error => console.error('Error loading page:', error));

    // Load assets
    loadAssets();
    
    // Show welcome guide for first-time users (with accessible delay)
    if (!localStorage.getItem('builder_guide_seen')) {
        setTimeout(() => {
            showWelcomeGuide();
        }, WELCOME_GUIDE_DELAY_MS);
    }

    // Auto-save every 60 seconds
    setInterval(() => {
        saveContent(false);
    }, AUTO_SAVE_INTERVAL_MS);

    // Save on Ctrl+S
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            saveContent(true);
        }
    });
    
    // Enhanced drag feedback for GrapesJS
    window.editor.on('block:drag:start', (block) => {
        showToast('Drag to canvas to add ' + (block.get('label') || 'element'), 'info');
    });
    
    window.editor.on('block:drag:stop', (component) => {
        if (component) {
            showToast('Element added! Click to edit.', 'success');
        }
    });
    
    window.editor.on('component:selected', () => {
        const rightPanel = document.querySelector('.right-panel');
        if (rightPanel) {
            rightPanel.style.border = '2px solid #007bff';
            setTimeout(() => {
                rightPanel.style.border = '2px solid #0f3460';
            }, 1000);
        }
    });
</script>

<script>
    function togglePanel(panelId) {
        const panel = document.getElementById(panelId);
        const toggle = document.getElementById(panelId.replace('-panel', '-toggle'));
        
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            toggle.textContent = '‚ñº';
            // Smooth expand animation
            panel.style.maxHeight = '0';
            panel.style.overflow = 'hidden';
            requestAnimationFrame(() => {
                panel.style.transition = 'max-height 0.3s ease-out';
                panel.style.maxHeight = '2000px';
            });
        } else {
            toggle.textContent = '‚ñ∫';
            // Smooth collapse animation
            panel.style.transition = 'max-height 0.3s ease-out';
            panel.style.maxHeight = '0';
            setTimeout(() => {
                panel.style.display = 'none';
                panel.style.maxHeight = '';
                panel.style.overflow = '';
            }, 300);
        }
    }

    function setDevice(deviceName, btn) {
        // Update active state
        document.querySelectorAll('.device-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Set device in editor
        window.editor.setDevice(deviceName);
        
        // Update device indicator
        const indicator = document.getElementById('device-mode-indicator');
        if (indicator) {
            const icons = {
                'Desktop': 'üñ•Ô∏è',
                'Tablet': 'üíª',
                'Mobile': 'üì±'
            };
            const classes = {
                'Desktop': '',
                'Tablet': 'tablet',
                'Mobile': 'mobile'
            };
            
            indicator.textContent = `${icons[deviceName]} Editing: ${deviceName} View`;
            indicator.className = 'device-indicator ' + (classes[deviceName] || '');
        }
        // Show feedback
        showToast(`Preview mode: ${deviceName}`, 'info');
    }
    
    function undoAction() {
        window.editor.runCommand('core:undo');
        showToast('Undone', 'info');
    }
    
    function redoAction() {
        window.editor.runCommand('core:redo');
        showToast('Redone', 'info');
    }
    
    function clearCanvas() {
        if (confirm('Are you sure you want to clear all content? This cannot be undone.')) {
            window.editor.setComponents('');
            window.editor.setStyle('');
            showToast('Canvas cleared', 'info');
        }
    }
    
    function showHelpGuide() {
        const helpContent = `
            <div style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <h2 style="margin-top: 0; color: #007bff;">üéØ Page Builder Quick Guide</h2>
                
                <div style="margin: 20px 0;">
                    <h3>üì¶ Getting Started</h3>
                    <ul style="line-height: 1.8;">
                        <li><strong>Drag & Drop:</strong> Drag any block from the left panel onto your canvas</li>
                        <li><strong>Click to Edit:</strong> Click any element to select it and see styling options on the right</li>
                        <li><strong>Double-click Text:</strong> Double-click text to edit it directly</li>
                    </ul>
                </div>
                
                <div style="margin: 20px 0;">
                    <h3>‚å®Ô∏è Keyboard Shortcuts</h3>
                    <ul style="line-height: 1.8;">
                        <li><strong>Ctrl+S:</strong> Save your page</li>
                        <li><strong>Ctrl+Z:</strong> Undo last action</li>
                        <li><strong>Ctrl+Y:</strong> Redo last undone action</li>
                        <li><strong>Delete:</strong> Remove selected element</li>
                    </ul>
                </div>
                
                <div style="margin: 20px 0;">
                    <h3>üñºÔ∏è Working with Images</h3>
                    <ul style="line-height: 1.8;">
                        <li>Upload images in the Assets panel (left side, bottom)</li>
                        <li>Click an uploaded asset to copy its URL</li>
                        <li>Select an image element and paste the URL in the right panel</li>
                        <li>Or drag the Image block and edit its source URL</li>
                    </ul>
                </div>
                
                <div style="margin: 20px 0;">
                    <h3>üì± Responsive Design</h3>
                    <ul style="line-height: 1.8;">
                        <li>Use the device buttons (Desktop/Tablet/Mobile) to preview different screen sizes</li>
                        <li>Adjust layouts and text sizes for better mobile experience</li>
                        <li>Elements automatically stack on smaller screens</li>
                    </ul>
                </div>
                
                <div style="margin: 20px 0;">
                    <h3>üí° Pro Tips</h3>
                    <ul style="line-height: 1.8;">
                        <li><strong>Use Pre-built Sections:</strong> LUCA Custom blocks include ready-made sections like Hero, Pricing, FAQ</li>
                        <li><strong>Save Often:</strong> The page auto-saves every 60 seconds, but save manually for peace of mind</li>
                        <li><strong>Preview Before Publishing:</strong> Click Preview to see your page as visitors will see it</li>
                        <li><strong>Layers Panel:</strong> Use the Layers panel to navigate complex page structures</li>
                    </ul>
                </div>
                
                <div style="margin: 20px 0; padding: 15px; background: #f0f8ff; border-left: 4px solid #007bff; border-radius: 4px;">
                    <strong>Need More Help?</strong><br>
                    Check the documentation or contact support for assistance.
                </div>
            </div>
        `;
        
        showModal('Help Guide', helpContent);
    }
    
    function showModal(title, content) {
        const modal = document.createElement('div');
        modal.setAttribute('role', 'dialog');
        modal.setAttribute('aria-modal', 'true');
        modal.setAttribute('aria-labelledby', 'modal-title');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            padding: 20px;
        `;
        
        modal.innerHTML = `
            <div style="background: white; border-radius: 12px; padding: 30px; position: relative; max-width: 700px; width: 100%;">
                <button onclick="this.closest('div').parentElement.remove()" 
                        aria-label="Close dialog"
                        style="position: absolute; top: 15px; right: 15px; background: #f8f9fa; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px; line-height: 1;">‚úï</button>
                ${content}
                <div style="margin-top: 20px; text-align: right;">
                    <button onclick="this.closest('div').parentElement.remove()" 
                            style="background: #007bff; color: white; border: none; padding: 10px 24px; border-radius: 6px; cursor: pointer; font-weight: 600;">Got it!</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Close on background click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
        
        // Close on Escape key
        const handleEscape = (e) => {
            if (e.key === 'Escape') {
                modal.remove();
                document.removeEventListener('keydown', handleEscape);
            }
        };
        document.addEventListener('keydown', handleEscape);
    }
    
    function showWelcomeGuide() {
        const welcomeContent = `
            <div style="text-align: center; max-width: 500px;">
                <div style="font-size: 60px; margin-bottom: 20px;">üé®</div>
                <h2 style="margin-top: 0; color: #007bff;">Welcome to the Page Builder!</h2>
                
                <div style="text-align: left; margin: 30px 0;">
                    <div style="display: flex; align-items: start; margin-bottom: 20px;">
                        <div style="font-size: 32px; margin-right: 15px;">1Ô∏è‚É£</div>
                        <div>
                            <strong style="display: block; margin-bottom: 5px;">Drag Blocks</strong>
                            <span style="color: #6c757d;">Drag elements from the left panel onto your canvas</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: start; margin-bottom: 20px;">
                        <div style="font-size: 32px; margin-right: 15px;">2Ô∏è‚É£</div>
                        <div>
                            <strong style="display: block; margin-bottom: 5px;">Click to Edit</strong>
                            <span style="color: #6c757d;">Click any element to customize it in the right panel</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: start; margin-bottom: 20px;">
                        <div style="font-size: 32px; margin-right: 15px;">3Ô∏è‚É£</div>
                        <div>
                            <strong style="display: block; margin-bottom: 5px;">Save & Publish</strong>
                            <span style="color: #6c757d;">Save your work and click Publish when ready</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding: 15px; background: #f0f8ff; border-radius: 8px;">
                    <strong>üí° Tip:</strong> Use pre-built LUCA Custom sections for professional layouts in seconds!
                </div>
            </div>
        `;
        
        showModal('', welcomeContent);
        localStorage.setItem('builder_guide_seen', 'true');
    }

    function saveContent(showNotification = true) {
        // If in code mode, sync to visual first
        if (currentEditorMode === 'code') {
            syncCodeToVisual();
        }
        
        const html = window.editor.getHtml();
        const css = window.editor.getCss();
        const components = window.editor.getComponents();

        const data = {
            html: html,
            css: css,
            html_json: components,
            note: 'Builder save'
        };

        fetch('{% url "pages:builder-save" page.slug %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && showNotification) {
                showToast('Page saved successfully!', 'success');
            }
        })
        .catch(error => {
            console.error('Error saving:', error);
            if (showNotification) {
                showToast('Error saving page', 'error');
            }
        });
    }

    function publishPage() {
        if (confirm('Publish this page? It will be visible to the public.')) {
            // First save the content
            saveContent(false);
            
            // Then publish
            fetch(`/crm/pages/api/{{ page.slug }}/publish/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ publish: true })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    if (data.public_url) {
                        setTimeout(() => {
                            if (confirm('Page published! Do you want to view it?')) {
                                window.open(data.public_url, '_blank');
                            }
                        }, 500);
                    }
                } else {
                    showToast(data.error || 'Failed to publish page', 'error');
                }
            })
            .catch(error => {
                console.error('Error publishing page:', error);
                showToast('Error publishing page', 'error');
            });
        }
    }

    function uploadAssets(files) {
        if (!files || files.length === 0) return;

        const fileCount = files.length;
        let uploadedCount = 0;
        
        showToast(`Uploading ${fileCount} file(s)...`, 'info');

        Array.from(files).forEach(file => {
            // Check file size (configurable limit)
            if (file.size > MAX_FILE_SIZE_BYTES) {
                showToast(`File too large: ${file.name} (max ${MAX_FILE_SIZE_MB}MB)`, 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);

            fetch('{% url "pages:upload-asset" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                uploadedCount++;
                if (data.success) {
                    loadAssets();
                    showToast(`‚úì Uploaded: ${data.asset.filename} (${uploadedCount}/${fileCount})`, 'success');
                } else {
                    showToast(data.error || 'Error uploading ' + file.name, 'error');
                }
            })
            .catch(error => {
                console.error('Error uploading asset:', error);
                showToast('Error uploading ' + file.name, 'error');
            });
        });
    }

    function loadAssets() {
        fetch('{% url "pages:list-assets" %}')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('assets-container');
                container.innerHTML = '';
                
                if (data.data && data.data.length > 0) {
                    data.data.forEach(asset => {
                        const assetEl = document.createElement('div');
                        assetEl.style.cssText = 'margin-bottom: 10px; cursor: grab; border: 1px solid #0f3460; border-radius: 4px; overflow: hidden; transition: all 0.2s;';
                        assetEl.className = 'asset-item';
                        assetEl.draggable = true;
                        assetEl.innerHTML = `
                            <img src="${asset.src}" alt="${asset.name}" style="width: 100%; height: auto; display: block;">
                            <div style="padding: 8px; background: #0f3460; color: white; font-size: 12px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">
                                ${asset.name}
                            </div>
                        `;
                        
                        // Drag to insert
                        assetEl.ondragstart = (e) => {
                            e.dataTransfer.setData('text/html', `<img src="${asset.src}" alt="${asset.name}" style="max-width: 100%; height: auto;">`);
                            assetEl.style.opacity = '0.5';
                            showToast('Drag image to canvas', 'info');
                        };
                        
                        assetEl.ondragend = () => {
                            assetEl.style.opacity = '1';
                        };
                        
                        // Click to copy URL
                        assetEl.onclick = () => {
                            navigator.clipboard.writeText(asset.src);
                            showToast('Image URL copied! Select an image element and paste.', 'success');
                        };
                        
                        // Hover effect
                        assetEl.onmouseenter = () => {
                            assetEl.style.borderColor = '#007bff';
                            assetEl.style.transform = 'scale(1.02)';
                        };
                        assetEl.onmouseleave = () => {
                            assetEl.style.borderColor = '#0f3460';
                            assetEl.style.transform = 'scale(1)';
                        };
                        
                        container.appendChild(assetEl);
                    });
                } else {
                    container.innerHTML = '<p style="color: #6c757d; font-size: 13px; text-align: center;">No assets uploaded yet<br><br>Upload images to use them in your page</p>';
                }
            })
            .catch(error => console.error('Error loading assets:', error));
    }
    
    // Drag & Drop for Asset Upload with enhanced feedback
    const uploadZone = document.querySelector('.asset-upload-zone');
    
    if (uploadZone) {
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.style.borderColor = '#007bff';
            uploadZone.style.background = 'rgba(0, 123, 255, 0.15)';
            uploadZone.style.transform = 'scale(1.02)';
        });

        uploadZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.style.borderColor = '#0f3460';
            uploadZone.style.background = 'rgba(15, 52, 96, 0.2)';
            uploadZone.style.transform = 'scale(1)';
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.style.borderColor = '#28a745';
            uploadZone.style.background = 'rgba(40, 167, 69, 0.1)';
            uploadZone.style.transform = 'scale(1)';
            
            // Reset style after a moment
            setTimeout(() => {
                uploadZone.style.borderColor = '#0f3460';
                uploadZone.style.background = 'rgba(15, 52, 96, 0.2)';
            }, 500);
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // Filter only image files
                const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
                if (imageFiles.length > 0) {
                    uploadAssets(imageFiles);
                } else {
                    showToast('Please upload image files only', 'warning');
                }
            }
        });
    }
    
    // Toast notification system
    // Toast notification system
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = 'notification ' + type;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                // Safely remove toast if it's still in the DOM
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }
    
    // Editor Mode Toggle Functions
    let currentEditorMode = 'visual'; // 'visual' or 'code'
    
    function toggleEditorMode() {
        const gjsContainer = document.getElementById('gjs');
        const codeEditorContainer = document.getElementById('code-editor-container');
        const modeToggleBtn = document.getElementById('mode-toggle-text');
        const leftPanel = document.querySelector('.left-panel');
        const rightPanel = document.querySelector('.right-panel');
        
        if (currentEditorMode === 'visual') {
            // Switch to code mode
            currentEditorMode = 'code';
            
            // Sync content from GrapesJS to code editors
            syncVisualToCode();
            
            // Hide visual editor, show code editor
            gjsContainer.style.display = 'none';
            codeEditorContainer.classList.add('active');
            
            // Hide side panels in code mode
            if (leftPanel) leftPanel.style.display = 'none';
            if (rightPanel) rightPanel.style.display = 'none';
            
            // Update button
            modeToggleBtn.textContent = 'Visual Mode';
            document.getElementById('mode-toggle-btn').style.background = '#28a745';
            
            showToast('Switched to Code Editor mode', 'info');
        } else {
            // Switch to visual mode
            currentEditorMode = 'visual';
            
            // Sync content from code editors to GrapesJS
            syncCodeToVisual();
            
            // Show visual editor, hide code editor
            gjsContainer.style.display = 'block';
            codeEditorContainer.classList.remove('active');
            
            // Show side panels in visual mode
            if (leftPanel) leftPanel.style.display = 'block';
            if (rightPanel) rightPanel.style.display = 'block';
            
            // Update button
            modeToggleBtn.textContent = 'Code Mode';
            document.getElementById('mode-toggle-btn').style.background = '#0f3460';
            
            showToast('Switched to Visual Builder mode', 'info');
        }
    }
    
    function syncVisualToCode() {
        // Get content from GrapesJS
        const html = window.editor.getHtml();
        const css = window.editor.getCss();
        const components = window.editor.getComponents();
        
        // Update code editors
        document.getElementById('html-code').value = html;
        document.getElementById('css-code').value = css;
        document.getElementById('json-code').value = JSON.stringify(components, null, 2);
    }
    
    function syncCodeToVisual() {
        try {
            // Get content from code editors
            const html = document.getElementById('html-code').value;
            const css = document.getElementById('css-code').value;
            const jsonCode = document.getElementById('json-code').value;
            
            // Update CSS first
            if (css) {
                window.editor.setStyle(css);
            }
            
            // Try to parse and set JSON components if valid, otherwise use HTML
            if (jsonCode && jsonCode.trim()) {
                try {
                    const components = JSON.parse(jsonCode);
                    window.editor.setComponents(components);
                } catch (e) {
                    console.warn('Could not parse JSON components, using HTML instead:', e);
                    if (html) {
                        window.editor.setComponents(html);
                    }
                }
            } else if (html) {
                // If no JSON, use HTML
                window.editor.setComponents(html);
            }
            
            showToast('Code synced to visual editor', 'success');
        } catch (error) {
            console.error('Error syncing code to visual:', error);
            showToast('Error syncing code. Check console for details.', 'error');
        }
    }
    
    function switchCodeTab(tab, clickEvent) {
        // Update tab buttons
        document.querySelectorAll('.code-tab').forEach(btn => btn.classList.remove('active'));
        if (clickEvent && clickEvent.target) {
            clickEvent.target.classList.add('active');
        }
        
        // Update editor panes
        document.querySelectorAll('.code-editor-pane').forEach(pane => pane.classList.remove('active'));
        document.getElementById(tab + '-editor').classList.add('active');
    }

</script>
{% endblock %}
