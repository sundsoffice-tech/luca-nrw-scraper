{% extends 'crm/base.html' %}
{% load static %}

{% block title %}Edit {{ page.title }} - TELIS CRM{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
<link rel="stylesheet" href="{% static 'pages/css/builder.css' %}">
<style>
    body { margin: 0; overflow: hidden; }
    .builder-wrapper { display: flex; flex-direction: column; height: 100vh; }
    .builder-toolbar { 
        background: #1a1a2e; 
        padding: 12px 20px; 
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        border-bottom: 2px solid #16213e;
        flex-shrink: 0;
    }
    .toolbar-left, .toolbar-right, .toolbar-center { display: flex; gap: 10px; align-items: center; }
    .toolbar-btn {
        background: #0f3460;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .toolbar-btn:hover { background: #16213e; transform: translateY(-1px); }
    .toolbar-btn.primary { background: #007bff; }
    .toolbar-btn.primary:hover { background: #0056b3; }
    .toolbar-btn.success { background: #28a745; }
    .toolbar-btn.success:hover { background: #218838; }
    .device-btn {
        background: transparent;
        border: 2px solid #0f3460;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 20px;
        transition: all 0.2s;
    }
    .device-btn.active, .device-btn:hover {
        background: #0f3460;
        border-color: #007bff;
    }
    .builder-content {
        display: flex;
        flex: 1;
        overflow: hidden;
    }
    .left-panel {
        width: 280px;
        background: #16213e;
        overflow-y: auto;
        border-right: 2px solid #0f3460;
        flex-shrink: 0;
    }
    .right-panel {
        width: 300px;
        background: #16213e;
        overflow-y: auto;
        border-left: 2px solid #0f3460;
        flex-shrink: 0;
    }
    .center-canvas {
        flex: 1;
        background: #1a1a2e;
        overflow: hidden;
        position: relative;
    }
    .panel-section {
        border-bottom: 1px solid #0f3460;
    }
    .panel-header {
        background: #0f3460;
        color: white;
        padding: 12px 15px;
        font-weight: 600;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .panel-content {
        padding: 15px;
    }
    .gjs-block {
        background: #0f3460;
        border: 1px solid #16213e;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
        color: white;
        text-align: center;
    }
    .gjs-block:hover {
        background: #16213e;
        border-color: #007bff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,123,255,0.3);
    }
    #gjs {
        height: 100%;
        width: 100%;
    }
    .page-info {
        color: #adb5bd;
        font-size: 13px;
    }
    .asset-upload-zone {
        border: 2px dashed #0f3460;
        padding: 30px;
        text-align: center;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        background: rgba(15, 52, 96, 0.2);
    }
    .asset-upload-zone:hover {
        border-color: #007bff;
        background: rgba(0, 123, 255, 0.1);
    }
    .asset-upload-zone p {
        color: #adb5bd;
        margin: 10px 0 0 0;
        font-size: 14px;
    }
    /* GrapesJS Customization */
    .gjs-cv-canvas { background-color: #fff; }
    .gjs-block-category { background: #0f3460; }
    .gjs-title { color: white; }
</style>
{% endblock %}

{% block content %}
<div class="builder-wrapper">
    <!-- Top Toolbar -->
    <div class="builder-toolbar">
        <div class="toolbar-left">
            <button class="toolbar-btn" onclick="saveContent()" title="Save (Ctrl+S)">
                üíæ Save
            </button>
            <button class="toolbar-btn" onclick="editor.runCommand('core:undo')" title="Undo (Ctrl+Z)">
                ‚ü≤ Undo
            </button>
            <button class="toolbar-btn" onclick="editor.runCommand('core:redo')" title="Redo (Ctrl+Y)">
                ‚ü≥ Redo
            </button>
        </div>
        
        <div class="toolbar-center">
            <span class="page-info">{{ page.title }}</span>
            <span class="page-info" style="color: #6c757d; margin-left: 10px;">/p/{{ page.slug }}/</span>
            <button class="device-btn active" id="btn-desktop" onclick="setDevice('Desktop', this)" title="Desktop">
                üñ•Ô∏è
            </button>
            <button class="device-btn" id="btn-tablet" onclick="setDevice('Tablet', this)" title="Tablet">
                üíª
            </button>
            <button class="device-btn" id="btn-mobile" onclick="setDevice('Mobile', this)" title="Mobile">
                üì±
            </button>
        </div>
        
        <div class="toolbar-right">
            <button class="toolbar-btn" onclick="editor.runCommand('preview')" title="Preview">
                üëÅÔ∏è Preview
            </button>
            <button class="toolbar-btn success" onclick="publishPage()" title="Publish">
                üöÄ Publish
            </button>
            <a href="{% url 'pages:builder-list' %}" class="toolbar-btn">
                ‚Üê Back
            </a>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="builder-content">
        <!-- Left Panel: Blocks & Assets -->
        <div class="left-panel">
            <!-- Blocks Section -->
            <div class="panel-section">
                <div class="panel-header" onclick="togglePanel('blocks-panel')">
                    üì¶ BLOCKS
                    <span id="blocks-toggle">‚ñº</span>
                </div>
                <div id="blocks-panel" class="panel-content">
                    <div id="blocks-container"></div>
                </div>
            </div>
            
            <!-- Asset Manager Section -->
            <div class="panel-section">
                <div class="panel-header" onclick="togglePanel('assets-panel')">
                    üñºÔ∏è ASSETS
                    <span id="assets-toggle">‚ñº</span>
                </div>
                <div id="assets-panel" class="panel-content">
                    <div class="asset-upload-zone" onclick="document.getElementById('asset-upload-input').click()">
                        <div style="font-size: 40px; margin-bottom: 10px;">üì§</div>
                        <p>Click or drag to upload</p>
                        <input type="file" id="asset-upload-input" style="display: none;" accept="image/*" multiple onchange="uploadAssets(this.files)">
                    </div>
                    <div id="assets-container" style="margin-top: 15px;"></div>
                </div>
            </div>
        </div>

        <!-- Center: Canvas -->
        <div class="center-canvas">
            <div id="gjs"></div>
        </div>

        <!-- Right Panel: Styles & Layers -->
        <div class="right-panel">
            <!-- Style Manager Section -->
            <div class="panel-section">
                <div class="panel-header" onclick="togglePanel('styles-panel')">
                    üé® STYLES
                    <span id="styles-toggle">‚ñº</span>
                </div>
                <div id="styles-panel" class="panel-content">
                    <div id="styles-container"></div>
                </div>
            </div>
            
            <!-- Layer Manager Section -->
            <div class="panel-section">
                <div class="panel-header" onclick="togglePanel('layers-panel')">
                    üìã LAYERS
                    <span id="layers-toggle">‚ñº</span>
                </div>
                <div id="layers-panel" class="panel-content">
                    <div id="layers-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/grapesjs"></script>
<script type="module">
    // Import custom blocks
    import loadAllBlocks from '{% static "pages/js/blocks/index.js" %}';
    
    // Initialize GrapesJS Editor
    window.editor = grapesjs.init({
        container: '#gjs',
        height: '100%',
        width: 'auto',
        storageManager: false,
        canvas: {
            styles: [
                'https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Open+Sans:wght@400;600;700&display=swap',
                '{% url "pages:brand_css" %}', // Brand CSS variables
            ]
        },
        blockManager: {
            appendTo: '#blocks-container',
        },
        styleManager: {
            appendTo: '#styles-container',
            sectors: [
                {
                    name: 'Colors',
                    open: false,
                    properties: [
                        'color',
                        'background-color',
                        'border-color',
                    ]
                },
                {
                    name: 'Layout',
                    open: false,
                    properties: [
                        'width',
                        'height',
                        'max-width',
                        'min-height',
                        'margin',
                        'padding',
                        'display',
                        'flex-direction',
                        'justify-content',
                        'align-items',
                        'gap',
                    ]
                },
                {
                    name: 'Typography',
                    open: false,
                    properties: [
                        'font-family',
                        'font-size',
                        'font-weight',
                        'line-height',
                        'text-align',
                        'letter-spacing',
                    ]
                },
                {
                    name: 'Decorations',
                    open: false,
                    properties: [
                        'border-radius',
                        'border',
                        'box-shadow',
                        'opacity',
                        'overflow',
                    ]
                },
            ]
        },
        layerManager: {
            appendTo: '#layers-container'
        },
        assetManager: {
            upload: '{% url "pages:upload_asset" %}',
            uploadName: 'file',
            assets: [],
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        },
        deviceManager: {
            devices: [
                { name: 'Desktop', width: '' },
                { name: 'Tablet', width: '768px', widthMedia: '992px' },
                { name: 'Mobile', width: '375px', widthMedia: '480px' },
            ]
        },
    });

    // Load custom blocks
    loadAllBlocks(window.editor);

    // Load existing page content
    fetch('{% url "pages:builder-load" page.slug %}')
        .then(response => response.json())
        .then(data => {
            if (data.html_json && Object.keys(data.html_json).length > 0) {
                window.editor.setComponents(data.html_json);
                window.editor.setStyle(data.css);
            }
        })
        .catch(error => console.error('Error loading page:', error));

    // Load assets
    loadAssets();

    // Auto-save every 60 seconds
    setInterval(() => {
        saveContent(false);
    }, 60000);

    // Save on Ctrl+S
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            saveContent(true);
        }
    });
</script>

<script>
    function togglePanel(panelId) {
        const panel = document.getElementById(panelId);
        const toggle = document.getElementById(panelId.replace('-panel', '-toggle'));
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            toggle.textContent = '‚ñº';
        } else {
            panel.style.display = 'none';
            toggle.textContent = '‚ñ∫';
        }
    }

    function setDevice(deviceName, btn) {
        // Update active state
        document.querySelectorAll('.device-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        // Set device in editor
        window.editor.setDevice(deviceName);
    }

    function saveContent(showNotification = true) {
        const html = window.editor.getHtml();
        const css = window.editor.getCss();
        const components = window.editor.getComponents();

        const data = {
            html: html,
            css: css,
            html_json: components,
            note: 'Builder save'
        };

        fetch('{% url "pages:builder-save" page.slug %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && showNotification) {
                showToast('Page saved successfully!', 'success');
            }
        })
        .catch(error => {
            console.error('Error saving:', error);
            if (showNotification) {
                showToast('Error saving page', 'error');
            }
        });
    }

    function publishPage() {
        if (confirm('Publish this page? It will be visible to the public.')) {
            saveContent(false);
            // TODO: Add publish endpoint
            showToast('Publish feature coming soon', 'info');
        }
    }

    function uploadAssets(files) {
        if (!files || files.length === 0) return;

        Array.from(files).forEach(file => {
            const formData = new FormData();
            formData.append('file', file);

            fetch('{% url "pages:upload_asset" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadAssets();
                    showToast('Asset uploaded: ' + data.asset.filename, 'success');
                } else {
                    showToast(data.error || 'Error uploading asset', 'error');
                }
            })
            .catch(error => {
                console.error('Error uploading asset:', error);
                showToast('Error uploading asset', 'error');
            });
        });
    }

    function loadAssets() {
        fetch('{% url "pages:list_assets" %}')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('assets-container');
                container.innerHTML = '';
                
                if (data.data && data.data.length > 0) {
                    data.data.forEach(asset => {
                        const assetEl = document.createElement('div');
                        assetEl.style.cssText = 'margin-bottom: 10px; cursor: pointer; border: 1px solid #0f3460; border-radius: 4px; overflow: hidden;';
                        assetEl.innerHTML = `
                            <img src="${asset.src}" alt="${asset.name}" style="width: 100%; height: auto; display: block;">
                            <div style="padding: 8px; background: #0f3460; color: white; font-size: 12px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">
                                ${asset.name}
                            </div>
                        `;
                        assetEl.onclick = () => {
                            // Copy URL to clipboard
                            navigator.clipboard.writeText(asset.src);
                            showToast('Asset URL copied to clipboard!', 'success');
                        };
                        container.appendChild(assetEl);
                    });
                } else {
                    container.innerHTML = '<p style="color: #6c757d; font-size: 13px; text-align: center;">No assets uploaded yet</p>';
                }
            })
            .catch(error => console.error('Error loading assets:', error));
    }
    
    // Toast notification system
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = 'notification ' + type;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }
</script>
{% endblock %}
