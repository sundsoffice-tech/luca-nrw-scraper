{% extends 'crm/base.html' %}

{% block title %}{{ project.name }} - Navigation - TELIS CRM{% endblock %}

{% block breadcrumbs %}
    <span class="text-gray-500 mx-2">/</span>
    <a href="{% url 'pages:project-list' %}" class="text-gray-400 hover:text-white">Projects</a>
    <span class="text-gray-500 mx-2">/</span>
    <a href="{% url 'pages:project-detail' slug=project.slug %}" class="text-gray-400 hover:text-white">{{ project.name }}</a>
    <span class="text-gray-500 mx-2">/</span>
    <span class="text-gray-300">Navigation</span>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-6 flex justify-between items-start">
        <div>
            <h1 class="text-3xl font-bold text-white mb-2">Navigation Editor</h1>
            <p class="text-gray-400">{{ project.name }}</p>
        </div>
        
        <div class="flex space-x-2">
            <a href="{% url 'pages:project-detail' slug=project.slug %}" 
               class="px-4 py-2 bg-dark-700 text-white rounded-lg hover:bg-dark-600 transition">
                ‚Üê Zur√ºck
            </a>
            <button onclick="saveNavigation()" 
                    class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition">
                üíæ Speichern
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Navigation Tree (Left/Main) -->
        <div class="lg:col-span-2">
            <div class="bg-dark-800 rounded-lg border border-dark-700 p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Navigation Structure</h2>
                    <button onclick="addExternalLink()" 
                            class="px-3 py-1 text-sm bg-dark-700 text-white rounded hover:bg-dark-600 transition">
                        + External Link
                    </button>
                </div>
                
                <div id="navigationTree" class="space-y-2 min-h-[400px]">
                    {% if not nav_items %}
                    <p class="text-gray-500 text-center py-8">
                        Noch keine Navigation-Items. Ziehen Sie Seiten hierher oder f√ºgen Sie externe Links hinzu.
                    </p>
                    {% else %}
                    {% for item in nav_items %}
                        {% if not item.parent %}
                        <div class="nav-item" data-id="{{ item.id }}">
                            <div class="bg-dark-700 rounded p-3 cursor-move hover:bg-dark-600 transition">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-gray-400">‚ò∞</span>
                                        {% if item.icon %}
                                        <i class="{{ item.icon }} text-primary"></i>
                                        {% endif %}
                                        <span class="text-white">{{ item.title }}</span>
                                        {% if item.external_url %}
                                        <span class="text-xs text-gray-500">(extern)</span>
                                        {% elif item.page %}
                                        <span class="text-xs text-gray-500">({{ item.page.slug }})</span>
                                        {% endif %}
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        {% if not item.is_visible %}
                                        <span class="text-xs text-gray-500">üîí Hidden</span>
                                        {% endif %}
                                        <button onclick="editNavItem({{ item.id }})" class="text-gray-400 hover:text-white">
                                            ‚úèÔ∏è
                                        </button>
                                        <button onclick="deleteNavItem({{ item.id }})" class="text-gray-400 hover:text-red-500">
                                            üóë
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            {% if item.children.all %}
                            <div class="ml-6 mt-2 space-y-2">
                                {% for child in item.children.all %}
                                <div class="nav-item" data-id="{{ child.id }}" data-parent="{{ item.id }}">
                                    <div class="bg-dark-700 rounded p-3 cursor-move hover:bg-dark-600 transition">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <span class="text-gray-400">‚Ü≥</span>
                                                {% if child.icon %}
                                                <i class="{{ child.icon }} text-primary"></i>
                                                {% endif %}
                                                <span class="text-white">{{ child.title }}</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <button onclick="editNavItem({{ child.id }})" class="text-gray-400 hover:text-white">
                                                    ‚úèÔ∏è
                                                </button>
                                                <button onclick="deleteNavItem({{ child.id }})" class="text-gray-400 hover:text-red-500">
                                                    üóë
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Available Pages (Right) -->
        <div class="lg:col-span-1">
            <div class="bg-dark-800 rounded-lg border border-dark-700 p-6">
                <h2 class="text-xl font-semibold text-white mb-4">Verf√ºgbare Seiten</h2>
                
                <div id="availablePages" class="space-y-2">
                    {% for page in available_pages %}
                    <div class="draggable-page bg-dark-700 rounded p-3 cursor-move hover:bg-dark-600 transition"
                         data-page-id="{{ page.id }}"
                         data-page-title="{{ page.title }}"
                         data-page-slug="{{ page.slug }}">
                        <div class="flex items-center space-x-2">
                            <span class="text-gray-400">üìÑ</span>
                            <span class="text-white">{{ page.title }}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">/p/{{ page.slug }}/</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Instructions -->
            <div class="mt-6 bg-dark-800 rounded-lg border border-dark-700 p-6">
                <h3 class="text-sm font-semibold text-white mb-2">üí° Anleitung</h3>
                <ul class="text-sm text-gray-400 space-y-2">
                    <li>‚Ä¢ Ziehen Sie Seiten in die Navigation</li>
                    <li>‚Ä¢ Sortieren Sie Items per Drag & Drop</li>
                    <li>‚Ä¢ Klicken Sie auf ‚úèÔ∏è um Details zu bearbeiten</li>
                    <li>‚Ä¢ F√ºgen Sie externe Links hinzu</li>
                    <li>‚Ä¢ Speichern nicht vergessen!</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-dark-800 rounded-lg border border-dark-700 p-6 max-w-2xl w-full mx-4">
        <h2 class="text-xl font-semibold text-white mb-4">Navigation Item bearbeiten</h2>
        
        <form id="editForm" class="space-y-4">
            <input type="hidden" id="edit_item_id">
            
            <div>
                <label for="edit_title" class="block text-sm font-medium text-gray-300 mb-2">Titel</label>
                <input type="text" id="edit_title" 
                       class="w-full px-4 py-2 bg-dark-700 border border-dark-600 rounded-lg text-white">
            </div>
            
            <div>
                <label for="edit_icon" class="block text-sm font-medium text-gray-300 mb-2">Icon (z.B. fa-home)</label>
                <input type="text" id="edit_icon" 
                       class="w-full px-4 py-2 bg-dark-700 border border-dark-600 rounded-lg text-white">
            </div>
            
            <div>
                <label for="edit_external_url" class="block text-sm font-medium text-gray-300 mb-2">Externe URL</label>
                <input type="url" id="edit_external_url" 
                       class="w-full px-4 py-2 bg-dark-700 border border-dark-600 rounded-lg text-white">
            </div>
            
            <div class="flex items-center space-x-4">
                <label class="flex items-center space-x-2">
                    <input type="checkbox" id="edit_is_visible" class="rounded">
                    <span class="text-sm text-gray-300">Sichtbar</span>
                </label>
                
                <label class="flex items-center space-x-2">
                    <input type="checkbox" id="edit_open_in_new_tab" class="rounded">
                    <span class="text-sm text-gray-300">In neuem Tab √∂ffnen</span>
                </label>
            </div>
            
            <div class="flex justify-end space-x-2 pt-4">
                <button type="button" onclick="closeModal()" 
                        class="px-4 py-2 bg-dark-700 text-white rounded-lg hover:bg-dark-600 transition">
                    Abbrechen
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition">
                    Speichern
                </button>
            </div>
        </form>
    </div>
</div>

<!-- SortableJS from CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
// Initialize navigation data
let navigationData = [];

// Initialize Sortable.js for navigation tree
const navTree = document.getElementById('navigationTree');
if (navTree) {
    new Sortable(navTree, {
        animation: 150,
        ghostClass: 'opacity-50',
        handle: '.cursor-move'
    });
}

// Make pages draggable
const availablePages = document.getElementById('availablePages');
if (availablePages) {
    new Sortable(availablePages, {
        group: {
            name: 'pages',
            pull: 'clone',
            put: false
        },
        animation: 150,
        sort: false
    });
}

function addExternalLink() {
    const title = prompt('Titel f√ºr externen Link:');
    if (!title) return;
    
    const url = prompt('URL:');
    if (!url) return;
    
    // Add to navigation tree
    const navTree = document.getElementById('navigationTree');
    const newItem = document.createElement('div');
    newItem.className = 'nav-item';
    newItem.innerHTML = `
        <div class="bg-dark-700 rounded p-3 cursor-move hover:bg-dark-600 transition">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <span class="text-gray-400">‚ò∞</span>
                    <span class="text-white">${title}</span>
                    <span class="text-xs text-gray-500">(extern)</span>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="deleteNavItem(this)" class="text-gray-400 hover:text-red-500">
                        üóë
                    </button>
                </div>
            </div>
        </div>
    `;
    navTree.appendChild(newItem);
}

async function editNavItem(id) {
    try {
        // Fetch item data from server
        const response = await fetch(`/pages/api/nav-items/${id}/`, {
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load navigation item');
        }
        
        const item = await response.json();
        
        // Populate modal with item data - with null checks
        const elements = {
            edit_item_id: document.getElementById('edit_item_id'),
            edit_title: document.getElementById('edit_title'),
            edit_icon: document.getElementById('edit_icon'),
            edit_external_url: document.getElementById('edit_external_url'),
            edit_is_visible: document.getElementById('edit_is_visible'),
            edit_open_in_new_tab: document.getElementById('edit_open_in_new_tab')
        };
        
        // Validate all elements exist
        for (const [key, element] of Object.entries(elements)) {
            if (!element) {
                throw new Error(`Form element ${key} not found`);
            }
        }
        
        // Populate form fields
        elements.edit_item_id.value = item.id;
        elements.edit_title.value = item.title || '';
        elements.edit_icon.value = item.icon || '';
        elements.edit_external_url.value = item.external_url || '';
        elements.edit_is_visible.checked = item.is_visible !== false;
        elements.edit_open_in_new_tab.checked = item.open_in_new_tab || false;
        
        // Show modal
        document.getElementById('editModal').classList.remove('hidden');
    } catch (error) {
        console.error('Error loading navigation item:', error);
        alert('Fehler beim Laden des Navigation Items');
    }
}

async function deleteNavItem(id) {
    if (!confirm('Navigation Item wirklich l√∂schen?')) {
        return;
    }
    
    try {
        const response = await fetch(`/pages/api/nav-items/${id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to delete navigation item');
        }
        
        // Remove from DOM
        const navItem = document.querySelector(`.nav-item[data-id="${id}"]`);
        if (navItem) {
            navItem.remove();
            alert('Navigation Item gel√∂scht!');
        } else {
            console.warn(`Navigation item with id ${id} not found in DOM`);
            // Still show success since API deletion worked
            alert('Navigation Item gel√∂scht!');
            window.location.reload();
        }
    } catch (error) {
        console.error('Error deleting navigation item:', error);
        alert('Fehler beim L√∂schen des Navigation Items');
    }
}

function closeModal() {
    document.getElementById('editModal').classList.add('hidden');
}

// Handle edit form submission
document.getElementById('editForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Gather form data with null checks
    const elements = {
        edit_item_id: document.getElementById('edit_item_id'),
        edit_title: document.getElementById('edit_title'),
        edit_icon: document.getElementById('edit_icon'),
        edit_external_url: document.getElementById('edit_external_url'),
        edit_is_visible: document.getElementById('edit_is_visible'),
        edit_open_in_new_tab: document.getElementById('edit_open_in_new_tab')
    };
    
    // Validate all elements exist
    for (const [key, element] of Object.entries(elements)) {
        if (!element) {
            console.error(`Form element ${key} not found`);
            alert('Formularfehler: Einige Felder fehlen');
            return;
        }
    }
    
    const itemId = elements.edit_item_id.value;
    const data = {
        title: elements.edit_title.value,
        icon: elements.edit_icon.value,
        external_url: elements.edit_external_url.value,
        is_visible: elements.edit_is_visible.checked,
        open_in_new_tab: elements.edit_open_in_new_tab.checked
    };
    
    try {
        const response = await fetch(`/pages/api/nav-items/${itemId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            throw new Error('Failed to update navigation item');
        }
        
        alert('Navigation Item aktualisiert!');
        closeModal();
        window.location.reload();
    } catch (error) {
        console.error('Error updating navigation item:', error);
        alert('Fehler beim Aktualisieren des Navigation Items');
    }
});

async function saveNavigation() {
    // Collect navigation data from DOM
    const navItems = [];
    document.querySelectorAll('#navigationTree > .nav-item').forEach((item, index) => {
        const data = {
            title: item.querySelector('.text-white').textContent,
            order: index,
            // Add more fields...
        };
        navItems.push(data);
    });
    
    try {
        const response = await fetch('{% url "pages:save-navigation" slug=project.slug %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                navigation: navItems
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Navigation gespeichert!');
            window.location.reload();
        } else {
            alert('Fehler: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Fehler beim Speichern der Navigation');
    }
}
</script>

{% endblock %}
