name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v2.5.0)'
        required: true
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    outputs:
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"
      
      - name: Validate VERSION file
        run: |
          VERSION_FILE=$(cat VERSION)
          EXPECTED="${{ steps.version.outputs.version }}"
          if [ "$VERSION_FILE" != "$EXPECTED" ]; then
            echo "⚠️ VERSION file ($VERSION_FILE) doesn't match release ($EXPECTED)"
            echo "Please update VERSION file before releasing"
            exit 1
          fi
          echo "✅ VERSION file matches release version"
      
      - name: Validate CHANGELOG
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! grep -q "\[$VERSION\]" CHANGELOG.md; then
            echo "⚠️ Version $VERSION not found in CHANGELOG.md"
            echo "Please add a changelog entry before releasing"
            exit 1
          fi
          echo "✅ Changelog entry found for version $VERSION"
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run tests
        run: |
          pytest tests/ -m "not slow" --verbose
        continue-on-error: false
      
      - name: Run linting
        run: |
          pip install flake8
          flake8 luca_scraper stream2_extraction_layer stream3_scoring_layer \
            --count --select=E9,F63,F7,F82 --show-source --statistics

  django-validate:
    name: Validate Django
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r telis_recruitment/requirements.txt
      
      - name: Run migrations check
        env:
          SECRET_KEY: 'test-secret-key-for-ci'
          DEBUG: 'True'
          ALLOWED_HOSTS: 'localhost,127.0.0.1'
        run: |
          cd telis_recruitment
          python manage.py migrate --no-input
          python manage.py makemigrations --check --dry-run
          echo "✅ All migrations are up to date"
      
      - name: Run Django tests
        env:
          SECRET_KEY: 'test-secret-key-for-ci'
          DEBUG: 'True'
          ALLOWED_HOSTS: 'localhost,127.0.0.1'
        run: |
          cd telis_recruitment
          python manage.py test --verbosity=2

  build:
    name: Build Release
    runs-on: ubuntu-latest
    needs: [validate, django-validate]
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Build Docker image
        run: |
          docker build -t luca-nrw-scraper:${{ needs.validate.outputs.version }} .
          docker build -t luca-nrw-scraper:latest .
      
      - name: Create release artifact
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          mkdir -p release
          
          # Create source distribution
          tar -czf release/luca-nrw-scraper-${VERSION}.tar.gz \
            --exclude='.git' \
            --exclude='*.pyc' \
            --exclude='__pycache__' \
            --exclude='.env' \
            --exclude='*.sqlite3' \
            --exclude='node_modules' \
            --exclude='htmlcov' \
            --exclude='.coverage' \
            .
          
          echo "✅ Created release artifact: luca-nrw-scraper-${VERSION}.tar.gz"
      
      - name: Upload release artifact
        uses: actions/upload-artifact@v3
        with:
          name: release-${{ needs.validate.outputs.version }}
          path: release/
          retention-days: 30

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, build]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download release artifact
        uses: actions/download-artifact@v3
        with:
          name: release-${{ needs.validate.outputs.version }}
          path: release/
      
      - name: Extract changelog section
        id: changelog
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          # Extract the changelog section for this version
          CHANGELOG=$(sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d')
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ needs.validate.outputs.version }}
          body: |
            ## LUCA NRW Scraper v${{ needs.validate.outputs.version }}
            
            ${{ steps.changelog.outputs.changelog }}
            
            ### Installation
            
            ```bash
            # Using Docker
            docker pull ghcr.io/${{ github.repository }}:${{ needs.validate.outputs.version }}
            
            # From source
            tar -xzf luca-nrw-scraper-${{ needs.validate.outputs.version }}.tar.gz
            pip install -r requirements.txt
            ```
            
            ### Upgrade Guide
            
            1. Backup your database and `.env` file
            2. Download the new version
            3. Run database migrations: `python manage.py migrate`
            4. Restart the application
            
            See [CHANGELOG.md](CHANGELOG.md) for full release notes.
          files: |
            release/luca-nrw-scraper-${{ needs.validate.outputs.version }}.tar.gz
          draft: false
          prerelease: ${{ contains(needs.validate.outputs.version, '-') }}
